<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">View Memo - TESDA DBMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script type="module" src="firebase-config.js"></script>
    <link rel="icon" type="image/png" href="./icons/memlogo.png"> 
    <style>
        @media print {
            .no-print {
                display: none !important;
            }
            .memo-container {
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
            }
        }
        
        /* Custom light blue theme */
        :root {
            --primary-blue: #3b82f6;
            --light-blue: #dbeafe;
            --lighter-blue: #eff6ff;
            --accent-blue: #1d4ed8;
        }
        
        .tracking-step {
            position: relative;
        }
        
        .tracking-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 2rem;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 3rem;
            background: #e5e7eb;
        }
        
        .tracking-step.completed:not(:last-child)::after {
            background: var(--primary-blue);
        }
        
        .tracking-circle {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            border: 2px solid #e5e7eb;
            background: white;
            position: relative;
            z-index: 10;
        }
        
        .tracking-circle.completed {
            background: var(--primary-blue);
            border-color: var(--primary-blue);
            color: white;
        }
        
        .tracking-circle.current {
            background: var(--lighter-blue);
            border-color: var(--primary-blue);
            color: var(--primary-blue);
            animation: pulse-blue 2s infinite;
        }
        
        @keyframes pulse-blue {
            0% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
                background: var(--lighter-blue);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
                background: var(--primary-blue);
                color: white;
            }
            100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
                background: var(--lighter-blue);
            }
        }

        /* Tracking map enhancements */
        .tracking-circle {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .tracking-circle:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .tracking-step {
            transition: all 0.3s ease;
        }

        .tracking-step:hover {
            transform: translateY(-2px);
        }

        .tracking-step.completed .tracking-circle {
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .tracking-step.current .tracking-circle {
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        /* Enhanced progress bar */
        #trackingProgressBar {
            background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 50%, #3b82f6 100%);
            background-size: 200% 100%;
            animation: shimmer 2s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* Status badge animations */
        .status-badge {
            transition: all 0.3s ease;
        }

        .status-badge:hover {
            transform: scale(1.05);
        }

        /* Enhanced connector lines */
        .tracking-step:not(:last-child)::after {
            transition: background 0.5s ease;
        }

        .tracking-step.completed:not(:last-child)::after {
            background: linear-gradient(to bottom, #3b82f6, #dbeafe);
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.3);
        }

        /* Pulse animation for current step */
        .tracking-circle.current {
            animation: enhanced-pulse 2s infinite;
        }

        @keyframes enhanced-pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 0 12px rgba(59, 130, 246, 0);
                transform: scale(1.05);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
                transform: scale(1);
            }
        }

        /* Success animation for completed steps */
        .tracking-step.completed .tracking-circle {
            animation: success-bounce 0.6s ease-out;
        }

        @keyframes success-bounce {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* Enhanced tracking summary */
        .tracking-summary {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border: 1px solid #bfdbfe;
        }

        /* Responsive improvements */
        @media (max-width: 640px) {
            .tracking-step {
                margin-bottom: 1.5rem;
            }
            
            .tracking-circle {
                width: 1.75rem;
                height: 1.75rem;
            }
            
            .tracking-step:not(:last-child)::after {
                height: 2.5rem;
            }
        }

        /* Highlight/blink the last status (Archived) only when it's completed */
        .tracking-step:last-child.completed .tracking-circle {
            background: var(--lighter-blue);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
            animation: blink-glow 1.2s ease-in-out infinite;
        }

        /* Check icon styling for archived step */
        #archivedCheckIcon {
            position: absolute;
            top: -2px;
            right: -2px;
            background: #10b981;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 20;
        }

        /* Emphasize the Archived label when it's the active (completed) last step */
        .tracking-step:last-child.completed .text-center p.text-xs.font-medium {
            color: var(--accent-blue) !important;
        }

        /* Subtle enhancement for the connector when a step is completed */
        .tracking-step.completed:not(:last-child)::after {
            background: linear-gradient(to bottom, var(--primary-blue), #e5e7eb);
        }

        @keyframes blink-glow {
            0% {
                box-shadow: 0 0 0 0 rgba(29, 78, 216, 0.65), 0 0 0 0 rgba(29, 78, 216, 0.25) inset;
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(29, 78, 216, 0.0), 0 0 10px 0 rgba(29, 78, 216, 0.35) inset;
                transform: scale(1.05);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(29, 78, 216, 0.0), 0 0 0 0 rgba(29, 78, 216, 0.0) inset;
                transform: scale(1);
            }
        }

        @media print {
            .tracking-step:last-child .tracking-circle {
                animation: none !important;
            }
        }

        /* Edit button styles */
        .edit-btn {
            transition: all 0.2s ease;
            position: relative;
        }

        .edit-btn:hover:not(:disabled) {
            transform: scale(1.1);
            color: #2563eb !important;
        }

        .edit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .edit-btn:disabled:hover {
            transform: none;
            color: #9ca3af !important;
        }

        /* Tooltip for disabled edit buttons */
        .edit-btn:disabled::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #374151;
            color: white;
            padding: 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .edit-btn:disabled:hover::after {
            opacity: 1;
        }

        /* Antedated badge styling */
        #antedatedBadge {
            animation: pulse-orange 2s infinite;
        }

        @keyframes pulse-orange {
            0% {
                box-shadow: 0 0 0 0 rgba(245, 101, 101, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(245, 101, 101, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(245, 101, 101, 0);
            }
        }

        /* Full memo number styling */
        #fullMemoNumber {
            font-family: monospace;
            background: #fef3c7;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            border: 1px solid #fbbf24;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-white">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-blue-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-xl">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
            <p class="text-sm text-gray-600 mt-2">Loading...</p>
        </div>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="hidden fixed top-4 right-4 p-4 bg-red-50 border border-red-200 text-red-800 rounded-lg shadow-lg z-50"></div>

    <!-- Password Modal for Memo No. Editing -->
    <div id="memoNoPasswordModal" class="hidden fixed inset-0 bg-blue-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full mx-4 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Enter Password to Edit Memo No.</h3>
            <input type="password" id="memoNoPasswordInput" class="w-full px-4 py-3 border border-blue-200 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 mb-3" placeholder="Password">
            <p id="memoNoPasswordError" class="hidden text-sm text-red-600 mb-3"></p>
            <div class="flex justify-end gap-3">
                <button id="cancelMemoNoPasswordBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Cancel</button>
                <button id="confirmMemoNoPasswordBtn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Step Details Modal -->
    <div id="stepDetailsModal" class="hidden fixed inset-0 bg-blue-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900" id="stepDetailsTitle">Step Details</h3>
                <button onclick="closeStepDetails()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <p class="text-sm text-gray-600 mb-2">Description:</p>
                    <p class="text-sm text-gray-900" id="stepDetailsDescription">—</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600 mb-2">Status:</p>
                    <div id="stepDetailsStatus">—</div>
                </div>
                <div>
                    <p class="text-sm text-gray-600 mb-2">Date:</p>
                    <p class="text-sm text-gray-900" id="stepDetailsDate">—</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600 mb-2">Duration:</p>
                    <p class="text-sm text-gray-900" id="stepDetailsDuration">—</p>
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button onclick="closeStepDetails()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Close</button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Header -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 no-print bg-white rounded-xl p-6 shadow-sm border border-blue-100">
            <div class="flex items-center mb-4 sm:mb-0">
                <div class="bg-blue-100 p-3 rounded-xl mr-4">
                    <i data-lucide="file-text" class="w-6 h-6 text-blue-600"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Memo Details</h1>
                    <p class="text-sm text-blue-600">View complete memo information</p>
                </div>
            </div>
            <div class="flex gap-3">
                <button id="downloadPdfBtn" onclick="downloadPDF()" class="inline-flex items-center px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-gray-400 cursor-not-allowed opacity-50 transition-all" disabled>
                    <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                    View PDF
                </button>
                <button onclick="window.print()" class="inline-flex items-center px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition-colors">
                    <i data-lucide="printer" class="w-4 h-4 mr-2"></i>
                    Print
                </button>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Left Sidebar - Tracking Map & Info -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Tracking Map -->
                <div class="bg-white rounded-xl p-6 shadow-sm border border-blue-100">
                    <h3 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
                        <i data-lucide="map-pin" class="w-5 h-5 text-blue-600 mr-2"></i>
                        Memo Tracking
                        <span class="ml-2 text-sm text-gray-500 font-normal">(Click steps for details)</span>
                    </h3>
                    
                    <!-- Progress Bar -->
                    <div class="mb-6">
                        <div class="flex justify-between text-xs text-gray-500 mb-2">
                            <span>Progress</span>
                            <span id="trackingProgress">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="trackingProgressBar" class="bg-gradient-to-r from-blue-500 to-blue-600 h-2 rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="space-y-8">
                        <!-- Step 1: Created -->
                        <div class="tracking-step completed cursor-pointer" id="trackingCreatedStep" 
                             onclick="showStepDetails('Created', 'Memo was created and saved to the system')"
                             onkeydown="handleStepKeydown(event, 'Created', 'Memo was created and saved to the system')"
                             tabindex="0" role="button" aria-label="Created step - Click for details">
                            <div class="tracking-circle completed">
                                <i data-lucide="file-plus" class="w-4 h-4"></i>
                            </div>
                            <div class="text-center mt-2">
                                <p class="text-xs font-medium text-blue-600">Created</p>
                                <p class="text-xs text-gray-500" id="trackingCreated">—</p>
                                <div class="mt-1">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        <i data-lucide="check" class="w-3 h-3 mr-1"></i>
                                        Completed
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 2: Released -->
                        <div class="tracking-step cursor-pointer" id="trackingReleased" 
                             onclick="showStepDetails('Released', 'Memo has been released to ROD/FASD for processing')"
                             onkeydown="handleStepKeydown(event, 'Released', 'Memo has been released to ROD/FASD for processing')"
                             tabindex="0" role="button" aria-label="Released step - Click for details">
                            <div class="tracking-circle">
                                <i data-lucide="send" class="w-4 h-4"></i>
                            </div>
                            <div class="text-center mt-2">
                                <p class="text-xs font-medium text-gray-600">Released</p>
                                <p class="text-xs text-gray-500" id="trackingReleasedDate">—</p>
                                <div class="mt-1" id="trackingReleasedStatus">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                                        <i data-lucide="clock" class="w-3 h-3 mr-1"></i>
                                        Pending
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 3: Received -->
                        <div class="tracking-step cursor-pointer" id="trackingReceived" 
                             onclick="showStepDetails('Received', 'Memo has been received and acknowledged by ROD/FASD')"
                             onkeydown="handleStepKeydown(event, 'Received', 'Memo has been received and acknowledged by ROD/FASD')"
                             tabindex="0" role="button" aria-label="Received step - Click for details">
                            <div class="tracking-circle">
                                <i data-lucide="check-circle" class="w-4 h-4"></i>
                            </div>
                            <div class="text-center mt-2">
                                <p class="text-xs font-medium text-gray-600">Received</p>
                                <p class="text-xs text-gray-500" id="trackingReceivedDate">—</p>
                                <div class="mt-1" id="trackingReceivedStatus">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                                        <i data-lucide="clock" class="w-3 h-3 mr-1"></i>
                                        Pending
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 4: Archived -->
                        <div class="tracking-step cursor-pointer" id="trackingArchived" 
                             onclick="showStepDetails('Archived', 'Memo has been processed and archived for record keeping')"
                             onkeydown="handleStepKeydown(event, 'Archived', 'Memo has been processed and archived for record keeping')"
                             tabindex="0" role="button" aria-label="Archived step - Click for details">
                            <div class="tracking-circle">
                                <i data-lucide="archive" class="w-4 h-4" id="archivedIcon"></i>
                                <i data-lucide="check" class="w-3 h-3 absolute -top-1 -right-1 text-white bg-green-500 rounded-full p-0.5 hidden" id="archivedCheckIcon"></i>
                            </div>
                            <div class="text-center mt-2">
                                <p class="text-xs font-medium text-gray-600">Archived</p>
                                <p class="text-xs text-gray-500" id="trackingArchivedDate">—</p>
                                <div class="mt-1" id="trackingArchivedStatus">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                                        <i data-lucide="clock" class="w-3 h-3 mr-1"></i>
                                        Pending
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tracking Summary -->
                    <div class="mt-8 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <h4 class="text-sm font-medium text-blue-900 mb-2">Tracking Summary</h4>
                        <div class="grid grid-cols-2 gap-4 text-xs">
                            <div>
                                <span class="text-gray-600">Current Status:</span>
                                <span id="trackingCurrentStatus" class="ml-2 font-medium text-blue-900">—</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Time in Current Status:</span>
                                <span id="trackingTimeInStatus" class="ml-2 font-medium text-blue-900">—</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Info Cards -->
                <div class="space-y-4">
                    <!-- Signatory -->
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-blue-100 hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <p class="text-xs text-blue-600 font-medium uppercase tracking-wide">Signatory</p>
                                <span id="signatory" class="text-sm text-gray-900 font-medium block mt-1"></span>
                            </div>
                            <button id="edit-signatory" class="edit-btn text-gray-400 hover:text-blue-600 cursor-pointer transition-colors" data-original-title="Edit Signatory" title="Edit Signatory">
                                <i data-lucide="pen" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Author/Focal -->
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-blue-100 hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <p class="text-xs text-blue-600 font-medium uppercase tracking-wide">Author/Focal</p>
                                <span id="authorFocal" class="text-sm text-gray-900 font-medium block mt-1"></span>
                            </div>
                            <button id="edit-authorFocal" class="edit-btn text-gray-400 hover:text-blue-600 cursor-pointer transition-colors" data-original-title="Edit Author/Focal" title="Edit Author/Focal">
                                <i data-lucide="pen" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>



                    <!-- PDF Attachment -->
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-blue-100">
                        <p class="text-xs text-blue-600 font-medium uppercase tracking-wide">PDF Attachment</p>
                        <div id="pdfStatus" class="flex items-center mt-2">
                            <span id="pdfStatusText" class="text-sm text-gray-500">Checking...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Memo Content -->
            <div class="lg:col-span-3">
                <!-- TESDA Header - Reduced Width -->
                <div class="mb-6 bg-white rounded-xl p-4 shadow-sm border border-blue-100 max-w-4xl">
                    <div class="flex items-center justify-between">
                        <!-- Left Logo -->
                        <div class="w-1/5 flex justify-center">
                            <img src="icons/tlogo.png" alt="TESDA Logo" class="h-16">
                        </div>
                        
                        <!-- Center Text -->
                        <div class="text-center flex-1 px-4">
                            <h1 class="text-xl font-bold text-gray-900">Technical Education and Skills Development Authority</h1>
                            <p class="text-base text-blue-600 font-medium">Region VII - Central Visayas</p>
                        </div>
                        
                        <!-- Right Logo -->
                        <div class="w-1/5 flex justify-center">
                            <img src="icons/TUV.png" alt="TESDA Logo" class="h-16">
                        </div>
                    </div>
                </div>

                <div class="memo-container bg-white shadow-sm rounded-xl border border-blue-100 overflow-hidden p-8 min-h-[5in]">
                <div class="memo-container bg-white shadow-sm rounded-xl border border-blue-100 overflow-hidden p-8 min-h-[5in]">
                    <!-- Memo Number and Date -->
                    <div class="mb-8 pb-6 border-b border-blue-100">
                        <div class="flex justify-between items-start">
                            <div class="flex items-start">
                                <div>
                                    <p class="text-sm text-blue-600 font-medium flex items-center mb-2">
                                        Memo No.:
                                        <span id="adminBadge" class="hidden ml-2 px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">Admin Only</span>
                                        <span id="antedatedBadge" class="hidden ml-2 px-2 py-1 text-xs bg-orange-100 text-orange-800 rounded-full">Antedated</span>
                                        <button id="edit-memoNumber" class="edit-btn ml-2 text-gray-400 hover:text-blue-600 cursor-pointer transition-colors" data-original-title="Edit Memo Number" title="Edit Memo Number">
                                            <i data-lucide="pen" class="w-4 h-4"></i>
                                        </button>
                                    </p>
                                    <span id="memoNumberWrapper">
                                      <p id="memoNumber" class="text-xl font-mono font-bold text-blue-700"></p>
                                      <p id="fullMemoNumber" class="text-xs text-gray-500 mt-1 hidden"></p>
                                     
                                    </span>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-blue-600 font-medium mb-2">Date:</p>
                                <p id="createdAt" class="text-lg text-gray-900 font-semibold"></p>
                            </div>
                        </div>
                    </div>

                    <!-- From -->
                    <div class="mb-6 flex items-start bg-blue-50 rounded-lg p-4">
                        <div class="flex-1">
                            <p class="text-sm text-blue-600 font-medium mb-2">From:</p>
                            <span id="department" class="text-lg text-gray-900 font-medium inline-block"></span>
                        </div>
                        <button id="edit-department" class="edit-btn ml-2 text-gray-400 hover:text-blue-600 cursor-pointer transition-colors" data-original-title="Edit From" title="Edit From">
                            <i data-lucide="pen" class="w-4 h-4"></i>
                        </button>
                    </div>

                    <!-- To -->
                    <div class="mb-6 flex items-start bg-blue-50 rounded-lg p-4">
                        <div class="flex-1">
                            <p class="text-sm text-blue-600 font-medium mb-2">To:</p>
                            <span id="recipients" class="text-lg text-gray-900 font-medium inline-block"></span>
                        </div>
                        <button id="edit-recipients" class="edit-btn ml-2 text-gray-400 hover:text-blue-600 cursor-pointer transition-colors" data-original-title="Edit To" title="Edit To">
                            <i data-lucide="pen" class="w-4 h-4"></i>
                        </button>
                    </div>

                    <!-- Subject -->
                    <div class="mb-8 flex items-start bg-blue-50 rounded-lg p-4">
                        <div class="flex-1">
                            <p class="text-sm text-blue-600 font-medium mb-2">Subject:</p>
                            <span id="title" class="text-lg font-semibold text-gray-900 inline-block leading-relaxed"></span>
                        </div>
                        <button id="edit-title" class="edit-btn ml-2 text-gray-400 hover:text-blue-600 cursor-pointer transition-colors" data-original-title="Edit Subject" title="Edit Subject">
                            <i data-lucide="pen" class="w-4 h-4"></i>
                        </button>
                    </div>

                    <!-- Description -->
                    <div class="mb-8 flex items-start">
                        <div class="flex-1">
                            <p class="text-sm text-blue-600 font-medium mb-4">Description:</p>
                            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                <span id="description" class="text-base text-gray-900 whitespace-pre-wrap inline-block leading-relaxed"></span>
                            </div>
                        </div>
                        <button id="edit-description" class="edit-btn ml-2 text-gray-400 hover:text-blue-600 cursor-pointer transition-colors" data-original-title="Edit Description" title="Edit Description">
                            <i data-lucide="pen" class="w-4 h-4"></i>
                        </button>
                    </div>

                    <!-- Footer with Logo -->
                    <div class="mt-12 flex justify-end border-t border-blue-100 pt-6">
                        <img src="icons/kayangkaya.png" alt="TESDA Logo" class="h-12 opacity-80">
                    </div>
                </div>

                <!-- Activity Log Section -->
                <div class="mt-6 bg-white rounded-xl shadow-sm border border-blue-100 overflow-hidden">
                    <div class="px-6 py-4 bg-blue-50 border-b border-blue-100">
                        <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                            <i data-lucide="activity" class="w-5 h-5 text-blue-600 mr-2"></i>
                            Activity Log
                        </h2>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-blue-100">
                            <thead class="bg-blue-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-blue-700 uppercase tracking-wider">Created At</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-blue-700 uppercase tracking-wider">Released To</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-blue-700 uppercase tracking-wider">Received By</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-blue-700 uppercase tracking-wider">Timestamp</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-blue-700 uppercase tracking-wider">Action</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-blue-700 uppercase tracking-wider">User</th>
                                </tr>
                            </thead>
                            <tbody id="activityLogBody" class="bg-white divide-y divide-blue-50">
                                <!-- Activity logs will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, auth } from './firebase-config.js';
        import { doc, getDoc, updateDoc, collection, query, where, orderBy, getDocs, addDoc, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Initialize Lucide icons
        lucide.createIcons();

        // Get DOM elements
        const loadingOverlay = document.getElementById('loadingOverlay');
        const errorMessage = document.getElementById('errorMessage');
        const activityLogBody = document.getElementById('activityLogBody');

        // Set up edit button event listeners
        function setupEditButtons() {
            // Memo Number edit
            document.getElementById('edit-memoNumber').addEventListener('click', function() {
                if (this.disabled) return;
                editField('memoNumber', 'Memo Number', 'text');
            });

            // Department edit
            document.getElementById('edit-department').addEventListener('click', function() {
                if (this.disabled) return;
                editField('department', 'Department', 'text');
            });

            // Recipients edit
            document.getElementById('edit-recipients').addEventListener('click', function() {
                if (this.disabled) return;
                editField('recipients', 'Recipients', 'text');
            });

            // Title edit
            document.getElementById('edit-title').addEventListener('click', function() {
                if (this.disabled) return;
                editField('title', 'Subject', 'text');
            });

            // Description edit
            document.getElementById('edit-description').addEventListener('click', function() {
                if (this.disabled) return;
                editField('description', 'Description', 'textarea');
            });

            // Signatory edit
            document.getElementById('edit-signatory').addEventListener('click', function() {
                if (this.disabled) return;
                editField('signatory', 'Signatory', 'text');
            });

            // Author/Focal edit
            document.getElementById('edit-authorFocal').addEventListener('click', function() {
                if (this.disabled) return;
                editField('authorFocal', 'Author/Focal', 'text');
            });

            // Add hover tooltips showing current values
            addEditButtonTooltips();
        }

        // Function to add tooltips to edit buttons
        function addEditButtonTooltips() {
            const editButtons = document.querySelectorAll('.edit-btn');
            editButtons.forEach(btn => {
                const fieldId = btn.id.replace('edit-', '');
                const fieldElement = document.getElementById(fieldId);
                if (fieldElement) {
                    const currentValue = fieldElement.textContent;
                    if (currentValue && currentValue.trim() !== '') {
                        btn.title = `${btn.getAttribute('data-original-title')} - Current: ${currentValue.substring(0, 50)}${currentValue.length > 50 ? '...' : ''}`;
                    }
                }
            });
        }

        // Function to detect if memo number is antedated and extract display value
        function processMemoNumber(memoNumber) {
            if (!memoNumber) return { displayValue: '', isAntedated: false, fullValue: '' };
            
            // Split memo number by hyphens
            const parts = memoNumber.split('-');
            
            // Check if it's a valid memo number format (should have at least 2 parts)
            if (parts.length < 2) {
                return { displayValue: memoNumber, isAntedated: false, fullValue: memoNumber };
            }
            
            // Always show only the last two parts
            const lastTwoParts = parts.slice(-2).join('-');
            return {
                displayValue: lastTwoParts,
                isAntedated: false,
                fullValue: memoNumber
            };
        }

        // Function to validate memo number format
        function validateMemoNumber(memoNumber) {
            if (!memoNumber) return { isValid: false, message: 'Memo number cannot be empty' };
            
            // Check if it contains hyphens (required for proper format)
            if (!memoNumber.includes('-')) {
                return { isValid: false, message: 'Memo number should contain hyphens (e.g., 2024-001)' };
            }
            
            // Split by hyphens
            const parts = memoNumber.split('-');
            
            // Check if it has at least 2 parts
            if (parts.length < 2) {
                return { isValid: false, message: 'Memo number should have at least year and series (e.g., 2024-001)' };
            }
            
            // Check if first part is a valid year
            const year = parseInt(parts[0]);
            if (isNaN(year) || year < 1900 || year > 2100) {
                return { isValid: false, message: 'First part should be a valid year between 1900-2100' };
            }
            
            // Check if second part is a valid series number
            const series = parseInt(parts[1]);
            if (isNaN(series) || series < 1) {
                return { isValid: false, message: 'Second part should be a valid series number' };
            }
            
            return { isValid: true, message: 'Valid memo number format' };
        }

        // Function to update antedated display elements
        function updateAntedatedDisplay(processed) {
            // Since we're always showing full memo numbers, hide these elements
            const antedatedBadge = document.getElementById('antedatedBadge');
            if (antedatedBadge) {
                antedatedBadge.classList.add('hidden');
            }
            
            const fullMemoNumber = document.getElementById('fullMemoNumber');
            if (fullMemoNumber) {
                fullMemoNumber.classList.add('hidden');
            }
        }

        // Function to edit a field
        function editField(fieldId, fieldName, inputType) {
            const fieldElement = document.getElementById(fieldId);
            let currentValue = fieldElement.textContent;
            
            // Special handling for memo number - check admin privileges
            if (fieldId === 'memoNumber' && !isAdmin) {
                alert('Only administrators can edit memo numbers');
                return;
            }
            
            // Special confirmation for memo number
            if (fieldId === 'memoNumber' && isAdmin) {
                const confirmed = confirm('Warning: Changing the memo number may affect tracking and references. Are you sure you want to proceed?');
                if (!confirmed) return;
            }
            
            // Special confirmation for title/subject
            if (fieldId === 'title') {
                const confirmed = confirm('Are you sure you want to edit the subject of this memo?');
                if (!confirmed) return;
            }
            
            // Create input element
            let inputElement;
            if (inputType === 'textarea') {
                inputElement = document.createElement('textarea');
                inputElement.rows = 4;
                inputElement.className = 'w-full px-3 py-2 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500';
                
                // Add character counter for description
                const charCounter = document.createElement('div');
                charCounter.className = 'text-xs text-gray-500 mt-1 text-right';
                charCounter.textContent = `${currentValue.length}/2000 characters`;
                
                // Update counter on input
                inputElement.addEventListener('input', () => {
                    charCounter.textContent = `${inputElement.value.length}/2000 characters`;
                    if (inputElement.value.length > 1800) {
                        charCounter.className = 'text-xs text-orange-500 mt-1 text-right';
                    } else if (inputElement.value.length > 2000) {
                        charCounter.className = 'text-xs text-red-500 mt-1 text-right';
                    } else {
                        charCounter.className = 'text-xs text-gray-500 mt-1 text-right';
                    }
                });
            } else {
                inputElement = document.createElement('input');
                inputElement.type = 'text';
                inputElement.className = 'w-full px-3 py-2 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500';
            }
            
            // For memo number, show the full value in input, not the processed display value
            if (fieldId === 'memoNumber' && memoGlobal && memoGlobal.memoNumber) {
                inputElement.value = memoGlobal.memoNumber;
            } else {
                inputElement.value = currentValue;
            }
            
            // Create save and cancel buttons
            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'Save';
            saveBtn.className = 'px-3 py-1 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors mr-2';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.className = 'px-3 py-1 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors';
            
            // Create button container
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'mt-2 flex gap-2';
            buttonContainer.appendChild(saveBtn);
            buttonContainer.appendChild(cancelBtn);
            
            // Replace field content with input
            fieldElement.innerHTML = '';
            fieldElement.appendChild(inputElement);
            
            // Add character counter for textarea fields
            if (inputType === 'textarea') {
                const charCounter = document.createElement('div');
                charCounter.className = 'text-xs text-gray-500 mt-1 text-right';
                charCounter.textContent = `${currentValue.length}/2000 characters`;
                fieldElement.appendChild(charCounter);
            }
            
            fieldElement.appendChild(buttonContainer);
            
            // Focus on input
            inputElement.focus();
            inputElement.select();
            
            // Save button click handler
            saveBtn.addEventListener('click', async () => {
                const newValue = inputElement.value.trim();
                if (newValue === '') {
                    alert(`${fieldName} cannot be empty`);
                    return;
                }
                
                // Additional validation for description
                if (fieldId === 'description' && newValue.length > 2000) {
                    alert('Description is too long. Please keep it under 2000 characters.');
                    return;
                }
                
                // Additional validation for memo number
                if (fieldId === 'memoNumber') {
                    const validation = validateMemoNumber(newValue);
                    if (!validation.isValid) {
                        alert(`Invalid memo number: ${validation.message}`);
                        return;
                    }
                }
                
                // Show loading state
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';
                saveBtn.className = 'px-3 py-1 text-sm font-medium text-white bg-gray-400 rounded-lg cursor-not-allowed mr-2';
                
                try {
                    // Update in Firestore
                    const memoRef = doc(db, 'memos', memoIdGlobal);
                    const updateData = {};
                    
                    // Special handling for different field types
                    if (fieldId === 'recipients') {
                        // Handle recipients as array
                        updateData[fieldId] = newValue.split(',').map(r => r.trim()).filter(r => r);
                    } else {
                        updateData[fieldId] = newValue;
                    }
                    
                    await updateDoc(memoRef, updateData);
                    
                    // Update UI - handle recipients specially
                    if (fieldId === 'recipients') {
                        const recipientsArray = newValue.split(',').map(r => r.trim()).filter(r => r);
                        fieldElement.textContent = recipientsArray.join(', ');
                    } else if (fieldId === 'memoNumber') {
                        // Special handling for memo number - process antedated logic
                        const processed = processMemoNumber(newValue);
                        fieldElement.textContent = processed.displayValue;
                        
                        // Update page title
                        const pageTitle = document.getElementById('pageTitle');
                        if (pageTitle) {
                            pageTitle.textContent = `Memo No. ${processed.displayValue} - TESDA DBMS`;
                        }
                        
                        // Update global memo data
                        if (memoGlobal) {
                            memoGlobal.memoNumber = newValue;
                            memoGlobal.antedated = processed.isAntedated;
                        }
                        
                        // Update antedated badge and full memo number display
                        updateAntedatedDisplay(processed);
                    } else {
                        fieldElement.textContent = newValue;
                    }
                    
                    // Log the activity
                    const user = auth.currentUser;
                    if (user) {
                        await logMemoActivity(memoIdGlobal, `Updated ${fieldName}`, user);
                    }
                    
                    // Show success message
                    showSuccessMessage(`${fieldName} updated successfully`);
                    
                    // Refresh tooltips after update
                    addEditButtonTooltips();
                    
                } catch (error) {
                    console.error('Error updating field:', error);
                    alert('Error updating field. Please try again.');
                    // Restore original value
                    fieldElement.textContent = currentValue;
                } finally {
                    // Reset button state
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save';
                    saveBtn.className = 'px-3 py-1 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors mr-2';
                }
            });
            
            // Cancel button click handler
            cancelBtn.addEventListener('click', () => {
                fieldElement.textContent = currentValue;
            });
            
            // Handle Enter key for save, Escape key for cancel
            inputElement.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    saveBtn.click();
                } else if (e.key === 'Escape') {
                    cancelBtn.click();
                }
            });
        }

        // Function to show success message
        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 p-4 bg-green-50 border border-green-200 text-green-800 rounded-lg shadow-lg z-50';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        // Function to show archived banner
        function showArchivedBanner() {
            // Check if banner already exists
            if (document.getElementById('archivedBanner')) return;
            
            const banner = document.createElement('div');
            banner.id = 'archivedBanner';
            banner.className = 'bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-r-lg';
            banner.innerHTML = `
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i data-lucide="archive" class="w-5 h-5 text-yellow-400"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-yellow-800">
                            <strong>Memo Archived:</strong> This memo has been archived and cannot be edited. All edit buttons have been disabled.
                        </p>
                    </div>
                </div>
            `;
            
            // Insert banner after the header
            const header = document.querySelector('.max-w-7xl');
            header.insertBefore(banner, header.firstChild);
            
            // Recreate Lucide icons
            lucide.createIcons();
        }

        // Function to remove archived banner
        function removeArchivedBanner() {
            const banner = document.getElementById('archivedBanner');
            if (banner) {
                banner.remove();
            }
        }

        let memoGlobal = null;
        let memoIdGlobal = null;
        let isAdmin = false;

        // Helper function to log memo activity
        async function logMemoActivity(memoId, action, user) {
            try {
                const logsRef = collection(db, "memoActivities");
                await addDoc(logsRef, {
                    memoId: memoId,
                    action: action,
                    username: user.displayName || user.email,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error('Error logging memo activity:', error);
            }
        }

        // Function to log memo release
        async function logMemoRelease(memoId, user) {
            await logMemoActivity(memoId, 'Released Memo', user);
        }

        // Function to log memo receive
        async function logMemoReceive(memoId, user) {
            await logMemoActivity(memoId, 'Received Memo', user);
        }

        // Function to load activity logs
        function loadActivityLogs(memoId) {
            try {
                const logsRef = collection(db, "memoActivities");
                const q = query(
                    logsRef,
                    where("memoId", "==", memoId)
                );
                
                // Use onSnapshot for real-time updates
                return onSnapshot(q, async (querySnapshot) => {
                    activityLogBody.innerHTML = '';
                    // Get memo for columns
                    const memoRef = doc(db, 'memos', memoId);
                    const memoDoc = await getDoc(memoRef);
                    const memo = memoDoc.exists() ? memoDoc.data() : {};
                    if (querySnapshot.empty) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">
                                No activity logs found
                            </td>
                        `;
                        activityLogBody.appendChild(row);
                        return;
                    }
                    // Convert to array and sort by timestamp
                    const logs = [];
                    querySnapshot.forEach((doc) => {
                        logs.push(doc.data());
                    });
                    logs.sort((a, b) => {
                        const timeA = a.timestamp?.toDate() || new Date(0);
                        const timeB = b.timestamp?.toDate() || new Date(0);
                        return timeB - timeA;
                    });
                    logs.forEach((log) => {
                        const row = document.createElement('tr');
                        // Format the timestamp
                        const timestamp = log.timestamp?.toDate().toLocaleString() || 'N/A';
                        // Style the action text based on its type
                        let actionClass = 'text-gray-900';
                        if (log.action.includes('Status changed')) {
                            actionClass = 'text-blue-600 font-medium';
                        } else if (log.action.includes('Created Memo')) {
                            actionClass = 'text-green-600 font-medium';
                        } else if (log.action.includes('Released')) {
                            actionClass = 'text-purple-600 font-medium';
                        } else if (log.action.includes('Received')) {
                            actionClass = 'text-orange-600 font-medium';
                        }
                        // Created At, Released To, Received By (Date + Name)
                        const createdAt = memo.createdAt?.toDate ? memo.createdAt.toDate().toLocaleString() : 'N/A';
                        const releasedTo = memo.releasedToRodFasd?.toDate ? memo.releasedToRodFasd.toDate().toLocaleString() : '—';
                        const receivedBy = memo.receivedByRodFasd?.toDate ?
                            memo.receivedByRodFasd.toDate().toLocaleString() + (memo.receivedByName ? ` (${memo.receivedByName})` : '') : '—';
                        row.innerHTML = `
                            <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">${createdAt}</td>
                            <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">${releasedTo}</td>
                            <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">${receivedBy}</td>
                            <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">${timestamp}</td>
                            <td class="px-6 py-3 whitespace-nowrap text-sm ${actionClass}">${log.action}</td>
                            <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">${log.username}</td>
                        `;
                        activityLogBody.appendChild(row);
                    });
                }, (error) => {
                    console.error('Error loading activity logs:', error);
                    activityLogBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-sm text-red-500">
                                Error loading activity logs. Please try again later.
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error('Error setting up activity logs listener:', error);
                activityLogBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-sm text-red-500">
                            Error loading activity logs. Please try again later.
                        </td>
                    </tr>
                `;
            }
        }

        // Check authentication
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }

            // Check user role
            const userData = JSON.parse(localStorage.getItem('tesdaUser'));
            if (userData && (userData.role === 'Administrator' || userData.role === 'admin')) {
                isAdmin = true;
                // Show admin badge
                const adminBadge = document.getElementById('adminBadge');
                if (adminBadge) {
                    adminBadge.classList.remove('hidden');
                }
            }

            // Get memo ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const memoId = urlParams.get('id');

            if (!memoId) {
                errorMessage.textContent = 'No memo ID provided';
                errorMessage.classList.remove('hidden');
                return;
            }

            // Load memo details
            await loadMemoDetails(memoId);
            
            // Set up real-time listener for activity logs
            const unsubscribe = loadActivityLogs(memoId);

            // Clean up listener when component unmounts
            window.addEventListener('beforeunload', () => {
                if (unsubscribe) {
                    unsubscribe();
                }
            });
        });

        // Function to update PDF status display
        async function updatePDFStatus(memo) {
            const pdfStatusText = document.getElementById('pdfStatusText');
            const downloadBtn = document.getElementById('downloadPdfBtn');
            
            if (memo.pdfUrl) {
                // PDF URL exists in memo data
                pdfStatusText.innerHTML = `
                    <i data-lucide="file-text" class="w-4 h-4 mr-2 text-green-500"></i>
                    <span class="text-green-600">Available</span>
                `;
                downloadBtn.disabled = false;
                downloadBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                downloadBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            } else {
                // Check if PDF exists in Firebase Storage
                try {
                    const { ref, listAll } = await import("https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js");
                    const storage = await import('./firebase-config.js').then(module => module.storage);
                    
                    const storageRef = ref(storage, `memos/${memoIdGlobal}`);
                    const result = await listAll(storageRef);
                    
                    const pdfFile = result.items.find(item => item.name.toLowerCase().endsWith('.pdf'));
                    
                    if (pdfFile) {
                        pdfStatusText.innerHTML = `
                            <i data-lucide="file-text" class="w-4 h-4 mr-2 text-orange-500"></i>
                            <span class="text-orange-600">Found in Storage</span>
                        `;
                        downloadBtn.disabled = false;
                        downloadBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                        downloadBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                    } else {
                        pdfStatusText.innerHTML = `
                            <i data-lucide="file-x" class="w-4 h-4 mr-2 text-red-500"></i>
                            <span class="text-red-600">No Attachment</span>
                        `;
                        downloadBtn.disabled = true;
                        downloadBtn.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                        downloadBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    }
                } catch (error) {
                    console.error('Error checking PDF status:', error);
                    pdfStatusText.innerHTML = `
                        <i data-lucide="file-x" class="w-4 h-4 mr-2 text-red-500"></i>
                        <span class="text-red-600">No Attachment</span>
                    `;
                    downloadBtn.disabled = true;
                    downloadBtn.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                    downloadBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                }
            }
            
            // Recreate Lucide icons
            lucide.createIcons();
        }

        async function updateTrackingMap(memo) {
            console.log('Updating tracking map for memo:', memo.status, memo);
            
            // Update tracking dates
            if (memo.createdAt) {
                document.getElementById('trackingCreated').textContent = memo.createdAt.toDate().toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }
            
            // Reset all steps first
            const releasedStep = document.getElementById('trackingReleased');
            const receivedStep = document.getElementById('trackingReceived');
            const archivedStep = document.getElementById('trackingArchived');
            
            [releasedStep, receivedStep, archivedStep].forEach(step => {
                step.classList.remove('completed', 'current');
                step.querySelector('.tracking-circle').classList.remove('completed', 'current');
            });
            
            let completedSteps = 1; // Created step is always completed
            let currentStatus = 'Created';
            let timeInStatus = '—';
            
            // Released status
            if (memo.releasedToRodFasd) {
                releasedStep.classList.add('completed');
                releasedStep.querySelector('.tracking-circle').classList.add('completed');
                document.getElementById('trackingReleasedDate').textContent = memo.releasedToRodFasd.toDate().toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                document.getElementById('trackingReleasedStatus').innerHTML = `
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        <i data-lucide="check" class="w-3 h-3 mr-1"></i>
                        Completed
                    </span>
                `;
                completedSteps++;
                currentStatus = 'Released';
                timeInStatus = calculateTimeDifference(memo.createdAt, memo.releasedToRodFasd);
            } else if (memo.status === 'Released') {
                releasedStep.classList.add('current');
                releasedStep.querySelector('.tracking-circle').classList.add('current');
                document.getElementById('trackingReleasedStatus').innerHTML = `
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        <i data-lucide="clock" class="w-3 h-3 mr-1"></i>
                        In Progress
                    </span>
                `;
                currentStatus = 'Released';
                timeInStatus = calculateTimeDifference(memo.createdAt, new Date());
            } else {
                document.getElementById('trackingReleasedStatus').innerHTML = `
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                        <i data-lucide="clock" class="w-3 h-3 mr-1"></i>
                        Pending
                    </span>
                `;
            }
            
            // Received status
            if (memo.receivedByRodFasd) {
                receivedStep.classList.add('completed');
                receivedStep.querySelector('.tracking-circle').classList.add('completed');
                document.getElementById('trackingReceivedDate').textContent = memo.receivedByRodFasd.toDate().toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                document.getElementById('trackingReceivedStatus').innerHTML = `
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        <i data-lucide="check" class="w-3 h-3 mr-1"></i>
                        Completed
                    </span>
                `;
                completedSteps++;
                currentStatus = 'Received';
                timeInStatus = calculateTimeDifference(memo.releasedToRodFasd || memo.createdAt, memo.receivedByRodFasd);
            } else if (memo.status === 'Received') {
                receivedStep.classList.add('current');
                receivedStep.querySelector('.tracking-circle').classList.add('current');
                document.getElementById('trackingReceivedStatus').innerHTML = `
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        <i data-lucide="clock" class="w-3 h-3 mr-1"></i>
                        In Progress
                    </span>
                `;
                currentStatus = 'Received';
                timeInStatus = calculateTimeDifference(memo.releasedToRodFasd || memo.createdAt, new Date());
            } else {
                document.getElementById('trackingReceivedStatus').innerHTML = `
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                        <i data-lucide="clock" class="w-3 h-3 mr-1"></i>
                        Pending
                    </span>
                `;
            }
            
            // Archived status - check with case-insensitive comparison
            if (memo.status && memo.status.toLowerCase().trim() === 'archived') {
                archivedStep.classList.add('completed');
                archivedStep.querySelector('.tracking-circle').classList.add('completed');
                document.getElementById('trackingArchivedDate').textContent = memo.archivedAt?.toDate().toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                }) || '—';
                document.getElementById('trackingArchivedStatus').innerHTML = `
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        <i data-lucide="check" class="w-3 h-3 mr-1"></i>
                        Completed
                    </span>
                `;
                // Show check icon on archived step
                document.getElementById('archivedCheckIcon').classList.remove('hidden');
                completedSteps++;
                currentStatus = 'Archived';
                timeInStatus = calculateTimeDifference(memo.receivedByRodFasd || memo.releasedToRodFasd || memo.createdAt, memo.archivedAt);
            } else {
                // Hide check icon when not archived
                document.getElementById('archivedCheckIcon').classList.add('hidden');
                document.getElementById('trackingArchivedStatus').innerHTML = `
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                        <i data-lucide="clock" class="w-3 h-3 mr-1"></i>
                        Pending
                    </span>
                `;
            }
            
            // Update progress bar with special logic for archived status
            let progressPercentage = 0;
            
            console.log('Status check:', memo.status, 'Lowercase:', memo.status?.toLowerCase());
            
            // Check if memo is archived first - use case-insensitive comparison
            if (memo.status && memo.status.toLowerCase().trim() === 'archived') {
                console.log('Memo is archived, checking PDF...');
                // Check if PDF attachment exists
                if (memo.pdfUrl || await checkPDFInStorage(memoIdGlobal)) {
                    progressPercentage = 100; // Archived with PDF = 100%
                    console.log('PDF found, setting progress to 100%');
                } else {
                    progressPercentage = 90; // Archived without PDF = 90%
                    console.log('No PDF found, setting progress to 90%');
                }
            } else {
                // Normal progress calculation for other statuses
                const totalSteps = 4;
                progressPercentage = Math.round((completedSteps / totalSteps) * 100);
                console.log('Normal progress calculation:', completedSteps, '/', totalSteps, '=', progressPercentage + '%');
            }
            
            console.log('Final progress percentage:', progressPercentage);
            document.getElementById('trackingProgress').textContent = `${progressPercentage}%`;
            document.getElementById('trackingProgressBar').style.width = `${progressPercentage}%`;
            
            // Update tracking summary
            document.getElementById('trackingCurrentStatus').textContent = currentStatus;
            document.getElementById('trackingTimeInStatus').textContent = timeInStatus;
            
            // Add PDF status note for archived memos
            if (memo.status && memo.status.toLowerCase().trim() === 'archived') {
                const pdfExists = memo.pdfUrl || await checkPDFInStorage(memoIdGlobal);
                if (pdfExists) {
                    document.getElementById('trackingTimeInStatus').innerHTML = `
                        <span class="text-green-600">✓ Complete with PDF</span>
                    `;
                } else {
                    document.getElementById('trackingTimeInStatus').innerHTML = `
                        <span class="text-orange-600">⚠ Missing PDF attachment</span>
                    `;
                }
            }
            
            // Recreate Lucide icons for new status badges
            lucide.createIcons();
        }



        // Function to show step details modal
        window.showStepDetails = function(stepName, description) {
            const modal = document.getElementById('stepDetailsModal');
            const title = document.getElementById('stepDetailsTitle');
            const desc = document.getElementById('stepDetailsDescription');
            const status = document.getElementById('stepDetailsStatus');
            const date = document.getElementById('stepDetailsDate');
            const duration = document.getElementById('stepDetailsDuration');
            
            title.textContent = `${stepName} Step Details`;
            desc.textContent = description;
            
            // Get step status and details
            let stepStatus = 'Pending';
            let stepDate = '—';
            let stepDuration = '—';
            
            switch(stepName) {
                case 'Created':
                    stepStatus = 'Completed';
                    stepDate = memoGlobal?.createdAt?.toDate().toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    }) || '—';
                    stepDuration = '—';
                    break;
                case 'Released':
                    if (memoGlobal?.releasedToRodFasd) {
                        stepStatus = 'Completed';
                        stepDate = memoGlobal.releasedToRodFasd.toDate().toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                        stepDuration = calculateTimeDifference(memoGlobal.createdAt, memoGlobal.releasedToRodFasd);
                    } else if (memoGlobal?.status === 'Released') {
                        stepStatus = 'In Progress';
                        stepDate = '—';
                        stepDuration = calculateTimeDifference(memoGlobal.createdAt, new Date());
                    } else {
                        stepStatus = 'Pending';
                        stepDate = '—';
                        stepDuration = '—';
                    }
                    break;
                case 'Received':
                    if (memoGlobal?.receivedByRodFasd) {
                        stepStatus = 'Completed';
                        stepDate = memoGlobal.receivedByRodFasd.toDate().toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                        stepDuration = calculateTimeDifference(memoGlobal.releasedToRodFasd || memoGlobal.createdAt, memoGlobal.receivedByRodFasd);
                    } else if (memoGlobal?.status === 'Received') {
                        stepStatus = 'In Progress';
                        stepDate = '—';
                        stepDuration = calculateTimeDifference(memoGlobal.releasedToRodFasd || memoGlobal.createdAt, new Date());
                    } else {
                        stepStatus = 'Pending';
                        stepDate = '—';
                        stepDuration = '—';
                    }
                    break;
                case 'Archived':
                    if (memoGlobal?.status && memoGlobal.status.toLowerCase().trim() === 'archived') {
                        stepStatus = 'Completed';
                        stepDate = memoGlobal.archivedAt?.toDate().toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        }) || '—';
                        stepDuration = calculateTimeDifference(memoGlobal.receivedByRodFasd || memoGlobal.releasedToRodFasd || memoGlobal.createdAt, memoGlobal.archivedAt);
                    } else {
                        stepStatus = 'Pending';
                        stepDate = '—';
                        stepDuration = '—';
                    }
                    break;
            }
            
            // Update status with appropriate styling
            let statusHtml = '';
            switch(stepStatus) {
                case 'Completed':
                    statusHtml = `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        <i data-lucide="check" class="w-3 h-3 mr-1"></i>
                        ${stepStatus}
                    </span>`;
                    break;
                case 'In Progress':
                    statusHtml = `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        <i data-lucide="clock" class="w-3 h-3 mr-1"></i>
                        ${stepStatus}
                    </span>`;
                    break;
                default:
                    statusHtml = `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                        <i data-lucide="clock" class="w-3 h-3 mr-1"></i>
                        ${stepStatus}
                    </span>`;
            }
            
            status.innerHTML = statusHtml;
            date.textContent = stepDate;
            duration.textContent = stepDuration;
            
            modal.classList.remove('hidden');
            lucide.createIcons();
        }

        // Function to close step details modal
        window.closeStepDetails = function() {
            document.getElementById('stepDetailsModal').classList.add('hidden');
        }

        // Function to handle keyboard navigation for tracking steps
        window.handleStepKeydown = function(event, stepName, description) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                showStepDetails(stepName, description);
            }
        }

        // Helper function to check if PDF exists in storage
        async function checkPDFInStorage(memoId) {
            try {
                const { ref, listAll } = await import("https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js");
                const storage = await import('./firebase-config.js').then(module => module.storage);
                
                const storageRef = ref(storage, `memos/${memoId}`);
                const result = await listAll(storageRef);
                
                const pdfFile = result.items.find(item => item.name.toLowerCase().endsWith('.pdf'));
                return !!pdfFile; // Return true if PDF exists, false otherwise
            } catch (error) {
                console.error('Error checking PDF in storage:', error);
                return false;
            }
        }

        // Enhanced calculateTimeDifference function for step duration
        function calculateTimeDifference(startTimestamp, endTimestamp) {
            if (!startTimestamp) return '—';
            
            const start = startTimestamp.toDate();
            const end = endTimestamp ? endTimestamp.toDate() : new Date();
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Same day';
            if (diffDays === 1) return '1 day';
            if (diffDays < 7) return `${diffDays} days`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)} week${Math.floor(diffDays / 7) > 1 ? 's' : ''}`;
            if (diffDays < 365) return `${Math.floor(diffDays / 30)} month${Math.floor(diffDays / 30) > 1 ? 's' : ''}`;
            return `${Math.floor(diffDays / 365)} year${Math.floor(diffDays / 365) > 1 ? 's' : ''}`;
        }

        // Load memo details from Firestore
        async function loadMemoDetails(memoId) {
            try {
                loadingOverlay.classList.remove('hidden');
                errorMessage.classList.add('hidden');

                const memoRef = doc(db, "memos", memoId);
                const memoDoc = await getDoc(memoRef);

                if (!memoDoc.exists()) {
                    throw new Error('Memo not found');
                }

                const memo = memoDoc.data();
                memoGlobal = memo;
                memoIdGlobal = memoId;

                // Update page title with memo number
                const pageTitle = document.getElementById('pageTitle');
                if (pageTitle) {
                    // Use the memo number from memo data, not the document ID
                    let displayNumber = memoId; // fallback to document ID
                    
                    if (memo.memoNumber) {
                        // Process memo number to handle antedated logic
                        const processed = processMemoNumber(memo.memoNumber);
                        displayNumber = processed.displayValue;
                        
                        // Update memo data with antedated flag
                        memo.antedated = processed.isAntedated;
                    }
                    
                    pageTitle.textContent = `Memo No. ${displayNumber} - TESDA DBMS`;
                }

                // Update UI with memo details
                let el = document.getElementById('memoNumber');
                if (el) {
                    console.log('Memo number:', memo.memoNumber, 'Antedated:', memo.antedated);
                    if (memo.memoNumber) {
                        // Process memo number to handle antedated logic
                        const processed = processMemoNumber(memo.memoNumber);
                        console.log('Processed memo number:', processed);
                        el.textContent = processed.displayValue;
                        
                        // Update antedated display elements
                        updateAntedatedDisplay(processed);
                    } else {
                        el.textContent = memoId;
                    }
                }
                el = document.getElementById('title');
                if (el) el.textContent = memo.title;
                el = document.getElementById('department');
                if (el) el.textContent = memo.department;
                el = document.getElementById('signatory');
                if (el) el.textContent = memo.signatory;
                el = document.getElementById('authorFocal');
                if (el) el.textContent = memo.authorFocal;
                el = document.getElementById('status');
                if (el) el.textContent = memo.status;
                el = document.getElementById('createdAt');
                if (el) el.textContent = memo.createdAt.toDate().toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                el = document.getElementById('recipients');
                if (el) {
                    if (Array.isArray(memo.recipients)) {
                        el.textContent = memo.recipients.join(', ');
                    } else if (typeof memo.recipients === 'string') {
                        el.textContent = memo.recipients;
                    } else {
                        el.textContent = '';
                    }
                }
                el = document.getElementById('description');
                if (el) el.textContent = memo.description;

                await updateTrackingMap(memo);

                // Update PDF status
                updatePDFStatus(memo);

                // Disable editing if archived
                const isArchived = memo.status && memo.status.toLowerCase().trim() === 'archived';
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    if (isArchived) {
                        btn.classList.add('text-gray-300', 'cursor-not-allowed');
                        btn.disabled = true;
                        btn.style.pointerEvents = 'none';
                        btn.title = 'Cannot edit archived memo';
                    } else {
                        btn.classList.remove('text-gray-300', 'cursor-not-allowed');
                        btn.disabled = false;
                        btn.style.pointerEvents = '';
                        btn.title = btn.getAttribute('data-original-title') || 'Edit';
                    }
                });

                // Set up edit button functionality
                setupEditButtons();

                // Show archived status banner if memo is archived
                if (isArchived) {
                    showArchivedBanner();
                } else {
                    removeArchivedBanner();
                }
            } catch (error) {
                console.error('Error loading memo details:', error);
                errorMessage.textContent = error.message || 'Error loading memo details. Please try again.';
                errorMessage.classList.remove('hidden');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        window.downloadPDF = async function() {
            try {
                if (!memoGlobal || !memoIdGlobal) {
                    alert('Memo data not loaded');
                    return;
                }

                // First check if PDF URL exists in memo data
                if (memoGlobal.pdfUrl) {
                    window.open(memoGlobal.pdfUrl, '_blank');
                    return;
                }

                // If no URL in memo data, check Firebase Storage
                const { ref, getDownloadURL, listAll } = await import("https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js");
                const storage = await import('./firebase-config.js').then(module => module.storage);
                
                const storageRef = ref(storage, `memos/${memoIdGlobal}`);
                const result = await listAll(storageRef);
                
                const pdfFile = result.items.find(item => item.name.toLowerCase().endsWith('.pdf'));
                
                if (pdfFile) {
                    const downloadURL = await getDownloadURL(pdfFile);
                    window.open(downloadURL, '_blank');
                } else {
                    alert('No PDF attachment found for this memo');
                }
            } catch (error) {
                console.error('Error downloading PDF:', error);
                alert('Error accessing PDF file. Please try again later.');
            }
        };
    </script>
</body>
</html>
