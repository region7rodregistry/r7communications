<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Memo - TESDA DBMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script type="module" src="firebase-config.js"></script>
    <style>
        @media print {
            .no-print {
                display: none !important;
            }
            .memo-container {
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
            }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-4 rounded-lg shadow-lg">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        </div>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="hidden fixed top-4 right-4 p-4 bg-red-50 border border-red-200 text-red-800 rounded-md shadow-lg z-50"></div>

    <!-- Password Modal for Memo No. Editing -->
    <div id="memoNoPasswordModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-sm w-full mx-4 p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-2">Enter Password to Edit Memo No.</h3>
            <input type="password" id="memoNoPasswordInput" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 mb-2" placeholder="Password">
            <p id="memoNoPasswordError" class="hidden text-sm text-red-600 mb-2"></p>
            <div class="flex justify-end gap-2">
                <button id="cancelMemoNoPasswordBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">Cancel</button>
                <button id="confirmMemoNoPasswordBtn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md">Confirm</button>
            </div>
        </div>
    </div>

    <div class="max-w-[8.5in] mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8 no-print">
            <div class="flex items-center">
                <i data-lucide="file-text" class="w-8 h-8 text-blue-600 mr-3"></i>
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Memo Details</h1>
                    <p class="text-sm text-gray-500">View complete memo information</p>
                </div>
            </div>
            <div class="flex gap-4">
                <button onclick="window.print()" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                    <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                    Download
                </button>
                <button onclick="window.history.back()" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                    <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>
                    Back
                </button>
            </div>
        </div>

        <!-- TESDA Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <!-- Left Logo -->
                <div class="w-1/4">
                    <img src="icons/tlogo.png" alt="TESDA Logo" class="h-20 ml-auto">
                </div>
                
                <!-- Center Text -->
                <div class="text-center flex-1 px-4">
                    <h1 class="text-2xl font-bold text-gray-900">Technical Education and Skills Development Authority</h1>
                    <p class="text-lg text-gray-600">Region VII - Central Visayas</p>
                </div>
                <div class="w-1/4">
                    <img src="icons/TUV.png" alt="TESDA Logo" class="h-20 ml-auto">
                </div>
            </div>
        </div>

        <!-- Memo Container -->
        <div class="flex flex-col lg:flex-row gap-6 relative">
            <!-- Left Side Info -->
            <div class="w-full lg:w-60 space-y-6 mb-6 lg:mb-0">
                <div class="bg-white p-4 rounded-lg shadow flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500">Signatory:</p>
                        <span id="signatory" class="text-lg text-gray-900 inline-block"></span>
                    </div>
                    <button id="edit-signatory" class="edit-btn ml-2 text-gray-400 hover:text-blue-600 cursor-pointer" title="Edit Signatory">
                        <i data-lucide="pen" class="w-4 h-4"></i>
                    </button>
                </div>
                <div class="bg-white p-4 rounded-lg shadow flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500">Author/Focal:</p>
                        <span id="authorFocal" class="text-lg text-gray-900 inline-block"></span>
                    </div>
                    <button id="edit-authorFocal" class="edit-btn ml-2 text-gray-400 hover:text-blue-600 cursor-pointer" title="Edit Author/Focal">
                        <i data-lucide="pen" class="w-4 h-4"></i>
                    </button>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <p class="text-sm text-gray-500">Status:</p>
                    <span id="status" class="text-lg text-gray-900"></span>
                </div>
            </div>

            <!-- Memo Content -->
            <div class="memo-container bg-white shadow rounded-lg overflow-hidden p-8 min-h-[5in]">
                <!-- Memo Number and Date -->
                <div class="mb-8">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            <div>
                                <p class="text-sm text-gray-500 flex items-center">
                                    Memo No.:
                                    <span id="adminBadge" class="hidden ml-2 px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">Admin Only</span>
                                    <button id="edit-memoNumber" class="edit-btn ml-2 text-gray-400 hover:text-blue-600 cursor-pointer" title="Edit Memo Number">
                                        <i data-lucide="pen" class="w-4 h-4"></i>
                                    </button>
                                </p>
                                <span id="memoNumberWrapper">
                                  <p id="memoNumber" class="text-lg font-mono font-semibold text-blue-600"></p>
                                </span>
                            </div>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Date:</p>
                            <p id="createdAt" class="text-lg text-gray-900"></p>
                        </div>
                    </div>
                </div>

                <!-- From -->
                <div class="mb-8 flex items-center">
                    <div class="flex-1">
                        <p class="text-sm text-gray-500">From:</p>
                        <span id="department" class="text-lg text-gray-900 inline-block"></span>
                    </div>
                    <button id="edit-department" class="edit-btn ml-2 text-gray-400 hover:text-blue-600 cursor-pointer" title="Edit From">
                        <i data-lucide="pen" class="w-4 h-4"></i>
                    </button>
                </div>

                <!-- To -->
                <div class="mb-8 flex items-center">
                    <div class="flex-1">
                        <p class="text-sm text-gray-500">To:</p>
                        <span id="recipients" class="text-lg text-gray-900 inline-block"></span>
                    </div>
                    <button id="edit-recipients" class="edit-btn ml-2 text-gray-400 hover:text-blue-600 cursor-pointer" title="Edit To">
                        <i data-lucide="pen" class="w-4 h-4"></i>
                    </button>
                </div>

                <div class="mb-8 flex items-center">
                    <div class="flex-1">
                        <p class="text-sm text-gray-500">Subject:</p>
                        <span id="title" class="text-lg font-semibold text-gray-900 inline-block"></span>
                    </div>
                    <button id="edit-title" class="edit-btn ml-2 text-gray-400 hover:text-blue-600 cursor-pointer" title="Edit Subject">
                        <i data-lucide="pen" class="w-4 h-4"></i>
                    </button>
                </div>

                <!-- Description -->
                <div class="mb-8 flex items-center">
                    <div class="flex-1">
                        <p class="text-sm text-gray-500">Description:</p>
                        <span id="description" class="mt-2 text-lg text-gray-900 whitespace-pre-wrap border-t border-gray-200 pt-4 inline-block"></span>
                    </div>
                    <button id="edit-description" class="edit-btn ml-2 text-gray-400 hover:text-blue-600 cursor-pointer" title="Edit Description">
                        <i data-lucide="pen" class="w-4 h-4"></i>
                    </button>
                </div>

                <!-- Footer with Logo -->
                <div class="mt-8 flex justify-end">
                    <img src="icons/kayangkaya.png" alt="TESDA Logo" class="h-10">
                </div>

                <!-- Activity Log Section -->
                <div class="mt-12 border-t border-gray-200 pt-8">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Activity Log</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created At</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Released To</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Received By (Date + Name)</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                </tr>
                            </thead>
                            <tbody id="activityLogBody" class="bg-white divide-y divide-gray-200">
                                <!-- Activity logs will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, auth } from './firebase-config.js';
        import { doc, getDoc, updateDoc, collection, query, where, orderBy, getDocs, addDoc, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Initialize Lucide icons
        lucide.createIcons();

        // Get DOM elements
        const loadingOverlay = document.getElementById('loadingOverlay');
        const errorMessage = document.getElementById('errorMessage');
        const activityLogBody = document.getElementById('activityLogBody');

        let memoGlobal = null;
        let memoIdGlobal = null;
        let isAdmin = false;

        // Helper function to log memo activity
        async function logMemoActivity(memoId, action, user) {
            try {
                const logsRef = collection(db, "memoActivities");
                await addDoc(logsRef, {
                    memoId: memoId,
                    action: action,
                    username: user.displayName || user.email,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error('Error logging memo activity:', error);
            }
        }

        // Function to log memo release
        async function logMemoRelease(memoId, user) {
            await logMemoActivity(memoId, 'Released Memo', user);
        }

        // Function to log memo receive
        async function logMemoReceive(memoId, user) {
            await logMemoActivity(memoId, 'Received Memo', user);
        }

        // Function to load activity logs
        function loadActivityLogs(memoId) {
            try {
                const logsRef = collection(db, "memoActivities");
                const q = query(
                    logsRef,
                    where("memoId", "==", memoId)
                );
                
                // Use onSnapshot for real-time updates
                return onSnapshot(q, async (querySnapshot) => {
                    activityLogBody.innerHTML = '';
                    // Get memo for columns
                    const memoRef = doc(db, 'memos', memoId);
                    const memoDoc = await getDoc(memoRef);
                    const memo = memoDoc.exists() ? memoDoc.data() : {};
                    if (querySnapshot.empty) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">
                                No activity logs found
                            </td>
                        `;
                        activityLogBody.appendChild(row);
                        return;
                    }
                    // Convert to array and sort by timestamp
                    const logs = [];
                    querySnapshot.forEach((doc) => {
                        logs.push(doc.data());
                    });
                    logs.sort((a, b) => {
                        const timeA = a.timestamp?.toDate() || new Date(0);
                        const timeB = b.timestamp?.toDate() || new Date(0);
                        return timeB - timeA;
                    });
                    logs.forEach((log) => {
                        const row = document.createElement('tr');
                        // Format the timestamp
                        const timestamp = log.timestamp?.toDate().toLocaleString() || 'N/A';
                        // Style the action text based on its type
                        let actionClass = 'text-gray-900';
                        if (log.action.includes('Status changed')) {
                            actionClass = 'text-blue-600 font-medium';
                        } else if (log.action.includes('Created Memo')) {
                            actionClass = 'text-green-600 font-medium';
                        } else if (log.action.includes('Released')) {
                            actionClass = 'text-purple-600 font-medium';
                        } else if (log.action.includes('Received')) {
                            actionClass = 'text-orange-600 font-medium';
                        }
                        // Created At, Released To, Received By (Date + Name)
                        const createdAt = memo.createdAt?.toDate ? memo.createdAt.toDate().toLocaleString() : 'N/A';
                        const releasedTo = memo.releasedToRodFasd?.toDate ? memo.releasedToRodFasd.toDate().toLocaleString() : '—';
                        const receivedBy = memo.receivedByRodFasd?.toDate ?
                            memo.receivedByRodFasd.toDate().toLocaleString() + (memo.receivedByName ? ` (${memo.receivedByName})` : '') : '—';
                        row.innerHTML = `
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${createdAt}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${releasedTo}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${receivedBy}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${timestamp}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm ${actionClass}">${log.action}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${log.username}</td>
                        `;
                        activityLogBody.appendChild(row);
                    });
                }, (error) => {
                    console.error('Error loading activity logs:', error);
                    activityLogBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-sm text-red-500">
                                Error loading activity logs. Please try again later.
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error('Error setting up activity logs listener:', error);
                activityLogBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-sm text-red-500">
                            Error loading activity logs. Please try again later.
                        </td>
                    </tr>
                `;
            }
        }

        // Check authentication
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }

            // Check user role
            const userData = JSON.parse(localStorage.getItem('tesdaUser'));
            if (userData && (userData.role === 'Administrator' || userData.role === 'admin')) {
                isAdmin = true;
                // Show admin badge
                const adminBadge = document.getElementById('adminBadge');
                if (adminBadge) {
                    adminBadge.classList.remove('hidden');
                }
            }

            // Get memo ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const memoId = urlParams.get('id');

            if (!memoId) {
                errorMessage.textContent = 'No memo ID provided';
                errorMessage.classList.remove('hidden');
                return;
            }

            // Load memo details
            await loadMemoDetails(memoId);
            
            // Set up real-time listener for activity logs
            const unsubscribe = loadActivityLogs(memoId);

            // Clean up listener when component unmounts
            window.addEventListener('beforeunload', () => {
                if (unsubscribe) {
                    unsubscribe();
                }
            });
        });

        // Load memo details from Firestore
        async function loadMemoDetails(memoId) {
            try {
                loadingOverlay.classList.remove('hidden');
                errorMessage.classList.add('hidden');

                const memoRef = doc(db, "memos", memoId);
                const memoDoc = await getDoc(memoRef);

                if (!memoDoc.exists()) {
                    throw new Error('Memo not found');
                }

                const memo = memoDoc.data();
                memoGlobal = memo;
                memoIdGlobal = memoId;

                // Update UI with memo details
                let el = document.getElementById('memoNumber');
                if (el) {
                    if (memo.antedated) {
                        // Show last two segments joined by '-'
                        const parts = memo.memoNumber.split('-');
                        el.textContent = parts.slice(-2).join('-');
                    } else {
                        // Show only the last segment
                        el.textContent = memo.memoNumber.split('-').pop();
                    }
                }
                el = document.getElementById('title');
                if (el) el.textContent = memo.title;
                el = document.getElementById('department');
                if (el) el.textContent = memo.department;
                el = document.getElementById('signatory');
                if (el) el.textContent = memo.signatory;
                el = document.getElementById('authorFocal');
                if (el) el.textContent = memo.authorFocal;
                el = document.getElementById('status');
                if (el) el.textContent = memo.status;
                el = document.getElementById('createdAt');
                if (el) el.textContent = memo.createdAt.toDate().toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                el = document.getElementById('recipients');
                if (el) {
                    if (Array.isArray(memo.recipients)) {
                        el.textContent = memo.recipients.join(', ');
                    } else if (typeof memo.recipients === 'string') {
                        el.textContent = memo.recipients;
                    } else {
                        el.textContent = '';
                    }
                }
                el = document.getElementById('description');
                if (el) el.textContent = memo.description;

                // Disable editing if archived
                const isArchived = memo.status && memo.status.toLowerCase() === 'archived';
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    if (isArchived) {
                        btn.classList.add('text-gray-300', 'cursor-not-allowed');
                        btn.disabled = true;
                        btn.style.pointerEvents = 'none';
                    } else {
                        btn.classList.remove('text-gray-300', 'cursor-not-allowed');
                        btn.disabled = false;
                        btn.style.pointerEvents = '';
                    }
                });
            } catch (error) {
                console.error('Error loading memo details:', error);
                errorMessage.textContent = error.message || 'Error loading memo details. Please try again.';
                errorMessage.classList.remove('hidden');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        // Inline editing logic for each field
        function setupInlineEditing() {
            const fields = [
                { id: 'signatory', btn: 'edit-signatory', field: 'signatory', type: 'text' },
                { id: 'authorFocal', btn: 'edit-authorFocal', field: 'authorFocal', type: 'text' },
                { id: 'department', btn: 'edit-department', field: 'department', type: 'text' },
                { id: 'recipients', btn: 'edit-recipients', field: 'recipients', type: 'text' },
                { id: 'title', btn: 'edit-title', field: 'title', type: 'text' },
                { id: 'description', btn: 'edit-description', field: 'description', type: 'textarea' },
                { id: 'memoNumber', btn: 'edit-memoNumber', field: 'memoNumber', type: 'text' },
            ];
            fields.forEach(({ id, btn, field, type, options }) => {
                const btnEl = document.getElementById(btn);
                const fieldEl = document.getElementById(id);
                if (!btnEl || !fieldEl) return;
                // For memoNumber, show password modal before editing
                if (field === 'memoNumber') {
                    btnEl.addEventListener('click', () => {
                        if (btnEl.disabled) return;
                        openMemoNoPasswordModal(() => startMemoNoEdit(fieldEl, btnEl));
                    });
                } else {
                    btnEl.addEventListener('click', () => {
                        if (btnEl.disabled) return;
                        startInlineEdit(fieldEl, btnEl, field, type, options);
                    });
                }
            });
        }

        // Inline edit for all fields except memoNumber
        function startInlineEdit(fieldEl, btnEl, field, type, options) {
            let input;
            if (type === 'dropdown') {
                input = document.createElement('select');
                input.className = 'border border-blue-300 rounded px-2 py-1 focus:ring-2 focus:ring-blue-500';
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;
                    option.textContent = opt;
                    if (fieldEl.textContent.trim() === opt) option.selected = true;
                    input.appendChild(option);
                });
            } else if (type === 'textarea') {
                input = document.createElement('textarea');
                input.className = 'border border-blue-300 rounded px-2 py-1 focus:ring-2 focus:ring-blue-500 w-full';
                input.value = fieldEl.textContent.trim();
                input.rows = 3;
            } else {
                input = document.createElement('input');
                input.type = 'text';
                input.className = 'border border-blue-300 rounded px-2 py-1 focus:ring-2 focus:ring-blue-500';
                input.value = fieldEl.textContent.trim();
            }
            fieldEl.replaceWith(input);
            input.focus();
            // Save on Enter or blur
            const save = async () => {
                if (input._saving) return;
                input._saving = true;
                const value = (type === 'dropdown') ? input.value : (type === 'textarea' ? input.value : input.value.trim());
                btnEl.innerHTML = '<svg class="animate-spin h-4 w-4 text-blue-600 ml-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path></svg>';
                try {
                    loadingOverlay.classList.remove('hidden');
                    const memoRef = doc(db, 'memos', memoIdGlobal);
                    let updateObj = {};
                    if (field === 'recipients') {
                        updateObj[field] = value.split(',').map(s => s.trim()).filter(Boolean);
                    } else {
                        updateObj[field] = value;
                    }
                    await updateDoc(memoRef, updateObj);
                    // Log activity
                    const user = auth.currentUser;
                    await logMemoActivity(memoIdGlobal, `Edited ${field.charAt(0).toUpperCase() + field.slice(1)}`, user);
                    // Reload memo details
                    await loadMemoDetails(memoIdGlobal);
                    // Show checkmark
                    btnEl.innerHTML = '<i data-lucide="check" class="w-4 h-4 text-green-500 ml-2"></i>';
                    lucide.createIcons();
                    setTimeout(() => {
                        btnEl.innerHTML = '<i data-lucide="pen" class="w-4 h-4"></i>';
                        lucide.createIcons();
                    }, 1200);
                } catch (err) {
                    btnEl.innerHTML = '<i data-lucide="x" class="w-4 h-4 text-red-500 ml-2"></i>';
                    setTimeout(() => {
                        btnEl.innerHTML = '<i data-lucide="pen" class="w-4 h-4"></i>';
                        lucide.createIcons();
                    }, 1200);
                    errorMessage.textContent = 'Failed to save. Try again.';
                    errorMessage.classList.remove('hidden');
                } finally {
                    loadingOverlay.classList.add('hidden');
                    input._saving = false;
                }
            };
            input.addEventListener('keydown', e => {
                if (e.key === 'Enter' && type !== 'textarea') {
                    save();
                }
            });
            input.addEventListener('blur', save);
        }

        // Memo No. password modal logic
        function openMemoNoPasswordModal(onSuccess) {
            const modal = document.getElementById('memoNoPasswordModal');
            const input = document.getElementById('memoNoPasswordInput');
            const error = document.getElementById('memoNoPasswordError');
            const confirmBtn = document.getElementById('confirmMemoNoPasswordBtn');
            const cancelBtn = document.getElementById('cancelMemoNoPasswordBtn');
            error.classList.add('hidden');
            input.value = '';
            modal.classList.remove('hidden');
            input.focus();
            function closeModal() {
                modal.classList.add('hidden');
                input.value = '';
                error.classList.add('hidden');
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', closeModal);
                input.removeEventListener('keydown', keyHandler);
            }
            function confirmHandler() {
                if (input.value === 'admintesda') {
                    closeModal();
                    if (typeof onSuccess === 'function') onSuccess();
                } else {
                    error.textContent = 'Incorrect password.';
                    error.classList.remove('hidden');
                    input.focus();
                }
            }
            function keyHandler(e) {
                if (e.key === 'Enter') confirmHandler();
            }
            confirmBtn.addEventListener('click', confirmHandler);
            cancelBtn.addEventListener('click', closeModal);
            input.addEventListener('keydown', keyHandler);
        }

        // Memo No. inline edit after password
        function startMemoNoEdit(fieldEl, btnEl) {
            let input = document.createElement('input');
            input.type = 'text';
            input.className = 'border border-blue-300 rounded px-2 py-1 focus:ring-2 focus:ring-blue-500 font-mono text-lg font-semibold text-blue-600';
            input.value = fieldEl.textContent.trim();
            fieldEl.replaceWith(input);
            input.focus();
            const save = async () => {
                if (input._saving) return;
                input._saving = true;
                const value = input.value.trim();
                btnEl.innerHTML = '<svg class="animate-spin h-4 w-4 text-blue-600 ml-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path></svg>';
                try {
                    loadingOverlay.classList.remove('hidden');
                    const memoRef = doc(db, 'memos', memoIdGlobal);
                    await updateDoc(memoRef, { memoNumber: value });
                    // Log activity
                    const user = auth.currentUser;
                    await logMemoActivity(memoIdGlobal, 'Edited Memo Number', user);
                    await loadMemoDetails(memoIdGlobal);
                    btnEl.innerHTML = '<i data-lucide="check" class="w-4 h-4 text-green-500 ml-2"></i>';
                    lucide.createIcons();
                    setTimeout(() => {
                        btnEl.innerHTML = '<i data-lucide="pen" class="w-4 h-4"></i>';
                        lucide.createIcons();
                    }, 1200);
                } catch (err) {
                    btnEl.innerHTML = '<i data-lucide="x" class="w-4 h-4 text-red-500 ml-2"></i>';
                    setTimeout(() => {
                        btnEl.innerHTML = '<i data-lucide="pen" class="w-4 h-4"></i>';
                        lucide.createIcons();
                    }, 1200);
                    errorMessage.textContent = 'Failed to save. Try again.';
                    errorMessage.classList.remove('hidden');
                } finally {
                    loadingOverlay.classList.add('hidden');
                    input._saving = false;
                }
            };
            input.addEventListener('keydown', e => {
                if (e.key === 'Enter') save();
            });
            input.addEventListener('blur', save);
        }

        document.addEventListener('DOMContentLoaded', setupInlineEditing);
    </script>
</body>
</html> 