<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Document - TESDA MBMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script type="module" src="firebase-config.js"></script>
    <link rel="icon" type="image/png" href="./icons/Mlogo.png">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                            950: '#082f49',
                        }
                    },
                    boxShadow: {
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
        }

        /* Custom modal animations */
        .modal-enter {
            animation: modalEnter 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-exit {
            animation: modalExit 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalEnter {
            0% {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes modalExit {
            0% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
            100% {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
        }

        /* Success icon animation */
        .success-icon {
            animation: successPulse 0.6s ease-out;
        }

        @keyframes successPulse {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Memo number glow effect */
        .memo-number-glow {
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
            animation: memoGlow 2s ease-in-out infinite alternate;
        }

        @keyframes memoGlow {
            0% {
                text-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
            }
            100% {
                text-shadow: 0 0 20px rgba(59, 130, 246, 0.8), 0 0 30px rgba(59, 130, 246, 0.4);
            }
        }

        /* Countdown animation */
        .countdown-pulse {
            animation: countdownPulse 1s ease-in-out;
        }

        @keyframes countdownPulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
            }
        }

        /* Button hover effects */
        .btn-hover-glow:hover {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
        }

        /* Glass morphism effects */
        /* Custom scrollbar for select elements */
        select {
            scrollbar-width: thin;
            scrollbar-color: #0ea5e9 #e0f2fe;
        }
        select::-webkit-scrollbar {
            width: 8px;
        }
        select::-webkit-scrollbar-track {
            background: #e0f2fe;
            border-radius: 4px;
        }
        select::-webkit-scrollbar-thumb {
            background-color: #0ea5e9;
            border-radius: 4px;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
    <div class="max-w-screen-md mx-auto py-6 px-2 sm:px-4 md:px-8">
        <!-- Header -->
        <div class="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <img src="icons/tlogo.png" alt="TESDA Logo" class="h-12 w-auto sm:h-16">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 tracking-tight">Create New Document</h1>
                    <p class="mt-1 text-sm text-gray-500">Fill out the form below to create a new memo</p>
                </div>
            </div>
            <div class="flex items-center gap-4 w-full sm:w-auto">
                <img src="icons/blogo.png" alt="RO7 Logo" class="h-12 w-auto sm:h-16">
                <button onclick="window.history.back()" class="w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                    <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>
                    Back
                </button>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-xl shadow-xl flex flex-col items-center">
                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-600 mb-4"></div>
                <p class="text-gray-700 font-medium">Processing...</p>
            </div>
        </div>

        <!-- Success Modal -->
        <div id="successModal" class="hidden fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50">
            <div class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-800 border border-blue-500/20 rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl transform scale-95 opacity-0 transition-all duration-500 ease-in-out">
                <!-- Success Icon -->
                <div class="flex justify-center mb-6">
                    <div class="w-16 h-16 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center shadow-lg success-icon">
                        <i data-lucide="check" class="h-8 w-8 text-white"></i>
                    </div>
                </div>

                <!-- Success Message -->
                <div class="text-center mb-6">
                    <h3 class="text-2xl font-bold text-white mb-2">Memo Created Successfully!</h3>
                    <p class="text-blue-200 text-sm mb-4">Your document has been created and saved to the system.</p>
                    
                    <!-- Memo Number Display -->
                    <div class="bg-gradient-to-r from-blue-600/20 to-purple-600/20 border border-blue-500/30 rounded-lg p-4 mb-6">
                        <p class="text-blue-200 text-sm mb-2">Generated Memo Number:</p>
                        <p id="modalMemoNumber" class="text-2xl font-bold text-white tracking-wider memo-number-glow"></p>
                    </div>

                    <!-- Auto-redirect countdown -->
                    <div class="flex items-center justify-center text-blue-300 text-sm">
                        <i data-lucide="clock" class="h-4 w-4 mr-2"></i>
                        <span>Redirecting in <span id="countdown" class="font-bold">10</span> seconds...</span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3">
                    <button
                        id="continueBtn"
                        class="flex-1 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-medium py-3 px-4 rounded-lg transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-900 btn-hover-glow"
                    >
                        Continue
                    </button>
                    <button
                        id="createAnotherBtn"
                        class="flex-1 bg-gradient-to-r from-slate-600 to-slate-700 hover:from-slate-700 hover:to-slate-800 text-white font-medium py-3 px-4 rounded-lg transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2 focus:ring-offset-slate-900 btn-hover-glow"
                    >
                        Create Another
                    </button>
                </div>
            </div>
        </div>

        <!-- Alert Messages -->
        <div id="errorMessage" class="hidden mb-6 p-4 border-l-4 border-red-500 bg-red-50 rounded-r-lg shadow-sm">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i data-lucide="alert-circle" class="h-5 w-5 text-red-500"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-red-700 font-medium"></p>
                </div>
            </div>
        </div>

        <div id="successMessage" class="hidden mb-6 p-4 border-l-4 border-green-500 bg-green-50 rounded-r-lg shadow-sm">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i data-lucide="check-circle" class="h-5 w-5 text-green-500"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-green-700 font-medium"></p>
                </div>
            </div>
        </div>

        <!-- Memo Form -->
        <form id="memoForm" class="bg-white shadow-md rounded-lg p-4 sm:p-6 md:p-8 m-4 space-y-4 transition-all duration-300 hover:shadow-lg">
            <div class="flex flex-col space-y-4">
                <!-- Antedation Section -->
                <div class="border-b border-gray-200 pb-4">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <i data-lucide="calendar" class="h-5 w-5 text-gray-400"></i>
                            <label class="text-sm font-medium text-gray-700">Antedation</label>
                        </div>
                        <div class="flex items-center">
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="isAntedated" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
                            </label>
                        </div>
                    </div>
                    
                    <div id="antedationDateContainer" class="hidden">
                        <div class="relative">
                            <label for="antedationDate" class="block text-sm font-medium text-gray-700 mb-1">Antedation Date <span class="text-red-500">*</span></label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i data-lucide="calendar-days" class="h-4 w-4 text-gray-400"></i>
                                </div>
                                <input type="date" id="antedationDate" name="antedationDate" 
                                    class="block w-full border border-gray-300 rounded-lg shadow-md py-2.5 pl-10 pr-3 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200 text-base"
                                    max="">
                                <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                                    <span class="text-xs text-gray-500">Past date only</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="flex items-start gap-2">
                                <i data-lucide="info" class="h-4 w-4 text-blue-500 mt-0.5 flex-shrink-0"></i>
                                <div class="text-xs text-blue-700">
                                    <p class="font-medium mb-1">Antedation Information:</p>
                                    <ul class="space-y-1">
                                        <li>• Memo will be dated with the selected past date</li>
                                        <li>• Memo number will include a suffix (A, B, C, etc.)</li>
                                        <li>• Example: If last memo on that date was 1405, this becomes 1405-A</li>
                                        <li>• Normal memos continue with sequential numbering</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Memo Type -->
                <div class="relative">
                    <label for="memoType" class="block text-sm font-medium text-gray-700 mb-1">Document Type <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <select id="memoType" name="memoType" required
                            class="appearance-none block w-full border border-gray-300 rounded-lg shadow-md py-2.5 pl-3 pr-10 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200 text-base">
                            <option value="">Document Type</option>
                            <option value="PO">PO (Provincial Office)</option>
                            <option value="CO">CO (Central Office)</option>
                            <option value="Office Order">Office Order</option>
                            <option value="AdvisoryBulletin">Advisory/Bulletin</option>
                            <option value="Acknowledgment">Acknowledgment</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                            <i data-lucide="chevron-down" class="h-4 w-4"></i>
                        </div>
                    </div>
                </div>

                <!-- Memo Number (Read-only for non-admins, editable for admins) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Document Number
                        <span id="adminBadge" class="hidden ml-2 px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">Admin Only</span>
                    </label>
                    <div id="memoNumberContainer" class="flex items-center border border-gray-300 rounded-lg shadow-md py-2.5 px-3 bg-gray-50">
                        <i data-lucide="hash" class="h-4 w-4 text-gray-400 mr-2"></i>
                        <span id="assignedMemoNumber" class="text-gray-700 font-medium">Select Document type first</span>
                        <div id="antedationIndicator" class="hidden ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full">
                            Antedated
                        </div>
                        <!-- Admin edit button (hidden by default) -->
                        <button id="editMemoNumberBtn" class="hidden ml-auto text-blue-600 hover:text-blue-800 cursor-pointer" title="Edit Memo Number">
                            <i data-lucide="pen" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <!-- Admin memo number input (hidden by default) -->
                    <div id="memoNumberInputContainer" class="hidden mt-2">
                        <input type="text" id="memoNumberInput" 
                               class="block w-full border border-blue-300 rounded-lg shadow-md py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200 text-base"
                               placeholder="Enter custom memo number">
                        <div class="flex gap-2 mt-2">
                            <button id="saveMemoNumberBtn" class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700">
                                Save
                            </button>
                            <button id="cancelMemoNumberBtn" class="px-3 py-1 text-sm bg-gray-600 text-white rounded hover:bg-gray-700">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Title -->
                <div class="relative">
                    <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Title <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="file-text" class="h-4 w-4 text-gray-400"></i>
                        </div>
                        <input type="text" id="title" name="title" required maxlength="200"
                            class="block w-full border border-gray-300 rounded-lg shadow-md py-2.5 pl-10 pr-3 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200 text-base"
                            placeholder="Enter Document title">
                        <div class="absolute bottom-2 right-3 text-xs text-gray-500 select-none">
                            <span id="titleCharCount">0</span>/200 characters
                        </div>
                    </div>
                </div>

                <!-- Author/Focal -->
                <div class="relative" id="authorFocalContainer"></div>

                <!-- Signatory -->
                <div class="relative" id="signatory-container">
                    <label for="signatory" class="block text-sm font-medium text-gray-700 mb-1">Signatory <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <select id="signatory" name="signatory" required
                            class="appearance-none block w-full border border-gray-300 rounded-lg shadow-md py-2.5 pl-3 pr-10 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200 text-base">
                            <option value="">Select Signatory</option>
                            <option value="Gamaliel B. Vicente, Jr. CESO III, ASEAN ENG.">Gamaliel B. Vicente, Jr. CESO III, ASEAN ENG.</option>
                            <option value="Ivy Michelle T. Vasquez">Ivy Michelle T. Vasquez</option>
                            <option value="Jocelyn V. Cabahug">Jocelyn V. Cabahug</option>
                            <option value="Others">Other (Please specify)</option>
                        </select>
                        <div id="signatory-other-wrapper" class="hidden relative">
                            <input type="text" id="signatory-other" name="signatory-other" placeholder="Enter custom Signatory" class="block w-full border border-gray-300 rounded-lg shadow-md py-2.5 pl-3 pr-3 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200 text-base" />
                            <button type="button" id="signatory-back-btn" class="absolute right-2 top-1/2 -translate-y-1/2 text-xs text-primary-600 hover:underline focus:outline-none">Back to Select</button>
                        </div>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                            <i data-lucide="chevron-down" class="h-4 w-4"></i>
                        </div>
                    </div>
                </div>

                <!-- Recipients -->
                <div class="relative" id="recipients-container">
                    <label for="recipients" class="block text-sm font-medium text-gray-700 mb-1">Recipients <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="users" class="h-4 w-4 text-gray-400"></i>
                        </div>
                        <select id="recipients" name="recipients" required
                            class="appearance-none block w-full border border-gray-300 rounded-lg shadow-md py-2.5 pl-10 pr-10 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200 text-base">
                            <option value="">Select Recipient</option>
                            <option value="ORD">Office of the Regional Director</option>
                            <option value="ROD">Regional Operations Division</option>
                            <option value="FASD">Finance and Administrative Services Division</option>
                            <option value="Central Office">Central Office</option>
                            <option value="AOUs">All Operating Units</option>
                            <option value="APOs">All Provincial Offices</option>
                            <option value="TTIs">All TTIs / TTI</option>
                            <option value="PO Cebu">Provincial Office - Cebu</option>
                            <option value="PO Bohol">Provincial Office - Bohol</option>
                            <option value="PO Siquijor">Provincial Office - Siquijor</option>
                            <option value="PO Negros Oriental">Provincial Office - Negros Oriental</option>
                            <option value="LTI">Lazi Technical Institute</option>
                            <option value="RTC">Regional Training Center VII</option>
                            <option value="Others">Other (Please specify on Description)</option>
                        </select>
                        <div id="recipients-other-wrapper" class="hidden relative">
                            <input type="text" id="recipients-other" name="recipients-other" placeholder="Enter custom recipient" class="block w-full border border-gray-300 rounded-lg shadow-md py-2.5 pl-10 pr-3 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200 text-base" />
                            <button type="button" id="recipients-back-btn" class="absolute right-2 top-1/2 -translate-y-1/2 text-xs text-primary-600 hover:underline focus:outline-none">Back to Select</button>
                        </div>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                            <i data-lucide="chevron-down" class="h-4 w-4"></i>
                        </div>
                    </div>
                </div>

                <!-- Description -->
                <div class="relative">
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Description <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <textarea id="description" name="description" rows="5" required maxlength="300"
                            class="block w-full border border-gray-300 rounded-lg shadow-md py-2.5 pl-3 pr-3 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200 resize-none text-base"
                            placeholder="Enter memo description"></textarea>
                        <div class="absolute bottom-2 right-3 text-xs text-gray-500 select-none">
                            <span id="descriptionCharCount">0</span>/300 characters
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex flex-col-reverse sm:flex-row justify-between items-center gap-4">
                <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                    <button type="button" onclick="window.history.back()" class="w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 border border-gray-300 rounded-lg shadow-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors duration-200 mb-2 sm:mb-0">
                        Cancel
                    </button>
                    <button type="submit"
                        class="w-full sm:w-auto inline-flex items-center justify-center px-5 py-2.5 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all duration-200">
                        <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                        Create Document
                    </button>
                </div>
                <img src="icons/kayangkaya.png" alt="MBMS Logo" class="h-12 w-auto sm:h-16">
            </div>
        </form>
    </div>

    <script type="module">
        import { createMemo, auth } from './firebase-config.js';
        import { doc, onSnapshot, updateDoc, setDoc, runTransaction, serverTimestamp, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        import { db } from './firebase-config.js';

        // Initialize Lucide icons
        lucide.createIcons();

        // Get DOM elements
        const memoForm = document.getElementById('memoForm');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const assignedMemoNumber = document.getElementById('assignedMemoNumber');
        const memoTypeSelect = document.getElementById('memoType');
        const isAntedatedToggle = document.getElementById('isAntedated');
        const antedationDateContainer = document.getElementById('antedationDateContainer');
        const antedationDateInput = document.getElementById('antedationDate');
        const antedationIndicator = document.getElementById('antedationIndicator');
        const recipientsSelect = document.getElementById('recipients');
        const recipientsOtherInput = document.getElementById('recipients-other');
        const recipientsContainer = document.getElementById('recipients-container');
        const recipientsOtherWrapper = document.getElementById('recipients-other-wrapper');
        const recipientsBackBtn = document.getElementById('recipients-back-btn');
        
        // Modal elements
        const successModal = document.getElementById('successModal');
        const modalMemoNumber = document.getElementById('modalMemoNumber');
        const countdownElement = document.getElementById('countdown');
        const continueBtn = document.getElementById('continueBtn');
        const createAnotherBtn = document.getElementById('createAnotherBtn');

        // Admin memo number editing elements
        const editMemoNumberBtn = document.getElementById('editMemoNumberBtn');
        const memoNumberInputContainer = document.getElementById('memoNumberInputContainer');
        const memoNumberInput = document.getElementById('memoNumberInput');
        const saveMemoNumberBtn = document.getElementById('saveMemoNumberBtn');
        const cancelMemoNumberBtn = document.getElementById('cancelMemoNumberBtn');
        const memoNumberContainer = document.getElementById('memoNumberContainer');

        // User role and admin status
        let isAdmin = false;
        let customMemoNumber = null;
        const adminBadge = document.getElementById('adminBadge');

        // Antedation state variables
        let isAntedated = false;
        let antedationDate = null;

        let poNumberRef = null;
        let coNumberRef = null;
        let poUnsubscribe = null;
        let coUnsubscribe = null;

        // Map memoType to Firestore doc IDs
        const memoTypeToDocId = {
            'PO': 'current',
            'CO': 'coCurrent',
            'Office Order': 'officeOrder',
            'AdvisoryBulletin': 'advisoryBulletin',
            'Acknowledgment': 'acknowledgment',
        };

        let unsubscribeMemoNumber = null;

        function updateMemoNumberFromFirebase() {
            if (unsubscribeMemoNumber) {
                unsubscribeMemoNumber();
                unsubscribeMemoNumber = null;
            }
            const type = memoTypeSelect.value;
            if (!type || !memoTypeToDocId[type]) {
                assignedMemoNumber.textContent = 'Select memo type first';
                return;
            }
            const docId = memoTypeToDocId[type];
            const memoNumberRef = doc(db, 'memoNumbers', docId);
            unsubscribeMemoNumber = onSnapshot(memoNumberRef, (docSnap) => {
                if (docSnap.exists()) {
                    const number = docSnap.data().number;
                    assignedMemoNumber.textContent = String(number).padStart(4, '0');
                } else {
                    assignedMemoNumber.textContent = 'Not available';
                }
            });
        }

        memoTypeSelect.addEventListener('change', function() {
            if (isAntedated) {
                // If antedation is enabled, check if we have both type and date
                if (antedationDate) {
                    updateMemoNumberDisplay();
                } else {
                    assignedMemoNumber.textContent = 'Select antedation date';
                }
            } else {
                // Normal memo number logic
                updateMemoNumberDisplay();
            }
        });

        window.addEventListener('DOMContentLoaded', function() {
            if (isAntedated) {
                assignedMemoNumber.textContent = 'Select memo type first';
            } else {
                updateMemoNumberDisplay();
            }

            // Author/Focal field logic (dropdown with 'Others' option)
            const authorFocalContainer = document.getElementById('authorFocalContainer');
            if (authorFocalContainer) {
                authorFocalContainer.innerHTML = `
                    <label for="authorFocal" class="block text-sm font-medium text-gray-700 mb-1">Author/Focal <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <select id="authorFocal" name="authorFocal" required
                            class="appearance-none block w-full border border-gray-300 rounded-lg shadow-md py-2.5 pl-3 pr-10 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200 text-base">
                            <option value="">Select Author/Focal</option>
                            <!-- ROD -->
                            <option value="AGBAY, ANNALIE B.">AGBAY, ANNALIE B.</option>
                            <option value="CABAHUG, JOCELYN V">CABAHUG, JOCELYN V</option>
                            <option value="CALAGO, ZHAIRAH P">CALAGO, ZHAIRAH P</option>
                            <option value="GAYAS, PRISCILLA B.">GAYAS, PRISCILLA B.</option>
                            <option value="NAVARRO, CHRISTINE A.">NAVARRO, CHRISTINE A.</option>
                            <option value="SAROMINES, KISSYLEN G.">SAROMINES, KISSYLEN G.</option>
                            <option value="SERINAS, KATRINA MAE CELESTE G.">SERINAS, KATRINA MAE CELESTE G.</option>
                            <option value="SOON, CHEYENNE S.">SOON, CHEYENNE S.</option>
                            <option value="TECSON, GERARD RANDOLF G.">TECSON, GERARD RANDOLF G.</option>
                            <option value="DAMOLO, JAMINEL A.">DAMOLO, JAMINEL A.</option>
                            <!-- FASD -->
                            <option value="AKIATAN, JOSEPHINE F.">AKIATAN, JOSEPHINE F.</option>
                            <option value="ALCERA, RIVA JANE D.">ALCERA, RIVA JANE D.</option>
                            <option value="DALIGDIG, ALEXANDER A.">DALIGDIG, ALEXANDER A.</option>
                            <option value="MACACHOR, DONNE MAR L.">MACACHOR, DONNE MAR L.</option>
                            <option value="MOLDE, MARK ERVIN D.">MOLDE, MARK ERVIN D.</option>
                            <option value="PARBA, MARLOU G.">PARBA, MARLOU G.</option>
                            <option value="RECESIO, LIRA M.">RECESIO, LIRA M.</option>
                            <option value="VASQUEZ, IVY MICHELLE T.">VASQUEZ, IVY MICHELLE T.</option>
                            <option value="VERDEFLOR, JASMIN S.">VERDEFLOR, JASMIN S.</option>
                            <!-- ORD -->
                            <option value="Gamaliel B. Vicente, Jr. CESO III, ASEAN ENG.">Gamaliel B. Vicente, Jr. CESO III, ASEAN ENG.</option>
                            <option value="Alexander A. Daligdig">Alexander A. Daligdig</option>
                            <option value="Marlou G. Parba">Marlou G. Parba</option>
                            <option value="Others">Other (Please specify)</option>
                        </select>
                        <div id="authorFocal-other-wrapper" class="hidden relative">
                            <input type="text" id="authorFocal-other" name="authorFocal-other" placeholder="Enter custom Author/Focal" class="block w-full border border-gray-300 rounded-lg shadow-md py-2.5 pl-3 pr-3 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200 text-base" />
                            <button type="button" id="authorFocal-back-btn" class="absolute right-2 top-1/2 -translate-y-1/2 text-xs text-primary-600 hover:underline focus:outline-none">Back to Select</button>
                        </div>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                            <i data-lucide="chevron-down" class="h-4 w-4"></i>
                        </div>
                    </div>
                `;
                // Re-initialize Lucide icons if needed
                if (window.lucide) lucide.createIcons();
            }

            // Author/Focal dropdown logic for 'Others'
            const authorFocalSelect = document.getElementById('authorFocal');
            const authorFocalOtherInput = document.getElementById('authorFocal-other');
            const authorFocalOtherWrapper = document.getElementById('authorFocal-other-wrapper');
            const authorFocalBackBtn = document.getElementById('authorFocal-back-btn');

            if (authorFocalSelect && authorFocalOtherInput && authorFocalOtherWrapper && authorFocalBackBtn) {
                authorFocalSelect.addEventListener('change', function() {
                    if (this.value === 'Others') {
                        authorFocalSelect.classList.add('hidden');
                        authorFocalOtherWrapper.classList.remove('hidden');
                        authorFocalOtherInput.setAttribute('required', 'required');
                        authorFocalOtherInput.focus();
                    } else {
                        authorFocalOtherInput.classList.add('hidden');
                        authorFocalOtherInput.removeAttribute('required');
                        authorFocalOtherWrapper.classList.add('hidden');
                        authorFocalSelect.classList.remove('hidden');
                    }
                });

                authorFocalOtherInput.addEventListener('blur', function() {
                    setTimeout(() => {
                        if (authorFocalOtherInput.value.trim() === '') {
                            authorFocalOtherInput.classList.add('hidden');
                            authorFocalOtherInput.removeAttribute('required');
                            authorFocalOtherWrapper.classList.add('hidden');
                            authorFocalSelect.classList.remove('hidden');
                            authorFocalSelect.value = '';
                        }
                    }, 100);
                });

                authorFocalBackBtn.addEventListener('click', function() {
                    authorFocalOtherInput.classList.add('hidden');
                    authorFocalOtherInput.removeAttribute('required');
                    authorFocalOtherWrapper.classList.add('hidden');
                    authorFocalSelect.classList.remove('hidden');
                    authorFocalSelect.value = '';
                    authorFocalSelect.focus();
                });
            }
        });

        // Antedation event listeners
        isAntedatedToggle.addEventListener('change', function() {
            isAntedated = this.checked;
            if (isAntedated) {
                antedationDateContainer.classList.remove('hidden');
                antedationDateInput.setAttribute('required', 'required');
                antedationIndicator.classList.remove('hidden');
                // Set max date to yesterday
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                antedationDateInput.max = yesterday.toISOString().split('T')[0];
                
                // Set initial memo number display
                if (memoTypeSelect.value) {
                    assignedMemoNumber.textContent = 'Select antedation date';
                } else {
                    assignedMemoNumber.textContent = 'Select memo type first';
                }
            } else {
                antedationDateContainer.classList.add('hidden');
                antedationDateInput.removeAttribute('required');
                antedationDateInput.value = '';
                antedationDate = null;
                antedationIndicator.classList.add('hidden');
                
                // Return to normal memo number display
                updateMemoNumberDisplay();
            }
        });

        antedationDateInput.addEventListener('change', function() {
            antedationDate = this.value;
            
            // Validate that the date is not in the future
            const selectedDate = new Date(antedationDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (selectedDate >= today) {
                errorMessage.querySelector('p').textContent = 'Antedation date must be in the past';
                errorMessage.classList.remove('hidden');
                this.value = '';
                antedationDate = null;
                assignedMemoNumber.textContent = 'Select antedation date';
                return;
            }
            
            errorMessage.classList.add('hidden');
            
            // Only generate memo number if both type and date are selected
            if (memoTypeSelect.value) {
                updateMemoNumberDisplay();
            } else {
                assignedMemoNumber.textContent = 'Select memo type first';
            }
        });

        // Function to get the next antedated memo number (A-Z only, error if all used)
        async function getNextAntedatedMemoNumber(memoType, selectedDate) {
            try {
                const departmentCode = JSON.parse(localStorage.getItem('tesdaUser')).department.substring(0, 3).toUpperCase();
                const year = new Date(selectedDate).getFullYear();
                // --- 1. Query Firebase for memos for this type and date ---
                const q = query(
                    collection(db, "memos"),
                    where("memoType", "==", memoType)
                );
                const querySnapshot = await getDocs(q);
                // --- 2. Gather memos from Firebase ---
                const firebaseMemosForDate = querySnapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(memo => {
                        // Only include memos of the same type AND same date
                        const memoDate = memo.antedationDate || (memo.createdAt && memo.createdAt.toDate ? memo.createdAt.toDate().toISOString().split('T')[0] : null);
                        return memoDate === selectedDate && memo.memoType === memoType;
                    });
                // --- 3. Gather memos from old system JSON cache ---
                let oldMemosForDate = [];
                if (oldMemoLoaded) {
                    // Search all cached old memos for this type and date
                    for (const year of OLD_JSON_YEARS) {
                        const data = window.oldSystemRawData && window.oldSystemRawData[year];
                        if (!data) continue;
                        // Flatten all department arrays
                        let records = [];
                        if (Array.isArray(data)) {
                            records = data;
                        } else if (typeof data === 'object' && data !== null) {
                            Object.values(data).forEach(arr => {
                                if (Array.isArray(arr)) records = records.concat(arr);
                            });
                        }
                        for (const rec of records) {
                            // Only match if date and type match
                            const dateIssued = rec["Date Issued"] ? new Date(rec["Date Issued"]) : null;
                            if (!dateIssued) continue;
                            const dateStr = dateIssued.toISOString().split('T')[0];
                            // Memo type is not always present in old system, so we match by year and date only
                            if (dateStr === selectedDate) {
                                oldMemosForDate.push(rec);
                            }
                        }
                    }
                }
                // --- 4. Combine all memos for this date ---
                const allMemosForDate = [
                    ...firebaseMemosForDate.map(m => ({ memoNumber: m.memoNumber })),
                    ...oldMemosForDate.map(m => ({ memoNumber: m["Memo No."] }))
                ];
                // --- 5. Extract base numbers and suffixes ---
                const baseNumberMap = {};
                allMemosForDate.forEach(memo => {
                    if (!memo.memoNumber) return;
                    const parts = String(memo.memoNumber).split('-');
                    let base, lastPart;
                    if (parts.length > 1) {
                        base = parts.slice(0, -1).join('-');
                        lastPart = parts[parts.length - 1];
                    } else {
                        // Old system: may be just a number or number+suffix
                        const match = String(memo.memoNumber).match(/^(\d+)(?:-([A-Z]+))?$/);
                        if (match) {
                            base = match[1];
                            lastPart = match[2] || 'BASE';
                        } else {
                            base = String(memo.memoNumber);
                            lastPart = 'BASE';
                        }
                    }
                    if (!baseNumberMap[base]) baseNumberMap[base] = [];
                    baseNumberMap[base].push(lastPart);
                });
                // --- 6. Find the highest base number (numeric part) ---
                let highestBase = null;
                let highestNum = -1;
                Object.keys(baseNumberMap).forEach(baseNum => {
                    // baseNum: could be PO-2025-DEP-1554 or just 1554
                    const numPart = parseInt(baseNum.split('-').pop());
                    if (numPart > highestNum) {
                        highestNum = numPart;
                        highestBase = baseNum;
                    }
                });
                if (!highestBase) {
                    // No memos for this date/type, start with 0001
                    return `${memoType}-${year}-${departmentCode}-0001`;
                }
                // --- 7. Assign next available suffix ---
                const usedSuffixes = baseNumberMap[highestBase] || [];
                // If only 'BASE' is present, no antedated memos yet, so assign -A
                if (usedSuffixes.length === 1 && usedSuffixes[0] === 'BASE') {
                    return `${memoType}-${year}-${departmentCode}-${String(highestNum).padStart(4, '0')}-A`;
                } else {
                    // Find next available suffix A-Z
                    const suffixes = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
                    for (let i = 0; i < suffixes.length; i++) {
                        if (!usedSuffixes.includes(suffixes[i])) {
                            return `${memoType}-${year}-${departmentCode}-${String(highestNum).padStart(4, '0')}-${suffixes[i]}`;
                        }
                    }
                    // All suffixes used
                    throw new Error(`No more antedation suffixes available for #${highestNum} on ${selectedDate}.`);
                }
            } catch (error) {
                console.error('Error getting next antedated memo number:', error);
                throw error;
            }
        }

        // Update memo number display based on antedation state
        async function updateMemoNumberDisplay() {
            if (isAntedated && antedationDate && memoTypeSelect.value) {
                try {
                    // Show loading state for antedated memo number
                    assignedMemoNumber.innerHTML = '<span class="text-gray-500">Calculating...</span>';
                    
                    const generatedMemoNo = await getNextAntedatedMemoNumber(memoTypeSelect.value, antedationDate);
                    const memoNumberPart = generatedMemoNo.split('-').pop();
                    
                    // Check if it has a suffix (A, B, C, etc.)
                    const hasSuffix = /[A-Z]+$/.test(memoNumberPart);
                    
                    if (hasSuffix) {
                        // Split the number and suffix for better display
                        const match = memoNumberPart.match(/^(\d+)([A-Z]+)$/);
                        if (match) {
                            const number = match[1];
                            const suffix = match[2];
                            assignedMemoNumber.innerHTML = `${number}<span class="text-primary-600 font-bold">-${suffix}</span>`;
                        } else {
                            assignedMemoNumber.textContent = memoNumberPart;
                        }
                    } else {
                        assignedMemoNumber.textContent = memoNumberPart;
                    }
                } catch (error) {
                    console.error('Error updating antedated memo number:', error);
                    assignedMemoNumber.innerHTML = '<span class="text-red-500">Error calculating number</span>';
                }
            } else if (isAntedated && !antedationDate) {
                // Antedation is enabled but no date selected yet
                assignedMemoNumber.innerHTML = '<span class="text-gray-500">Select antedation date</span>';
            } else if (isAntedated && !memoTypeSelect.value) {
                // Antedation is enabled but no memo type selected yet
                assignedMemoNumber.innerHTML = '<span class="text-gray-500">Select memo type first</span>';
            } else {
                // Use normal memo number logic
                updateMemoNumberFromFirebase();
            }
        }

        // Handle form submission
        memoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                // Show loading overlay
                loadingOverlay.classList.remove('hidden');
                errorMessage.classList.add('hidden');
                successMessage.classList.add('hidden');

                // Validate antedation
                if (isAntedated && !antedationDate) {
                    throw new Error('Please select an antedation date');
                }

                // Validate antedation against old system
                if (isAntedated && oldMemoLoaded) {
                    let memoNo = null;
                    if (memoNumberInputContainer && !memoNumberInputContainer.classList.contains('hidden')) {
                        memoNo = memoNumberInput.value.trim();
                    } else {
                        memoNo = assignedMemoNumber.textContent.trim();
                    }
                    const antedationCheck = checkAntedationOldSystem(memoNo, antedationDate);
                    if (antedationCheck && antedationCheck.antedated) {
                        throw new Error(`Antedated: This Memo No. was already issued on ${antedationCheck.oldDate.toLocaleDateString()} in the old system.`);
                    }
                }

                // Get current user
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    throw new Error('User not authenticated');
                }

                // Get form data
                const formData = new FormData(memoForm);
                const userData = JSON.parse(localStorage.getItem('tesdaUser'));
                if (!userData) {
                    throw new Error('User data not found');
                }

                // Get memo type and generate memo number
                const memoType = formData.get('memoType');
                let generatedMemoNo;

                // Check if admin has provided a custom memo number
                if (isAdmin && customMemoNumber) {
                    generatedMemoNo = customMemoNumber;
                } else if (isAntedated && antedationDate) {
                    // Generate antedated memo number
                    generatedMemoNo = await getNextAntedatedMemoNumber(memoType, antedationDate);
                } else {
                    // Get the next normal memo number (but do NOT increment yet)
                    let memoNumberKey;
                    switch (memoType) {
                        case 'PO':
                            memoNumberKey = 'current';
                            break;
                        case 'CO':
                            memoNumberKey = 'coCurrent';
                            break;
                        case 'Office Order':
                            memoNumberKey = 'officeOrder';
                            break;
                        case 'AdvisoryBulletin':
                            memoNumberKey = 'advisoryBulletin';
                            break;
                        case 'Bulletin':
                            memoNumberKey = 'bulletin';
                            break;
                        case 'Acknowledgment':
                            memoNumberKey = 'acknowledgment';
                            break;
                        default:
                            throw new Error('Unknown memo type');
                    }
                    const memoNumberRef = doc(db, "memoNumbers", memoNumberKey);
                    // Get the current number (do not increment yet)
                    const memoNumberSnap = await memoNumberRef.get ? await memoNumberRef.get() : await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js').then(m => m.getDoc(memoNumberRef));
                    let currentNumber = 1;
                    if (memoNumberSnap.exists()) {
                        currentNumber = memoNumberSnap.data().number;
                    }
                    // Get department code (first 3 letters of department)
                    const departmentCode = userData.department.substring(0, 3).toUpperCase();
                    const currentYear = new Date().getFullYear();
                    generatedMemoNo = `${memoType}-${currentYear}-${departmentCode}-${String(currentNumber).padStart(4, '0')}`;
                }

                // Determine recipients value
                let recipientsValue = '';
                if (recipientsSelect && !recipientsSelect.classList.contains('hidden')) {
                    recipientsValue = formData.get('recipients');
                } else if (recipientsOtherInput) {
                    recipientsValue = recipientsOtherInput.value.trim();
                }

                // Determine signatory value
                let signatoryValue = '';
                const signatorySelect = document.getElementById('signatory');
                const signatoryOtherInput = document.getElementById('signatory-other');
                if (signatorySelect && signatoryOtherInput) {
                    if (!signatorySelect.classList.contains('hidden')) {
                        signatoryValue = formData.get('signatory');
                    } else {
                        signatoryValue = signatoryOtherInput.value.trim();
                    }
                } else {
                    // fallback: try to get from formData
                    signatoryValue = formData.get('signatory') || '';
                }

                // Determine authorFocal value
                let authorFocalValue = '';
                const authorFocalSelect = document.getElementById('authorFocal');
                const authorFocalOtherInput = document.getElementById('authorFocal-other');
                if (authorFocalSelect && authorFocalOtherInput) {
                    if (!authorFocalSelect.classList.contains('hidden')) {
                        authorFocalValue = formData.get('authorFocal');
                    } else {
                        authorFocalValue = authorFocalOtherInput.value.trim();
                    }
                } else {
                    // fallback: try to get from formData
                    authorFocalValue = formData.get('authorFocal') || '';
                }

                // Create memo data object with the assigned number
                const memoData = {
                    title: formData.get('title'),
                    description: formData.get('description'),
                    department: userData.department,
                    recipients: recipientsValue ? [recipientsValue] : [],
                    authorFocal: authorFocalValue,
                    signatory: signatoryValue,
                    createdBy: userData.username,
                    memoType: memoType,
                    memoNumber: generatedMemoNo,
                    isAntedated: isAntedated,
                    antedationDate: isAntedated ? antedationDate : null,
                    createdAt: isAntedated ? new Date(antedationDate + 'T12:00:00') : new Date()
                };

                // Create memo
                const memoRef = await createMemo(memoData);
                
                // Only increment the normal memo number counter if this is NOT an antedated memo AND NOT a custom admin memo
                if (!isAntedated && !(isAdmin && customMemoNumber)) {
                    // Get the memo number key for normal memos
                    let memoNumberKey;
                    switch (memoType) {
                        case 'PO':
                            memoNumberKey = 'current';
                            break;
                        case 'CO':
                            memoNumberKey = 'coCurrent';
                            break;
                        case 'Office Order':
                            memoNumberKey = 'officeOrder';
                            break;
                        case 'AdvisoryBulletin':
                            memoNumberKey = 'advisoryBulletin';
                            break;
                        case 'Bulletin':
                            memoNumberKey = 'bulletin';
                            break;
                        case 'Acknowledgment':
                            memoNumberKey = 'acknowledgment';
                            break;
                        default:
                            throw new Error('Unknown memo type');
                    }
                    const memoNumberRef = doc(db, "memoNumbers", memoNumberKey);
                    const currentNumber = parseInt(generatedMemoNo.split('-').pop());
                    await updateDoc(memoNumberRef, { number: currentNumber + 1 });
                }
                
                // Log the memo creation
                const actionText = isAntedated ? 
                    `Created Antedated Memo ${generatedMemoNo} (dated ${antedationDate})` : 
                    `Created Memo ${generatedMemoNo}`;
                await logMemoActivity(
                    memoRef.id,
                    actionText,
                    userData.username
                );

                // Show success modal with memo number
                showSuccessModal(generatedMemoNo, userData.department);

                // Reset form
                memoForm.reset();
                isAntedated = false;
                antedationDate = null;
                antedationDateContainer.classList.add('hidden');
                antedationIndicator.classList.add('hidden');
                assignedMemoNumber.textContent = 'Select memo type first';

            } catch (error) {
                console.error('Error creating memo:', error);
                errorMessage.querySelector('p').textContent = error.message || 'Error creating memo. Please try again.';
                errorMessage.classList.remove('hidden');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        });

        // Success Modal Functions
        let countdownInterval;
        let redirectTimeout;

        function showSuccessModal(memoNumber, userDepartment) {
            const modalContent = successModal.querySelector('div');
            
            // Set memo number
            modalMemoNumber.textContent = memoNumber;
            
            // Show modal with animation
            successModal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
            
            // Start countdown
            let countdown = 10;
            countdownElement.textContent = countdown;
            
            countdownInterval = setInterval(() => {
                countdown--;
                countdownElement.textContent = countdown;
                
                // Add pulse animation to countdown
                countdownElement.classList.add('countdown-pulse');
                setTimeout(() => {
                    countdownElement.classList.remove('countdown-pulse');
                }, 1000);
                
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    redirectToDashboard(userDepartment);
                }
            }, 1000);
            
            // Set auto-redirect timeout
            redirectTimeout = setTimeout(() => {
                redirectToDashboard(userDepartment);
            }, 10000);
        }

        function hideSuccessModal() {
            const modalContent = successModal.querySelector('div');
            
            // Hide modal with animation
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                successModal.classList.add('hidden');
            }, 300);
            
            // Clear timers
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            if (redirectTimeout) {
                clearTimeout(redirectTimeout);
            }
        }

        function redirectToDashboard(userDepartment) {
            hideSuccessModal();
            window.location.href = userDepartment === 'ORD' ? 'ord-dashboard.html' : 'user-dashboard.html';
        }

        // Modal event listeners
        continueBtn.addEventListener('click', () => {
            const userData = JSON.parse(localStorage.getItem('tesdaUser'));
            redirectToDashboard(userData.department);
        });

        createAnotherBtn.addEventListener('click', () => {
            hideSuccessModal();
            // Form is already reset, just scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard support for modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !successModal.classList.contains('hidden')) {
                hideSuccessModal();
            }
        });

        // Close modal when clicking outside
        successModal.addEventListener('click', (e) => {
            if (e.target === successModal) {
                hideSuccessModal();
            }
        });

        // Cleanup function
        function cleanup() {
            if (poUnsubscribe) poUnsubscribe();
            if (coUnsubscribe) coUnsubscribe();
        }

        // Add cleanup on page unload
        window.addEventListener('beforeunload', cleanup);

        // Add character counter for description
        const descriptionTextarea = document.getElementById('description');
        const descriptionCharCount = document.getElementById('descriptionCharCount');

        descriptionTextarea.addEventListener('input', function() {
            let currentLength = this.value.length;
            if (currentLength > 300) {
                this.value = this.value.slice(0, 300);
                currentLength = 300;
            }
            descriptionCharCount.textContent = currentLength;
            // Add visual feedback when approaching limit
            if (currentLength >= 290) {
                descriptionCharCount.classList.add('text-red-500');
            } else {
                descriptionCharCount.classList.remove('text-red-500');
            }
        });

        // Add character counter for title
        const titleInput = document.getElementById('title');
        const titleCharCount = document.getElementById('titleCharCount');
        titleInput.addEventListener('input', function() {
            let currentLength = this.value.length;
            if (currentLength > 200) {
                this.value = this.value.slice(0, 200);
                currentLength = 200;
            }
            titleCharCount.textContent = currentLength;
            if (currentLength >= 190) {
                titleCharCount.classList.add('text-red-500');
            } else {
                titleCharCount.classList.remove('text-red-500');
            }
        });

        // Add this helper function for logging memo activity
        async function logMemoActivity(memoId, action, username) {
            try {
                const activityRef = doc(collection(db, "memoActivities"));
                await setDoc(activityRef, {
                    memoId: memoId,
                    action: action,
                    username: username,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error('Error logging memo activity:', error);
            }
        }

        recipientsSelect.addEventListener('change', function() {
            if (this.value === 'Others') {
                recipientsSelect.classList.add('hidden');
                recipientsOtherWrapper.classList.remove('hidden');
                recipientsOtherInput.setAttribute('required', 'required');
                recipientsOtherInput.focus();
            } else {
                recipientsOtherInput.classList.add('hidden');
                recipientsOtherInput.removeAttribute('required');
                recipientsOtherWrapper.classList.add('hidden');
                recipientsSelect.classList.remove('hidden');
            }
        });

        // If user focuses out of the input and it's empty, revert to dropdown
        recipientsOtherInput.addEventListener('blur', function() {
            setTimeout(() => { // Delay to allow button click
                if (recipientsOtherInput.value.trim() === '') {
                    recipientsOtherInput.classList.add('hidden');
                    recipientsOtherInput.removeAttribute('required');
                    recipientsOtherWrapper.classList.add('hidden');
                    recipientsSelect.classList.remove('hidden');
                    recipientsSelect.value = '';
                }
            }, 100);
        });

        // Back to Select button
        recipientsBackBtn.addEventListener('click', function() {
            recipientsOtherInput.classList.add('hidden');
            recipientsOtherInput.removeAttribute('required');
            recipientsOtherWrapper.classList.add('hidden');
            recipientsSelect.classList.remove('hidden');
            recipientsSelect.value = '';
            recipientsSelect.focus();
        });

        const signatorySelect = document.getElementById('signatory');
        const signatoryOtherInput = document.getElementById('signatory-other');
        const signatoryOtherWrapper = document.getElementById('signatory-other-wrapper');
        const signatoryBackBtn = document.getElementById('signatory-back-btn');

        if (signatorySelect) {
            signatorySelect.addEventListener('change', function() {
                if (this.value === 'Others') {
                    signatorySelect.classList.add('hidden');
                    signatoryOtherWrapper.classList.remove('hidden');
                    signatoryOtherInput.setAttribute('required', 'required');
                    signatoryOtherInput.focus();
                } else {
                    signatoryOtherInput.classList.add('hidden');
                    signatoryOtherInput.removeAttribute('required');
                    signatoryOtherWrapper.classList.add('hidden');
                    signatorySelect.classList.remove('hidden');
                }
            });
        }

        signatoryOtherInput.addEventListener('blur', function() {
            setTimeout(() => {
                if (signatoryOtherInput.value.trim() === '') {
                    signatoryOtherInput.classList.add('hidden');
                    signatoryOtherInput.removeAttribute('required');
                    signatoryOtherWrapper.classList.add('hidden');
                    signatorySelect.classList.remove('hidden');
                    signatorySelect.value = '';
                }
            }, 100);
        });

        signatoryBackBtn.addEventListener('click', function() {
            signatoryOtherInput.classList.add('hidden');
            signatoryOtherInput.removeAttribute('required');
            signatoryOtherWrapper.classList.add('hidden');
            signatorySelect.classList.remove('hidden');
            signatorySelect.value = '';
            signatorySelect.focus();
        });

        // Check user role and setup admin functionality
        function checkUserRole() {
            const userData = JSON.parse(localStorage.getItem('tesdaUser'));
            if (userData && (userData.role === 'Administrator' || userData.role === 'admin')) {
                isAdmin = true;
                // Show edit button and admin badge for admins
                editMemoNumberBtn.classList.remove('hidden');
                adminBadge.classList.remove('hidden');
            }
        }

        // Admin memo number editing functionality
        editMemoNumberBtn.addEventListener('click', function() {
            if (!isAdmin) return;
            
            // Show input container
            memoNumberInputContainer.classList.remove('hidden');
            memoNumberInput.value = assignedMemoNumber.textContent;
            memoNumberInput.focus();
        });

        saveMemoNumberBtn.addEventListener('click', function() {
            if (!isAdmin) return;
            
            const newMemoNumber = memoNumberInput.value.trim();
            if (newMemoNumber) {
                customMemoNumber = newMemoNumber;
                assignedMemoNumber.textContent = newMemoNumber;
                memoNumberInputContainer.classList.add('hidden');
                // Show success indicator
                assignedMemoNumber.classList.add('text-green-600');
                setTimeout(() => {
                    assignedMemoNumber.classList.remove('text-green-600');
                }, 2000);
            }
        });

        cancelMemoNumberBtn.addEventListener('click', function() {
            if (!isAdmin) return;
            
            memoNumberInputContainer.classList.add('hidden');
            memoNumberInput.value = '';
            customMemoNumber = null;
        });

        // Initialize role checking
        checkUserRole();

        // --- BEGIN: Old System Data Loader and Antedation Checker ---
        const OLD_JSON_YEARS = [2020, 2021, 2022, 2023, 2024, 2025];
        const oldMemoCache = {};
        let oldMemoLoaded = false;

        async function loadOldSystemData() {
            const promises = OLD_JSON_YEARS.map(year => fetch(`oldsystem/${year}.json`).then(r => r.json().catch(() => null)));
            const allData = await Promise.all(promises);
            for (let i = 0; i < OLD_JSON_YEARS.length; i++) {
                const year = OLD_JSON_YEARS[i];
                const data = allData[i];
                if (!data) continue;
                // If data is grouped by department, flatten
                let records = [];
                if (Array.isArray(data)) {
                    records = data;
                } else if (typeof data === 'object' && data !== null) {
                    Object.values(data).forEach(arr => {
                        if (Array.isArray(arr)) records = records.concat(arr);
                    });
                }
                for (const rec of records) {
                    // Memo No. may be a number or string
                    const memoNo = String(rec["Memo No."]).trim();
                    const dateIssued = rec["Date Issued"] ? new Date(rec["Date Issued"]) : null;
                    if (memoNo && dateIssued) {
                        // Only keep the earliest date for each Memo No.
                        if (!oldMemoCache[memoNo] || oldMemoCache[memoNo] > dateIssued) {
                            oldMemoCache[memoNo] = dateIssued;
                        }
                    }
                }
            }
            oldMemoLoaded = true;
        }
        // Start loading old data ASAP
        loadOldSystemData();

        // Helper: check if a memo is antedated compared to old system
        function checkAntedationOldSystem(memoNo, userDateIssued) {
            if (!oldMemoLoaded) return null; // Not ready
            const oldDate = oldMemoCache[String(memoNo).trim()];
            if (!oldDate) return null; // Not found in old system
            const userDate = new Date(userDateIssued);
            if (isNaN(userDate.getTime())) return null;
            // If user date is before old date, it's antedated
            if (userDate < oldDate) return { antedated: true, oldDate };
            return { antedated: false, oldDate };
        }
        // --- END: Old System Data Loader and Antedation Checker ---

        // Add this after DOMContentLoaded or where Memo No. and Date Issued are input/selected
        // For this example, let's assume you have inputs with IDs 'memoNumberInput' and 'antedationDate' (already present)

        function updateAntedationVisualCue() {
            // Only run if both fields are present and loaded
            if (!oldMemoLoaded) return;
            let memoNo = null;
            let dateIssued = null;
            // Try to get from admin input, else from assignedMemoNumber
            if (memoNumberInputContainer && !memoNumberInputContainer.classList.contains('hidden')) {
                memoNo = memoNumberInput.value.trim();
            } else {
                memoNo = assignedMemoNumber.textContent.trim();
            }
            dateIssued = antedationDateInput.value;
            if (!memoNo || !dateIssued) {
                antedationDateInput.classList.remove('border-red-500');
                antedationDateInput.title = '';
                return;
            }
            const result = checkAntedationOldSystem(memoNo, dateIssued);
            if (result && result.antedated) {
                antedationDateInput.classList.add('border-red-500');
                antedationDateInput.title = `Antedated: Old system has this Memo No. issued on ${result.oldDate.toLocaleDateString()}`;
            } else {
                antedationDateInput.classList.remove('border-red-500');
                antedationDateInput.title = '';
            }
        }
        // Hook up to relevant events
        if (antedationDateInput) {
            antedationDateInput.addEventListener('input', updateAntedationVisualCue);
        }
        if (memoNumberInput) {
            memoNumberInput.addEventListener('input', updateAntedationVisualCue);
        }
        // Also call after memo number is assigned/generated
        memoTypeSelect.addEventListener('change', () => setTimeout(updateAntedationVisualCue, 200));
    </script>
</body>
</html>
