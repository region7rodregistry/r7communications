<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - TESDA MBMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="icon" type="image/png" href="icons/t7logo.png">
    <script type="module" src="firebase-config.js"></script>
    <style>
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        @keyframes slideOut {
            from { transform: translateX(0); }
            to { transform: translateX(100%); }
        }
        .toast-enter {
            animation: slideIn 0.3s ease-out forwards;
        }
        .toast-exit {
            animation: slideOut 0.3s ease-in forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-enter {
            animation: fadeIn 0.2s ease-out forwards;
        }
        /* Add new animations for stats cards */
        @keyframes fadeSlideIn {
            from { 
                opacity: 0;
                transform: translateY(-20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes fadeSlideOut {
            from { 
                opacity: 1;
                transform: translateY(0);
            }
            to { 
                opacity: 0;
                transform: translateY(-20px);
            }
        }
        .stats-enter {
            animation: fadeSlideIn 0.3s ease-out forwards;
        }
        .stats-exit {
            animation: fadeSlideOut 0.3s ease-in forwards;
        }

        /* Responsive styles */
        @media (max-width: 1024px) {
            .max-w-7xl {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            
            #statsCards {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .header-actions {
                width: 100%;
                justify-content: space-between;
            }

            .search-container {
                width: 100%;
                margin-top: 1rem;
            }

            #searchInput {
                width: 100%;
            }

            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .table-responsive {
                min-width: 800px;
            }

            .action-buttons {
                flex-direction: column;
                gap: 0.5rem;
            }

            .action-buttons button {
                width: 100%;
            }
        }

        @media (max-width: 640px) {
            #statsCards {
                grid-template-columns: 1fr;
            }

            .header-content {
                text-align: center;
            }

            .header-actions {
                flex-direction: column;
                align-items: center;
            }

            .tab-container {
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .tab-buttons {
                min-width: 300px;
            }
        }

        /* Add styles for resizable rows */
        .resizable-row {
            position: relative;
            transition: height 0.3s ease-in-out;
        }
        .resize-handle {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 5px;
            cursor: row-resize;
            background: transparent;
            transition: background 0.2s;
            display: none; /* Hidden by default */
        }
        .log-sheet-preview .resize-handle {
            display: block; /* Show only in log sheet preview mode */
        }
        .resize-handle:hover {
            background: #3b82f6;
        }
        .resize-handle.active {
            background: #3b82f6;
        }
        /* Force row height in log sheet preview mode */
        .log-sheet-preview tbody tr {
            height: 180px !important;
            min-height: 180px !important;
        }
        .log-sheet-preview tbody td {
            height: 180px !important;
            min-height: 180px !important;
            vertical-align: middle;
        }
        .compressed-subject {
            max-width: 300px;
            width: 300px;
            white-space: normal;
            overflow-wrap: break-word;
            word-break: break-word;
            text-overflow: ellipsis;
            overflow: hidden;
        }
        .log-sheet-preview .compressed-subject {
            max-width: 350px;
            width: 350px;
            white-space: normal;
            overflow-wrap: break-word;
            word-break: break-word;
            text-overflow: ellipsis;
            overflow: hidden;
        }
        /* Archive tab active state */
        .archive-tab-active {
            background-color: #18009e !important;
            color: #fff !important;
            font-weight: 700;
        }
        /* Custom scrollbar for archive tabs on mobile */
        #archiveTypeTabs::-webkit-scrollbar {
            height: 6px;
        }
        #archiveTypeTabs::-webkit-scrollbar-thumb {
            background: #bfdbfe;
            border-radius: 4px;
        }
        #archiveTypeTabs::-webkit-scrollbar-track {
            background: #f3f4f6;
            border-radius: 4px;
        }
        @media (max-width: 640px) {
            #archiveTypeTabs {
                margin-left: 0 !important;
                margin-right: 0 !important;
                padding-left: 0.25rem;
                padding-right: 0.25rem;
            }
            .archive-type-tab {
                font-size: 1rem;
                min-width: 110px;
                margin-left: 0.25rem;
                margin-right: 0.25rem;
                padding-left: 1.25rem;
                padding-right: 1.25rem;
                padding-top: 0.75rem;
                padding-bottom: 0.75rem;
            }
        }
        
        /* Table alignment fixes */
        table.min-w-full {
            table-layout: fixed;
        }
        
        table.min-w-full th,
        table.min-w-full td {
            vertical-align: top;
            text-align: left;
        }
        
        /* Ensure consistent padding across all table cells */
        table.min-w-full th {
            padding: 1rem 1.5rem;
        }
        
        table.min-w-full td {
            padding: 0.75rem 1.5rem;
        }
        
        /* Specific alignment for pending tab */
        .pending-tab-active table.min-w-full th,
        .pending-tab-active table.min-w-full td {
            padding: 0.75rem 1.5rem;
        }
        
        /* Ensure action buttons are properly aligned */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        /* Futuristic gradient border for modal */
        .futuristic-gradient {
            border-image: none;
        }
        #virtualFolderModal {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #virtualFolderModal .modal-bg {
            z-index: 0;
        }
        #virtualFolderModalContent {
            z-index: 10;
            background: #fff;
            color: #111;
            border-radius: 1rem;
            min-width: 320px;
            max-width: 95vw;
            min-height: 120px;
            max-height: 60vh;
            overflow-y: auto;
            resize: vertical;
            box-shadow: 0 8px 32px 0 rgba(30,58,138,0.18);
            transition: opacity 0.3s, transform 0.3s;
            opacity: 0;
            transform: scale(0.92);
            display: flex;
            flex-direction: column;
            position: relative;
        }
        #virtualFolderModal.show #virtualFolderModalContent {
            animation: popoutModal 0.35s cubic-bezier(0.23, 1, 0.32, 1);
            opacity: 1;
            transform: scale(1);
        }
        @keyframes popoutModal {
            0% {
                opacity: 0;
                transform: scale(0.85);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        #closeVirtualFolderModal {
            position: absolute;
            top: 0.5rem;
            right: 0.75rem;
            font-size: 1.5rem;
            color: #111;
            background: none;
            border: none;
            cursor: pointer;
            z-index: 20;
            transition: color 0.2s;
        }
        #closeVirtualFolderModal:hover {
            color: #1e3a8a;
        }
        #virtualFolderModalBody {
            padding-top: 1.5rem;
            padding-bottom: 0.5rem;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
            overflow-y: auto;
        }
        @media (max-width: 600px) {
            #virtualFolderModalContent {
                min-width: 90vw;
                max-width: 98vw;
                max-height: 80vh;
            }
        }
        /* Add Virtual Folder Modal for Archive Folders */
        #archiveFolderModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        #archiveFolderModal.show {
            opacity: 1;
            pointer-events: auto;
        }
        #archiveFolderModalContent {
            background-color: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: scale(0.95);
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
        }
        #archiveFolderModalContent.show {
            transform: scale(1);
            opacity: 1;
        }
        #closeArchiveFolderModal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            color: #333;
            background: none;
            border: none;
            cursor: pointer;
        }
        #archiveFolderModalBody {
            max-height: 300px;
            overflow-y: auto;
        }
        @keyframes fadeIn {
          from { opacity: 0; transform: scale(0.95); }
          to { opacity: 1; transform: scale(1); }
        }
        .animate-fadeIn {
          animation: fadeIn 0.4s cubic-bezier(0.23, 1, 0.32, 1) forwards;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <!-- Loading Modal Overlay -->
    <div id="loadingModal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl px-10 py-8 flex flex-col items-center animate-fadeIn">
            <div class="mb-6">
                <svg class="animate-spin h-12 w-12 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                </svg>
            </div>
            <div class="text-2xl font-bold text-gray-800 mb-2 tracking-wide">Loading Data Records . . .</div>
            <div class="text-gray-500 text-base">Please wait while we fetch the latest records for you.</div>
        </div>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="hidden fixed top-4 right-4 p-4 bg-red-50 border border-red-200 text-red-800 rounded-md shadow-lg z-50"></div>

    <!-- Success Toast -->
    <div id="successToast" class="hidden fixed top-4 right-4 p-4 bg-green-50 border border-green-200 text-green-800 rounded-md shadow-lg z-50 flex items-center">
        <i data-lucide="check-circle" class="w-5 h-5 mr-2 text-green-600"></i>
        <span id="successMessage"></span>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 modal-enter">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Confirm Deletion</h3>
                    <button onclick="closeDeleteModal()" class="text-gray-400 hover:text-gray-500">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="mb-4">
                    <p class="text-sm text-gray-500">Please enter the admin password to confirm deletion:</p>
                </div>
                <div class="mb-4">
                    <input type="password" id="deletePassword" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                           placeholder="Enter admin password">
                    <p id="passwordError" class="hidden mt-2 text-sm text-red-600"></p>
                </div>
                <div class="flex justify-end space-x-3">
                    <button onclick="closeDeleteModal()" 
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                        Cancel
                    </button>
                    <button onclick="confirmDelete()" 
                            class="px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Change Modal -->
    <div id="statusModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 modal-enter">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Change Status</h3>
                    <button onclick="closeStatusModal()" class="text-gray-400 hover:text-gray-500">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="mb-4">
                    <p class="text-sm text-gray-500">Are you sure you want to change the status of this memo?</p>
                </div>
                <div class="mb-4">
                    <select id="newStatus" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="approved">Approved</option>
                        <option value="pending">Pending</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3">
                    <button onclick="closeStatusModal()" 
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                        Cancel
                    </button>
                    <button onclick="confirmStatusChange()" 
                            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Update Status
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-8xl mx-auto px-6 sm:px-8 lg:px-10 py-10">
        <!-- Header -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
            <div class="flex items-center">
                <img src="./icons/tlogo.png" alt="TESDA Logo" class="w-12 h-12 mr-3">
                <div>
                    <div class="flex items-center space-x-2">
                        <h1 id="pageHeader" class="text-2xl font-bold text-gray-900 cursor-pointer">TESDA Region VII - Records Unit</h1>
                        </button>
                    </div>
                    <p class="text-sm text-gray-500">Outgoing Communications</p>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4">
                <span id="userInfo" class="text-sm text-gray-600"></span>
                <button onclick="window.location.href='oldsystem/index.html'" id="viewOldRecords" class="w-full sm:w-auto inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-orange-500 hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-400">
                    <i data-lucide="view" class="w-4 h-4 mr-2"></i>
                    View Old Records
                </button>
                <button id="logoutBtn" class="w-full sm:w-auto inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    <i data-lucide="log-out" class="w-4 h-4 mr-2"></i>
                    Logout
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div id="statsCards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-blue-100 rounded-lg">
                        <i data-lucide="file-text" class="w-6 h-6 text-blue-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Documents</p>
                        <p id="totalMemos" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-yellow-100 rounded-lg">
                        <i data-lucide="clock" class="w-6 h-6 text-yellow-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Pending Memos</p>
                        <p id="pendingMemos" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-green-100 rounded-lg">
                        <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Approved Memos</p>
                        <p id="approvedMemos" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-gray-100 rounded-lg">
                        <i data-lucide="archive" class="w-6 h-6 text-gray-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Archived Memos</p>
                        <p id="archivedMemos" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-purple-100 rounded-lg">
                        <i data-lucide="hash" class="w-6 h-6 text-purple-600"></i>
                    </div>
                    <div class="ml-4 flex-grow">
                        <p class="text-sm font-medium text-gray-600">PO-Number</p>
                        <div class="flex items-center space-x-2">
                            <p id="nextMemoNumber" class="text-2xl font-bold text-gray-900">0000</p>
                            <button onclick="editMemoNumber('current')" class="text-blue-600 hover:text-blue-800">
                                <i data-lucide="edit-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div id="memoNumberEdit" class="hidden mt-2">
                            <input type="number" id="memoNumberInput" class="w-24 px-2 py-1 border rounded" min="0">
                            <button onclick="saveMemoNumber('current')" class="ml-2 text-green-600 hover:text-green-800">
                                <i data-lucide="check" class="w-4 h-4"></i>
                            </button>
                            <button onclick="cancelMemoNumberEdit()" class="ml-1 text-red-600 hover:text-red-800">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-indigo-100 rounded-lg">
                        <i data-lucide="hash" class="w-6 h-6 text-indigo-600"></i>
                    </div>
                    <div class="ml-4 flex-grow">
                        <p class="text-sm font-medium text-gray-600">CO-Memo Number</p>
                        <div class="flex items-center space-x-2">
                            <p id="nextCoMemoNumber" class="text-2xl font-bold text-gray-900">0000</p>
                            <button onclick="editMemoNumber('coCurrent')" class="text-blue-600 hover:text-blue-800">
                                <i data-lucide="edit-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div id="coMemoNumberEdit" class="hidden mt-2">
                            <input type="number" id="coMemoNumberInput" class="w-24 px-2 py-1 border rounded" min="0">
                            <button onclick="saveMemoNumber('coCurrent')" class="ml-2 text-green-600 hover:text-green-800">
                                <i data-lucide="check" class="w-4 h-4"></i>
                            </button>
                            <button onclick="cancelMemoNumberEdit()" class="ml-1 text-red-600 hover:text-red-800">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Office Order - Number Card -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-pink-100 rounded-lg">
                        <i data-lucide="hash" class="w-6 h-6 text-pink-600"></i>
                    </div>
                    <div class="ml-4 flex-grow">
                        <p class="text-sm font-medium text-gray-600">Office Order - Number</p>
                        <div class="flex items-center space-x-2">
                            <p id="nextOfficeOrderNumber" class="text-2xl font-bold text-gray-900">0000</p>
                            <button onclick="editMemoNumber('officeOrder')" class="text-blue-600 hover:text-blue-800">
                                <i data-lucide="edit-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div id="officeOrderNumberEdit" class="hidden mt-2">
                            <input type="number" id="officeOrderNumberInput" class="w-24 px-2 py-1 border rounded" min="0">
                            <button onclick="saveMemoNumber('officeOrder')" class="ml-2 text-green-600 hover:text-green-800">
                                <i data-lucide="check" class="w-4 h-4"></i>
                            </button>
                            <button onclick="cancelMemoNumberEdit()" class="ml-1 text-red-600 hover:text-red-800">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Merge Advisory/Bulletin - Number Card -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-yellow-100 rounded-lg">
                        <i data-lucide="hash" class="w-6 h-6 text-yellow-600"></i>
                    </div>
                    <div class="ml-4 flex-grow">
                        <p class="text-sm font-medium text-gray-600">Advisory/Bulletin - Number</p>
                        <div class="flex items-center space-x-2">
                            <p id="nextAdvisoryBulletinNumber" class="text-2xl font-bold text-gray-900">0000</p>
                            <button onclick="editMemoNumber('advisoryBulletin')" class="text-blue-600 hover:text-blue-800">
                                <i data-lucide="edit-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div id="advisoryBulletinNumberEdit" class="hidden mt-2">
                            <input type="number" id="advisoryBulletinNumberInput" class="w-24 px-2 py-1 border rounded" min="0">
                            <button onclick="saveMemoNumber('advisoryBulletin')" class="ml-2 text-green-600 hover:text-green-800">
                                <i data-lucide="check" class="w-4 h-4"></i>
                            </button>
                            <button onclick="cancelMemoNumberEdit()" class="ml-1 text-red-600 hover:text-red-800">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-orange-100 rounded-lg">
                        <i data-lucide="award" class="w-6 h-6 text-orange-600"></i>
                    </div>
                    <div class="ml-4 flex-grow">
                        <p class="text-sm font-medium text-gray-600">Acknowledgment</p>
                        <div class="flex items-center space-x-2">
                            <p id="nextAcknowledgmentNumber" class="text-2xl font-bold text-gray-900">0000</p>
                            <button onclick="editMemoNumber('acknowledgment')" class="text-blue-600 hover:text-blue-800">
                                <i data-lucide="edit-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div id="acknowledgmentNumberEdit" class="hidden mt-2">
                            <input type="number" id="acknowledgmentNumberInput" class="w-24 px-2 py-1 border rounded" min="0">
                            <button onclick="saveMemoNumber('acknowledgment')" class="ml-2 text-green-600 hover:text-green-800">
                                <i data-lucide="check" class="w-4 h-4"></i>
                            </button>
                            <button onclick="cancelMemoNumberEdit()" class="ml-1 text-red-600 hover:text-red-800">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Memos Table -->
        <div class="bg-white shadow rounded-lg overflow-hidden">
            <div class="px-8 py-6 sm:px-10 border-b border-gray-200">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div class="flex items-center space-x-4 w-full sm:w-auto">
                        <div class="flex space-x-2 bg-gray-100 p-2 rounded-lg">
                            <button id="pendingMemosTab" class="px-6 py-3 text-sm font-medium rounded-md bg-white shadow-sm text-gray-900">
                                Pending Memos
                            </button>
                            <button id="approvedMemosTab" class="px-6 py-3 text-sm font-medium rounded-md text-gray-500 hover:text-gray-900">
                                Approved Memos
                            </button>
                            <button id="archiveMemosTab" class="px-6 py-3 text-sm font-medium rounded-md text-gray-500 hover:text-gray-900">
                                Archive
                            </button>
                            <button id="cancelledMemosTab" class="px-6 py-3 text-sm font-medium rounded-md text-gray-500 hover:text-gray-900">
                                Cancelled
                            </button>
                        </div>
                        <!-- Add Toggle Switch and Action Taken Input (hidden by default) -->
                        <div id="actionToggleContainer" class="flex items-center space-x-4 hidden">
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-600"></span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="actionToggle" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                                <span class="text-sm text-gray-600">Print Preview</span>
                            </div>
                            <div id="actionTakenInputContainer" class="hidden">
                                <input type="text" 
                                       id="actionTakenInput"
                                       class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 w-64"
                                       placeholder="Enter Series Number...">
                                <button id="applyActionTakenBtn" onclick="applyActionTaken()" 
                                        class="ml-2 px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                    Apply
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="relative w-full sm:w-auto">
                        <div class="relative">
                            <div class="flex items-center space-x-2">
                                <select id="searchFilter" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="all">All Fields</option>
                                    <option value="memoNumber">Memo Number</option>
                                    <option value="title">Subject</option>
                                    <option value="department">Department</option>
                                    <option value="recipients">Recipients</option>
                                    <option value="priority">Priority</option>
                                    <option value="status">Status</option>
                                </select>
                                <div class="relative flex-grow">
                                    <input type="text" id="searchInput" 
                                           class="w-full pl-4 pr-10 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                           placeholder="Search memos...">
                                    <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                                        <div id="searchSpinner" class="hidden animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                                        <button id="clearSearch" class="hidden text-gray-400 hover:text-gray-600">
                                            <i data-lucide="x" class="w-4 h-4"></i>
                                        </button>
                                        <i data-lucide="search" class="w-5 h-5 text-gray-400"></i>
                                    </div>
                                </div>
                            </div>
                            <div id="searchSuggestions" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto"></div>
                        </div>
                    </div>
                </div>
                <!-- Archive Memo Type Tabs (hidden by default, shown only on Archive tab) -->
                <div id="archiveTypeTabs" class="w-full overflow-x-auto whitespace-nowrap py-2 px-1 bg-gray-50 rounded-lg shadow-sm mt-4 hidden transition-all duration-300 scrollbar-thin scrollbar-thumb-blue-200 scrollbar-track-gray-100">
                    <div class="flex justify-between items-center">
                        <div class="flex">
                            <button data-type="All" class="archive-type-tab inline-block min-w-[110px] mx-1 px-5 py-2 text-base font-semibold rounded-full focus:outline-none transition-all duration-200 shadow-sm border border-transparent bg-blue-600 text-white archive-tab-active">All</button>
                            <button data-type="CO" class="archive-type-tab inline-block min-w-[110px] mx-1 px-5 py-2 text-base font-semibold rounded-full focus:outline-none transition-all duration-200 shadow-sm border border-transparent bg-gray-100 text-gray-700 hover:bg-blue-50 hover:text-blue-700">CO</button>
                            <button data-type="PO" class="archive-type-tab inline-block min-w-[110px] mx-1 px-5 py-2 text-base font-semibold rounded-full focus:outline-none transition-all duration-200 shadow-sm border border-transparent bg-gray-100 text-gray-700 hover:bg-blue-50 hover:text-blue-700">PO</button>
                            <button data-type="Office Order" class="archive-type-tab inline-block min-w-[110px] mx-1 px-5 py-2 text-base font-semibold rounded-full focus:outline-none transition-all duration-200 shadow-sm border border-transparent bg-gray-100 text-gray-700 hover:bg-blue-50 hover:text-blue-700">Office Order</button>
                            <button data-type="Advisory" class="archive-type-tab inline-block min-w-[110px] mx-1 px-5 py-2 text-base font-semibold rounded-full focus:outline-none transition-all duration-200 shadow-sm border border-transparent bg-gray-100 text-gray-700 hover:bg-blue-50 hover:text-blue-700">Advisory</button>
                            <button data-type="Bulletin" class="archive-type-tab inline-block min-w-[110px] mx-1 px-5 py-2 text-base font-semibold rounded-full focus:outline-none transition-all duration-200 shadow-sm border border-transparent bg-gray-100 text-gray-700 hover:bg-blue-50 hover:text-blue-700">Bulletin</button>
                            <button data-type="Acknowledgment" class="archive-type-tab inline-block min-w-[110px] mx-1 px-5 py-2 text-base font-semibold rounded-full focus:outline-none transition-all duration-200 shadow-sm border border-transparent bg-gray-100 text-gray-700 hover:bg-blue-50 hover:text-blue-700">Acknowledgment</button>
                        </div>
                        <div class="flex space-x-2 ml-4">
                            <button onclick="copyArchiveData()" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                Copy
                            </button>
                            <button onclick="exportArchiveData()" class="px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                                Export
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 hidden sm:table">
                    <thead id="memosTableHead" class="bg-gray-50 hidden sm:table-header-group"></thead>
                    <tbody id="memosTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Table rows will be populated dynamically -->
                    </tbody>
                </table>
                <!-- Responsive card container for mobile -->
                <div id="memosCardBody" class="block sm:hidden"></div>
                <!-- Pagination for Archive Tab -->
                <div id="archivePagination" class="flex justify-center mt-4"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { logoutUser, auth, deleteMemoFromFirestore, deleteActivityLogsForMemos, cleanupOrphanedActivityLogs } from './firebase-config.js';
        import { doc, updateDoc, serverTimestamp, collection, query, orderBy, deleteDoc, setDoc, getDocs, getDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        import { db } from './firebase-config.js';

        // Initialize Lucide icons
        lucide.createIcons();

        // Get DOM elements
        const errorMessage = document.getElementById('errorMessage');
        const successToast = document.getElementById('successToast');
        const successMessage = document.getElementById('successMessage');
        const deleteModal = document.getElementById('deleteModal');
        const deletePassword = document.getElementById('deletePassword');
        const passwordError = document.getElementById('passwordError');
        const memosTableBody = document.getElementById('memosTableBody');
        const userInfo = document.getElementById('userInfo');
        const logoutBtn = document.getElementById('logoutBtn');
        const totalMemos = document.getElementById('totalMemos');
        const pendingMemos = document.getElementById('pendingMemos');
        const approvedMemos = document.getElementById('approvedMemos');
        const archivedMemos = document.getElementById('archivedMemos');
        const searchInput = document.getElementById('searchInput');
        const searchFilter = document.getElementById('searchFilter');
        const searchSpinner = document.getElementById('searchSpinner');
        const clearSearch = document.getElementById('clearSearch');
        const searchSuggestions = document.getElementById('searchSuggestions');
        const loadingModal = document.getElementById('loadingModal');

        let currentMemoId = null;
        let allMemos = []; // Store all memos for filtering
        let currentView = 'pending'; // Track current view, default to 'pending'

        // Tab switching functionality
        const pendingMemosTab = document.getElementById('pendingMemosTab');
        const approvedMemosTab = document.getElementById('approvedMemosTab');
        const archiveMemosTab = document.getElementById('archiveMemosTab');
        const cancelledMemosTab = document.getElementById('cancelledMemosTab');
        const statsCards = document.getElementById('statsCards');
        const actionToggleContainer = document.getElementById('actionToggleContainer');

        function updateTabStyles() {
            // Show/hide stats cards and logsheet preview toggle based on tab
            if (currentView === 'approved') {
                if (statsCards) statsCards.classList.add('hidden');
                if (actionToggleContainer) actionToggleContainer.classList.remove('hidden');
            } else if (currentView === 'archive') {
                if (statsCards) statsCards.classList.add('hidden');
                if (actionToggleContainer) actionToggleContainer.classList.add('hidden');
            } else if (currentView === 'cancelled') {
                if (statsCards) statsCards.classList.add('hidden');
                if (actionToggleContainer) actionToggleContainer.classList.add('hidden');
            } else {
                if (statsCards) {
                    statsCards.classList.remove('hidden');
                    statsCards.classList.add('stats-enter');
                    statsCards.classList.remove('stats-exit');
                }
                if (actionToggleContainer) actionToggleContainer.classList.add('hidden');
            }
            
            // Remove highlight from all tabs first
            if (pendingMemosTab) {
                pendingMemosTab.classList.remove('bg-white', 'shadow-sm', 'text-gray-900');
                pendingMemosTab.classList.add('text-gray-500', 'hover:text-gray-900');
            }
            if (approvedMemosTab) {
                approvedMemosTab.classList.remove('bg-white', 'shadow-sm', 'text-gray-900');
                approvedMemosTab.classList.add('text-gray-500', 'hover:text-gray-900');
            }
            if (archiveMemosTab) {
                archiveMemosTab.classList.remove('bg-white', 'shadow-sm', 'text-gray-900');
                archiveMemosTab.classList.add('text-gray-500', 'hover:text-gray-900');
            }
            if (cancelledMemosTab) {
                cancelledMemosTab.classList.remove('bg-white', 'shadow-sm', 'text-gray-900');
                cancelledMemosTab.classList.add('text-gray-500', 'hover:text-gray-900');
            }

            // Add highlight to the active tab
            if (currentView === 'pending' && pendingMemosTab) {
                pendingMemosTab.classList.add('bg-white', 'shadow-sm', 'text-gray-900');
                pendingMemosTab.classList.remove('text-gray-500', 'hover:text-gray-900');
            } else if (currentView === 'approved' && approvedMemosTab) {
                approvedMemosTab.classList.add('bg-white', 'shadow-sm', 'text-gray-900');
                approvedMemosTab.classList.remove('text-gray-500', 'hover:text-gray-900');
            } else if (currentView === 'archive' && archiveMemosTab) {
                archiveMemosTab.classList.add('bg-white', 'shadow-sm', 'text-gray-900');
                archiveMemosTab.classList.remove('text-gray-500', 'hover:text-gray-900');
            } else if (currentView === 'cancelled' && cancelledMemosTab) {
                cancelledMemosTab.classList.add('bg-white', 'shadow-sm', 'text-gray-900');
                cancelledMemosTab.classList.remove('text-gray-500', 'hover:text-gray-900');
            }

            // Add/remove table container classes for styling
            const tableContainer = document.querySelector('.overflow-x-auto');
            if (tableContainer) {
                tableContainer.classList.remove('pending-tab-active', 'approved-tab-active', 'archive-tab-active', 'cancelled-tab-active');
                if (currentView === 'pending') {
                    tableContainer.classList.add('pending-tab-active');
                } else if (currentView === 'approved') {
                    tableContainer.classList.add('approved-tab-active');
                } else if (currentView === 'archive') {
                    tableContainer.classList.add('archive-tab-active');
                } else if (currentView === 'cancelled') {
                    tableContainer.classList.add('cancelled-tab-active');
                }
            }

            // Show priority and status columns, hide description and ROD/FASD columns
            document.querySelectorAll('.priority-status-col').forEach(col => col.classList.remove('hidden'));
            document.querySelectorAll('.description-col').forEach(col => col.classList.add('hidden'));
            document.querySelectorAll('.recipients-col').forEach(col => col.classList.remove('hidden'));
            document.querySelectorAll('.rod-fasd-col').forEach(col => col.classList.add('hidden'));
            document.querySelectorAll('.checkbox-col').forEach(col => col.classList.add('hidden'));

            // Reset to actions view only if not in approved tab
            if (currentView !== 'approved') {
                isActionMode = true;
                if (actionToggle) actionToggle.checked = false;
                const actionButtons = document.querySelectorAll('.action-buttons');
                const actionTaken = document.querySelectorAll('.action-taken');
                actionButtons.forEach(btn => btn.classList.remove('hidden'));
                actionTaken.forEach(input => input.classList.add('hidden'));
                const lastHeader = document.querySelector('th:last-child');
                if (lastHeader) lastHeader.textContent = 'Actions';
            }
        }

        // Helper function to check if memo is archived
        function isMemoArchived(memo) {
            return memo.status && memo.status.toLowerCase() === 'archived';
        }

        // Helper function to check if memo should appear in approved tab
        function shouldShowInApprovedTab(memo) {
            // First, ensure it's not archived
            if (isMemoArchived(memo)) {
                return false;
            }
            
            // Then check if it meets approved criteria
            return memo.status && (
                memo.status.toLowerCase() === 'approved' || 
                (memo.receivedByRodFasd !== null && memo.receivedByRodFasd !== undefined)
            );
        }

        // Helper function to get filtered memos based on current view
        function getFilteredMemosForCurrentView() {
            if (!allMemos) return [];
            if (currentView === 'pending') {
                return allMemos.filter(memo => memo.status && memo.status.toLowerCase() === 'pending');
            } else if (currentView === 'approved') {
                return allMemos.filter(memo => shouldShowInApprovedTab(memo));
            } else if (currentView === 'archive') {
                return allMemos.filter(memo => isMemoArchived(memo));
            } else if (currentView === 'cancelled') {
                return allMemos.filter(memo => memo.status && memo.status.toLowerCase() === 'cancelled');
            } else {
                return allMemos; // Default to all memos
            }
        }

        pendingMemosTab.addEventListener('click', () => {
            currentView = 'pending';
            updateTabStyles();
            renderTableHeader();
            renderMemos(getFilteredMemosForCurrentView());
        });

        approvedMemosTab.addEventListener('click', () => {
            currentView = 'approved';
            updateTabStyles();
            renderTableHeader();
            const approvedMemos = getFilteredMemosForCurrentView();
            renderMemos(approvedMemos);

            // Set row height based on log sheet preview state
            const tableRows = document.querySelectorAll('tbody tr');
            if (!isActionMode) { // If log sheet preview is on
                tableRows.forEach(row => {
                    row.style.height = '180px';
                    row.style.minHeight = '180px';
                });
            }
        });

        archiveMemosTab.addEventListener('click', () => {
            currentView = 'archive';
            updateTabStyles();
            renderTableHeader();
            if (archiveTypeTabs) archiveTypeTabs.classList.remove('hidden');
            setActiveArchiveTypeTab('All'); // Default to All
        });

        cancelledMemosTab.addEventListener('click', () => {
            currentView = 'cancelled';
            updateTabStyles();
            renderTableHeader();
            renderMemos(getFilteredMemosForCurrentView());
        });

        // Show success toast
        function showSuccessToast(message) {
            successMessage.textContent = message;
            successToast.classList.remove('hidden');
            successToast.classList.add('toast-enter');
            
            setTimeout(() => {
                successToast.classList.add('toast-exit');
                setTimeout(() => {
                    successToast.classList.add('hidden');
                    successToast.classList.remove('toast-enter', 'toast-exit');
                }, 300);
            }, 3000);
        }

        let memosUnsubscribe = null;

        // Check authentication
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                if (memosUnsubscribe) memosUnsubscribe();
                window.location.href = 'index.html';
                return;
            }

            // Display user info
            const userData = JSON.parse(localStorage.getItem('tesdaUser'));
            if (userData) {
                userInfo.textContent = `${userData.username} (${userData.department})`;
            }

            // Show loading modal while fetching
            loadingModal.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            try {
                // Real-time listener for memos
                const memosQuery = query(collection(db, "memos"), orderBy("createdAt", "desc"));
                if (memosUnsubscribe) memosUnsubscribe();
                memosUnsubscribe = onSnapshot(memosQuery, (memosSnapshot) => {
                    allMemos = [];
                    memosSnapshot.forEach((doc) => {
                        const memoData = {
                            id: doc.id,
                            ...doc.data()
                        };
                        allMemos.push(memoData);
                    });

                    // Update stats
                    if (totalMemos) totalMemos.textContent = allMemos.length;
                    if (pendingMemos) pendingMemos.textContent = allMemos.filter(m => m.status === 'pending').length;
                    if (approvedMemos) approvedMemos.textContent = allMemos.filter(m => shouldShowInApprovedTab(m)).length;
                    if (archivedMemos) archivedMemos.textContent = allMemos.filter(m => m.status === 'archived').length;

                    // Store memos globally for search functionality
                    window.allMemos = allMemos;

                    // Render memos based on current view
                    renderMemos(getFilteredMemosForCurrentView());
                });

                // Fetch all memoNumbers in parallel (keep as getDoc for now)
                const memoNumberRefs = [
                    { id: 'current', el: 'nextMemoNumber', storage: 'dashboard_nextMemoNumber' },
                    { id: 'coCurrent', el: 'nextCoMemoNumber', storage: 'dashboard_nextCoMemoNumber' },
                    { id: 'officeOrder', el: 'nextOfficeOrderNumber', storage: 'dashboard_nextOfficeOrderNumber' },
                    { id: 'advisoryBulletin', el: 'nextAdvisoryBulletinNumber', storage: 'dashboard_nextAdvisoryBulletinNumber' },
                    { id: 'acknowledgment', el: 'nextAcknowledgmentNumber', storage: 'dashboard_nextAcknowledgmentNumber' }
                ];
                const memoNumberPromises = memoNumberRefs.map(async ref => {
                    try {
                        const docRef = doc(db, "memoNumbers", ref.id);
                        const docSnap = await getDoc(docRef);
                        let number = 0;
                        if (docSnap.exists()) {
                            number = docSnap.data().number;
                        } else {
                            // If not exist, create with 0
                            await setDoc(docRef, { number: 0 });
                        }
                        const el = document.getElementById(ref.el);
                        if (el) {
                            el.textContent = `${String(number).padStart(4, '0')}`;
                            localStorage.setItem(ref.storage, `${String(number).padStart(4, '0')}`);
                        }
                    } catch (err) {
                        // Show error but continue
                        console.error(`Error fetching memo number for ${ref.id}:`, err);
                    }
                });
                await Promise.all(memoNumberPromises);
            } catch (err) {
                console.error('Error loading dashboard data:', err);
                errorMessage.textContent = 'Error loading dashboard data. Please try again.';
                errorMessage.classList.remove('hidden');
            } finally {
                loadingModal.classList.add('hidden');
            }
        });

        // Helper function to format memo number for display
        function formatMemoNumberForDisplay(memoNumber, isAntedated) {
            if (!memoNumber) return '';
            
            if (isAntedated) {
                // For antedated memos, show the last two parts of the series
                const parts = memoNumber.split('-');
                if (parts.length >= 2) {
                    const lastTwoParts = parts.slice(-2).join('-');
                    return lastTwoParts;
                }
            }
            
            // For normal memos, show just the last part
            return memoNumber.split('-').pop();
        }

        // 1. Add helper to group memos by received month
        function groupMemosByReceivedMonth(memos) {
            const groups = {};
            memos.forEach(memo => {
                if (memo.receivedByRodFasd && memo.receivedByRodFasd.toDate) {
                    const date = memo.receivedByRodFasd.toDate();
                    const year = date.getFullYear();
                    const month = date.toLocaleString('default', { month: 'long' });
                    const key = `${year}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    if (!groups[key]) {
                        groups[key] = {
                            label: `Outgoing Communications - ${month} ${year}`,
                            year,
                            month: date.getMonth(),
                            memos: [],
                            rawMonth: date.getMonth() + 1,
                        };
                    }
                    groups[key].memos.push(memo);
                }
            });
            // Convert to array and sort descending
            return Object.values(groups).sort((a, b) => {
                if (a.year !== b.year) return b.year - a.year;
                return b.rawMonth - a.rawMonth;
            });
        }

        // 2. State for expanded folder
        let expandedFolderKey = null;

        // 3. Patch renderMemos for Archive tab to show folders
        function renderMemos(memos) {
            renderTableHeader();
            memosTableBody.innerHTML = '';
            const memosCardBody = document.getElementById('memosCardBody');
            if (memosCardBody) memosCardBody.innerHTML = '';

            // FLAT LIST FOR ARCHIVE TAB (no folders)
            if (currentView === 'archive') {
                // Just render all memos as a flat list
                memos.forEach(memo => {
                    // Table row (desktop)
                    const row = document.createElement('tr');
                    row.className = 'bg-white';
                    row.innerHTML = `
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900">${formatMemoNumberForDisplay(memo.memoNumber, memo.isAntedated)}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 compressed-subject">${memo.title}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900">${memo.department}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 recipients-col">${memo.recipients}</td>
                        <td class="px-6 py-3 text-sm text-gray-900 w-48">
                            ${memo.createdAt && memo.createdAt.toDate ? memo.createdAt.toDate().toLocaleDateString('en-US', {
                                year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true
                            }) : 'N/A'}
                        </td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 rod-fasd-col w-48">
                            ${memo.releasedToRodFasd && memo.releasedToRodFasd.toDate ? memo.releasedToRodFasd.toDate().toLocaleDateString('en-US', {
                                year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true
                            }) : ''}
                        </td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 rod-fasd-col">
                            ${memo.receivedByRodFasd && memo.receivedByRodFasd.toDate ? breakLineEveryNChars(memo.receivedByRodFasd.toDate().toLocaleDateString('en-US', {
                                year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true
                            }) + (memo.receivedByName ? ` (${memo.receivedByName})` : ''), 40) : ''}
                        </td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">
                            <div class="flex space-x-4">
                                <div id="actionButtons_${memo.id}" class="action-buttons">
                                    <button onclick="viewMemo('${memo.id}')" class="text-blue-600 hover:text-blue-900">View</button>
                                    <button onclick="changeStatus('${memo.id}', '${memo.status}')" class="text-green-600 hover:text-green-900">Status</button>
                                    <button onclick="deleteMemo('${memo.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                                </div>
                            </div>
                        </td>
                    `;
                    memosTableBody.appendChild(row);
                    // Mobile card
                    if (memosCardBody) {
                        const card = document.createElement('div');
                        card.className = 'bg-white shadow-md rounded-lg p-4 mb-4';
                        card.innerHTML = `
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs font-bold text-gray-500 uppercase">Memo No.:</span>
                                <span class="text-sm font-semibold text-gray-900">${formatMemoNumberForDisplay(memo.memoNumber, memo.isAntedated)}</span>
                            </div>
                            <div class="mb-1">
                                <span class="block text-xs font-bold text-gray-500 uppercase">Subject:</span>
                                <span class="block text-sm text-gray-900">${memo.title}</span>
                            </div>
                            <div class="mb-1">
                                <span class="block text-xs font-bold text-gray-500 uppercase">From:</span>
                                <span class="block text-sm text-gray-900">${memo.department}</span>
                            </div>
                            <div class="mb-1">
                                <span class="block text-xs font-bold text-gray-500 uppercase">Recipients:</span>
                                <span class="block text-sm text-gray-900">${memo.recipients}</span>
                            </div>
                            <div class="mb-1">
                                <span class="block text-xs font-bold text-gray-500 uppercase">Status:</span>
                                <span class="inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(memo.status)} px-2 py-1">${memo.status}</span>
                            </div>
                            <div class="mb-1">
                                <span class="block text-xs font-bold text-gray-500 uppercase">Created At:</span>
                                <span class="block text-sm text-gray-900">${memo.createdAt && memo.createdAt.toDate ? memo.createdAt.toDate().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true }) : 'N/A'}</span>
                            </div>
                            <div class="mb-1">
                                <span class="block text-xs font-bold text-gray-500 uppercase">Released to:</span>
                                <span class="block text-sm text-gray-900">${memo.releasedToRodFasd && memo.releasedToRodFasd.toDate ? memo.releasedToRodFasd.toDate().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true }) : ''}</span>
                            </div>
                            <div class="mb-1">
                                <span class="block text-xs font-bold text-gray-500 uppercase">Received by (Date + Name):</span>
                                <span class="block text-sm text-gray-900">${memo.receivedByRodFasd && memo.receivedByRodFasd.toDate ? breakLineEveryNChars(memo.receivedByRodFasd.toDate().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true }) + (memo.receivedByName ? ` (${memo.receivedByName})` : ''), 40) : ''}</span>
                            </div>
                            <div class="flex space-x-2 mt-2">
                                <button onclick="viewMemo('${memo.id}')" class="text-blue-600 hover:text-blue-900 font-medium">View</button>
                                <button onclick="changeStatus('${memo.id}', '${memo.status}')" class="text-green-600 hover:text-green-900 font-medium">Status</button>
                                <button onclick="deleteMemo('${memo.id}')" class="text-red-600 hover:text-red-900 font-medium">Delete</button>
                            </div>
                        `;
                        memosCardBody.appendChild(card);
                    }
                });
                return;
            }
            // ... existing code for non-archive views ...
            
            // Apply additional filtering based on current view and action mode
            let filteredMemos = memos;
            
            // For approved tab in log sheet preview mode, only show received memos
            if (currentView === 'approved' && !isActionMode) {
                filteredMemos = memos.filter(memo => 
                    memo.receivedByRodFasd !== null && 
                    memo.receivedByRodFasd !== undefined
                );
            }
            
            filteredMemos.forEach(memo => {
                // --- DESKTOP TABLE ROW (unchanged) ---
                const row = document.createElement('tr');
                row.className = 'resizable-row';
                if (!isActionMode && currentView === 'approved') {
                    row.innerHTML = `
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-900">
                            <input type="checkbox" class="memo-row-checkbox mr-2 align-middle" data-memo-id="${memo.id}">
                            <span class="align-middle">${formatMemoNumberForDisplay(memo.memoNumber, memo.isAntedated)}</span>
                        </td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-900 compressed-subject">${memo.title}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-900">${memo.department}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-900 recipients-col">${memo.recipients}</td>
                        <td class="px-2 py-2 text-sm text-gray-900 w-48">
                            ${memo.createdAt ? memo.createdAt.toDate().toLocaleDateString('en-US', {
                                year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true
                            }) : 'N/A'}
                        </td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-900 rod-fasd-col w-48">
                            ${memo.releasedToRodFasd ? memo.releasedToRodFasd.toDate().toLocaleDateString('en-US', {
                                year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true
                            }) : `<button onclick="releaseToRodFasd('${memo.id}')" class="text-blue-600 hover:text-blue-900">Release now</button>`}
                        </td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-900 rod-fasd-col">
                            ${memo.receivedByRodFasd ? breakLineEveryNChars(memo.receivedByRodFasd.toDate().toLocaleDateString('en-US', {
                                year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true
                            }) + (memo.receivedByName ? ` (${memo.receivedByName})` : ''), 40) : 'Not received'}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                            <div class="flex space-x-4">
                                <div id="actionTaken_${memo.id}" class="action-taken">
                                    <span class="text-gray-600">${memo.actionTaken || ''}</span>
                                </div>
                            </div>
                        </td>
                        <div class="resize-handle"></div>
                    `;
                } else {
                    row.innerHTML = `
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900">${formatMemoNumberForDisplay(memo.memoNumber, memo.isAntedated)}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 compressed-subject">${memo.title}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900">${memo.department}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 recipients-col">${memo.recipients}</td>
                        ${currentView !== 'cancelled' ? `
                        <td class=\"px-6 py-3 whitespace-nowrap\">
                            <span class=\"px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full ${getStatusColor(memo.status)}\">
                                ${memo.status}
                            </span>
                        </td>
                        ` : ''}
                        <td class="px-6 py-3 text-sm text-gray-900 w-48">
                            ${memo.createdAt.toDate().toLocaleDateString('en-US', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit',
                                hour12: true
                            })}
                        </td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 rod-fasd-col w-48">
                            ${currentView === 'pending' ? 'Not Released yet' : (memo.releasedToRodFasd ? 
                                memo.releasedToRodFasd.toDate().toLocaleDateString('en-US', {
                                    year: 'numeric',
                                    month: 'long',
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    hour12: true
                                }) : 
                                `<button onclick=\"releaseToRodFasd('${memo.id}')\" class=\"text-blue-600 hover:text-blue-900\">Release now</button>`
                            )}
                        </td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 rod-fasd-col">
                            ${currentView === 'approved' ? (memo.receivedByRodFasd ? breakLineEveryNChars(memo.receivedByRodFasd.toDate().toLocaleDateString('en-US', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit',
                                hour12: true
                            }) + (memo.receivedByName ? ` (${memo.receivedByName})` : ''), 40) : 'Not received yet') :
                                (memo.receivedByRodFasd ? 
                                    memo.receivedByRodFasd.toDate().toLocaleDateString('en-US', {
                                        year: 'numeric',
                                        month: 'long',
                                        day: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit',
                                        hour12: true
                                    }) + (memo.receivedByName ? ` (${memo.receivedByName})` : '') : 
                                    'Not received yet'
                                )
                            }
                        </td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">
                            <div class="flex space-x-4">
                                ${isActionMode ? `
                                <div id="actionButtons_${memo.id}" class="action-buttons">
                                    <button onclick="viewMemo('${memo.id}')" class="text-blue-600 hover:text-blue-900">View</button>
                                    <button onclick="changeStatus('${memo.id}', '${memo.status}')" class="text-green-600 hover:text-green-900">Status</button>
                                    <button onclick="deleteMemo('${memo.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                                </div>
                                ` : ''}
                                <div id="actionTaken_${memo.id}" class="action-taken ${isActionMode ? 'hidden' : ''}">
                                    <span class="text-gray-600">${memo.actionTaken || ''}</span>
                                </div>
                            </div>
                        </td>
                        <div class="resize-handle"></div>
                    `;
                }
                memosTableBody.appendChild(row);

                // Add resize functionality to the new row
                const resizeHandle = row.querySelector('.resize-handle');
                let startY, startHeight;

                resizeHandle.addEventListener('mousedown', function(e) {
                    if (!isActionMode) { // Only allow resizing in log sheet preview mode
                        startY = e.clientY;
                        startHeight = row.offsetHeight;
                        resizeHandle.classList.add('active');

                        function onMouseMove(e) {
                            const newHeight = startHeight + (e.clientY - startY);
                            if (newHeight >= 180) { // Set minimum height to 180px
                                row.style.height = newHeight + 'px';
                                row.style.minHeight = '180px'; // Ensure minimum height is maintained
                            }
                        }

                        function onMouseUp() {
                            document.removeEventListener('mousemove', onMouseMove);
                            document.removeEventListener('mouseup', onMouseUp);
                            resizeHandle.classList.remove('active');
                            
                            // Ensure height is at least 180px after resize
                            if (row.offsetHeight < 180) {
                                row.style.height = '180px';
                                row.style.minHeight = '180px';
                            }
                        }

                        document.addEventListener('mousemove', onMouseMove);
                        document.addEventListener('mouseup', onMouseUp);
                    }
                });

                // Add event listener to checkbox if it exists
                const checkbox = row.querySelector('.memo-checkbox');
                if (checkbox && !isActionMode) {
                    checkbox.addEventListener('change', handleIndividualCheckbox);
                }

                // --- MOBILE CARD ---
                if (memosCardBody) {
                    const card = document.createElement('div');
                    card.className = 'bg-white shadow-md rounded-lg p-4 mb-4';
                    card.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs font-bold text-gray-500 uppercase">Memo No.:</span>
                            <span class="text-sm font-semibold text-gray-900">${formatMemoNumberForDisplay(memo.memoNumber, memo.isAntedated)}</span>
                        </div>
                        <div class="mb-1">
                            <span class="block text-xs font-bold text-gray-500 uppercase">Subject:</span>
                            <span class="block text-sm text-gray-900">${memo.title}</span>
                        </div>
                        <div class="mb-1">
                            <span class="block text-xs font-bold text-gray-500 uppercase">From:</span>
                            <span class="block text-sm text-gray-900">${memo.department}</span>
                        </div>
                        <div class="mb-1">
                            <span class="block text-xs font-bold text-gray-500 uppercase">Recipients:</span>
                            <span class="block text-sm text-gray-900">${memo.recipients}</span>
                        </div>
                        <div class="mb-1">
                            <span class="block text-xs font-bold text-gray-500 uppercase">Status:</span>
                            <span class="inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(memo.status)} px-2 py-1">${memo.status}</span>
                        </div>
                        <div class="mb-1">
                            <span class="block text-xs font-bold text-gray-500 uppercase">Created At:</span>
                            <span class="block text-sm text-gray-900">${memo.createdAt && memo.createdAt.toDate ? memo.createdAt.toDate().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true }) : 'N/A'}</span>
                        </div>
                        <div class="mb-1">
                            <span class="block text-xs font-bold text-gray-500 uppercase">Released to:</span>
                            <span class="block text-sm text-gray-900">${currentView === 'pending' ? 'Not Released yet' : (memo.releasedToRodFasd ? memo.releasedToRodFasd.toDate().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true }) : '—')}</span>
                        </div>
                        <div class="mb-1">
                            <span class="block text-xs font-bold text-gray-500 uppercase">Received by (Date + Name):</span>
                            <span class="block text-sm text-gray-900">${memo.receivedByRodFasd ? breakLineEveryNChars(memo.receivedByRodFasd.toDate().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true }) + (memo.receivedByName ? ` (${memo.receivedByName})` : ''), 40) : '—'}</span>
                        </div>
                        <div class="flex space-x-2 mt-2">
                            <button onclick="viewMemo('${memo.id}')" class="text-blue-600 hover:text-blue-900 font-medium">View</button>
                            <button onclick="changeStatus('${memo.id}', '${memo.status}')" class="text-green-600 hover:text-green-900 font-medium">Status</button>
                            <button onclick="deleteMemo('${memo.id}')" class="text-red-600 hover:text-red-900 font-medium">Delete</button>
                        </div>
                    `;
                    memosCardBody.appendChild(card);
                }
            });

            // After rendering table rows:
            // Attach modern checkbox logic
            if (!isActionMode && currentView === 'approved') {
                setTimeout(() => {
                    const headerCheckbox = document.getElementById('memoHeaderCheckbox');
                    const rowCheckboxes = document.querySelectorAll('.memo-row-checkbox');
                    const memoHeader = document.getElementById('memoNoHeader');
                    function updateMemoHeaderState() {
                        const anyChecked = [...rowCheckboxes].some(cb => cb.checked);
                        if (anyChecked) {
                            memoHeader.classList.remove('pointer-events-none', 'opacity-50');
                            memoHeader.classList.add('cursor-pointer', 'hover:underline');
                        } else {
                            memoHeader.classList.add('pointer-events-none', 'opacity-50');
                            memoHeader.classList.remove('cursor-pointer', 'hover:underline');
                        }
                    }
                    if (headerCheckbox) {
                        headerCheckbox.addEventListener('change', () => {
                            rowCheckboxes.forEach(cb => cb.checked = headerCheckbox.checked);
                            updateMemoHeaderState();
                        });
                    }
                    rowCheckboxes.forEach(cb => {
                        cb.addEventListener('change', () => {
                            updateMemoHeaderState();
                            if (headerCheckbox) headerCheckbox.checked = [...rowCheckboxes].every(cb => cb.checked);
                        });
                    });
                    if (memoHeader) {
                        memoHeader.addEventListener('click', async () => {
                            const selectedRows = [...rowCheckboxes].filter(cb => cb.checked);
                            if (selectedRows.length > 0) {
                                // Show loading modal
                                loadingModal.classList.remove('hidden');
                                errorMessage.classList.add('hidden');
                                try {
                                    // Get memo IDs
                                    const selectedIds = selectedRows.map(cb => cb.getAttribute('data-memo-id'));
                                    // Archive in Firestore
                                    const updatePromises = selectedIds.map(memoId => {
                                        const memoRef = doc(db, 'memos', memoId);
                                        return updateDoc(memoRef, {
                                            status: 'archived',
                                            archivedAt: serverTimestamp(),
                                            updatedAt: serverTimestamp()
                                        });
                                    });
                                    await Promise.all(updatePromises);
                                    // Show success toast
                                    successMessage.textContent = `${selectedIds.length} memo(s) routed to archive successfully`;
                                    successToast.classList.remove('hidden');
                                    successToast.classList.add('toast-enter');
                                    setTimeout(() => {
                                        successToast.classList.add('toast-exit');
                                        setTimeout(() => {
                                            successToast.classList.add('hidden');
                                            successToast.classList.remove('toast-enter', 'toast-exit');
                                        }, 300);
                                    }, 3000);
                                    // Remove rows from table
                                    selectedRows.forEach(cb => {
                                        cb.closest('tr').remove();
                                    });
                                    if (headerCheckbox) headerCheckbox.checked = false;
                                    updateMemoHeaderState();
                                } catch (error) {
                                    console.error('Error routing memos to archive:', error);
                                    errorMessage.textContent = 'Error routing memos to archive. Please try again.';
                                    errorMessage.classList.remove('hidden');
                                } finally {
                                    loadingModal.classList.add('hidden');
                                }
                            }
                        });
                    }
                    updateMemoHeaderState();
                }, 0);
            }
        }

        // Get status color class
        function getStatusColor(status) {
            switch (status.toLowerCase()) {
                case 'pending':
                    return 'bg-yellow-100 text-yellow-800';
                case 'approved':
                    return 'bg-green-100 text-green-800';
                case 'rejected':
                    return 'bg-red-100 text-red-800';
                case 'archived':
                    return 'bg-gray-100 text-gray-800';
                case 'cancelled':
                    return 'bg-red-100 text-red-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        // Show delete modal
        window.showDeleteModal = function(memoId) {
            currentMemoId = memoId;
            deleteModal.classList.remove('hidden');
            deletePassword.value = '';
            passwordError.classList.add('hidden');
            deletePassword.focus();
        };

        // Close delete modal
        window.closeDeleteModal = function() {
            deleteModal.classList.add('hidden');
            currentMemoId = null;
            deletePassword.value = '';
            passwordError.classList.add('hidden');
        };

        // Confirm delete
        window.confirmDelete = async function() {
            const password = deletePassword.value;
            
            if (password !== 'admintesda') {
                passwordError.textContent = 'Incorrect password';
                passwordError.classList.remove('hidden');
                return;
            }

            try {
                loadingModal.classList.remove('hidden');
                errorMessage.classList.add('hidden');
                
                // Use the enhanced delete function that handles cascading delete of activity logs
                await deleteMemoFromFirestore(currentMemoId);
                
                showSuccessToast('Memo and related activity logs deleted successfully');
                closeDeleteModal();
                
            } catch (error) {
                console.error('Error deleting memo:', error);
                errorMessage.textContent = 'Error deleting memo. Please try again.';
                errorMessage.classList.remove('hidden');
            } finally {
                loadingModal.classList.add('hidden');
            }
        };

        // Handle Enter key in password field
        deletePassword.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                confirmDelete();
            }
        });

        // Handle logout
        logoutBtn.addEventListener('click', async () => {
            if (memosUnsubscribe) memosUnsubscribe();
            try {
                await logoutUser();
                localStorage.removeItem('tesdaUser');
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Error logging out:', error);
                errorMessage.textContent = 'Error logging out. Please try again.';
                errorMessage.classList.remove('hidden');
            }
        });

        // View memo function
        window.viewMemo = function(memoId) {
            window.location.href = `view-memo.html?id=${memoId}`;
        };

        // Delete memo function
        window.deleteMemo = function(memoId) {
            showDeleteModal(memoId);
        };

        // Cleanup function for orphaned activity logs (admin only)
        window.cleanupOrphanedLogs = async function() {
            try {
                loadingModal.classList.remove('hidden');
                errorMessage.classList.add('hidden');
                
                const cleanedCount = await cleanupOrphanedActivityLogs();
                
                if (cleanedCount > 0) {
                    showSuccessToast(`Successfully cleaned up ${cleanedCount} orphaned activity logs`);
                } else {
                    showSuccessToast('No orphaned activity logs found');
                }
                
            } catch (error) {
                console.error('Error cleaning up orphaned logs:', error);
                errorMessage.textContent = 'Error cleaning up orphaned logs. Please try again.';
                errorMessage.classList.remove('hidden');
            } finally {
                loadingModal.classList.add('hidden');
            }
        };

        // Search functionality
        let searchTimeout;

        function getSearchableValue(memo, field) {
            if (!memo[field]) return '';
            
            // Handle special cases
            if (field === 'createdAt' && memo[field]) {
                return memo[field].toDate().toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }
            
            // Handle memo number specially
            if (field === 'memoNumber') {
                return `Memo ${memo[field].split('-').pop()}`;
            }
            
            // Convert to string and handle null/undefined
            return String(memo[field]).toLowerCase();
        }

        function filterMemos(memos, searchTerm, filterField) {
            if (!searchTerm) return memos;
            
            searchTerm = searchTerm.toLowerCase().trim();
            
            // If specific field is selected, just filter by that field
            if (filterField !== 'all') {
                return memos.filter(memo => 
                    getSearchableValue(memo, filterField).includes(searchTerm)
                );
            }

            // For "all" search, prioritize results based on field matches
            return memos.map(memo => {
                let score = 0;
                const memoNumber = getSearchableValue(memo, 'memoNumber');
                const title = getSearchableValue(memo, 'title');
                const department = getSearchableValue(memo, 'department');
                const recipients = getSearchableValue(memo, 'recipients');
                const priority = getSearchableValue(memo, 'priority');
                const status = getSearchableValue(memo, 'status');
                const createdAt = getSearchableValue(memo, 'createdAt');

                // Priority scoring (higher score = higher priority)
                if (memoNumber.includes(searchTerm)) score += 100; // Highest priority
                if (title.includes(searchTerm)) score += 80;
                if (department.includes(searchTerm)) score += 60;
                if (recipients.includes(searchTerm)) score += 40;
                if (priority.includes(searchTerm)) score += 30;
                if (status.includes(searchTerm)) score += 20;
                if (createdAt.includes(searchTerm)) score += 10; // Lowest priority

                // Add exact match bonus
                if (memoNumber === searchTerm) score += 50;
                if (title === searchTerm) score += 40;
                if (department === searchTerm) score += 30;
                if (recipients === searchTerm) score += 20;
                if (priority === searchTerm) score += 15;
                if (status === searchTerm) score += 10;
                if (createdAt === searchTerm) score += 5;

                return { memo, score };
            })
            .filter(item => item.score > 0) // Only include items that match
            .sort((a, b) => b.score - a.score) // Sort by score in descending order
            .map(item => item.memo); // Remove scores and return just the memos
        }

        function updateSearchSuggestions(memos, searchTerm) {
            if (!searchTerm || searchTerm.length < 2) {
                searchSuggestions.classList.add('hidden');
                return;
            }

            const filterField = searchFilter.value;
            const filteredMemos = filterMemos(memos, searchTerm, filterField);
            
            if (filteredMemos.length === 0) {
                searchSuggestions.classList.add('hidden');
                return;
            }

            // Show up to 5 suggestions with match indicators
            const suggestions = filteredMemos.slice(0, 5).map(memo => {
                let displayText = '';
                let matchIndicator = '';

                if (filterField === 'all') {
                    // Show which field matched
                    if (getSearchableValue(memo, 'memoNumber').includes(searchTerm)) {
                        matchIndicator = '<span class="text-blue-600 text-xs">(Memo #)</span>';
                    } else if (getSearchableValue(memo, 'title').includes(searchTerm)) {
                        matchIndicator = '<span class="text-blue-600 text-xs">(Subject)</span>';
                    } else if (getSearchableValue(memo, 'department').includes(searchTerm)) {
                        matchIndicator = '<span class="text-blue-600 text-xs">(Department)</span>';
                    } else if (getSearchableValue(memo, 'recipients').includes(searchTerm)) {
                        matchIndicator = '<span class="text-blue-600 text-xs">(Recipients)</span>';
                    } else if (getSearchableValue(memo, 'priority').includes(searchTerm)) {
                        matchIndicator = '<span class="text-blue-600 text-xs">(Priority)</span>';
                    } else if (getSearchableValue(memo, 'status').includes(searchTerm)) {
                        matchIndicator = '<span class="text-blue-600 text-xs">(Status)</span>';
                    } else if (getSearchableValue(memo, 'createdAt').includes(searchTerm)) {
                        matchIndicator = '<span class="text-blue-600 text-xs">(Date)</span>';
                    }
                    displayText = `Memo ${formatMemoNumberForDisplay(memo.memoNumber, memo.isAntedated)} - ${memo.title}`;
                } else {
                    displayText = memo[filterField];
                }

                return `
                    <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer flex justify-between items-center" 
                         onclick="selectSuggestion('${memo.id}')">
                        <span>${displayText}</span>
                        ${matchIndicator}
                    </div>`;
            }).join('');

            searchSuggestions.innerHTML = suggestions;
            searchSuggestions.classList.remove('hidden');
        }

        window.selectSuggestion = function(memoId) {
            window.location.href = `view-memo.html?id=${memoId}`;
        };

        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value;
            
            // Show/hide clear button
            clearSearch.classList.toggle('hidden', !searchTerm);
            
            // Show loading spinner
            searchSpinner.classList.remove('hidden');
            
            // Clear previous timeout
            clearTimeout(searchTimeout);
            
            // Add debounce to search
            searchTimeout = setTimeout(() => {
                if (!allMemos) return;

                const memosToSearch = getFilteredMemosForCurrentView();
                const filteredMemos = filterMemos(memosToSearch, searchTerm, searchFilter.value);
                renderMemos(filteredMemos);
                updateSearchSuggestions(memosToSearch, searchTerm);
                searchSpinner.classList.add('hidden');

                // Show "no results" message if needed
                const noResultsMessage = document.getElementById('noResultsMessage');
                if (filteredMemos.length === 0 && searchTerm) {
                    if (!noResultsMessage) {
                        const message = document.createElement('div');
                        message.id = 'noResultsMessage';
                        message.className = 'text-center py-4 text-gray-500 text-sm';
                        message.textContent = `No memos found matching "${searchTerm}"`;
                        memosTableBody.parentNode.insertBefore(message, memosTableBody.nextSibling);
                    } else {
                        noResultsMessage.textContent = `No memos found matching "${searchTerm}"`;
                        noResultsMessage.classList.remove('hidden');
                    }
                } else if (noResultsMessage) {
                    noResultsMessage.classList.add('hidden');
                }
            }, 300); // 300ms debounce
        });

        // Close suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !searchSuggestions.contains(e.target)) {
                searchSuggestions.classList.add('hidden');
            }
        });

        // Clear search
        clearSearch.addEventListener('click', () => {
            searchInput.value = '';
            clearSearch.classList.add('hidden');
            searchSpinner.classList.add('hidden');
            searchSuggestions.classList.add('hidden');
            const noResultsMessage = document.getElementById('noResultsMessage');
            if (noResultsMessage) {
                noResultsMessage.classList.add('hidden');
            }
            renderMemos(getFilteredMemosForCurrentView());
        });

        // Update search when filter changes
        searchFilter.addEventListener('change', () => {
            if (searchInput.value) {
                const event = new Event('input');
                searchInput.dispatchEvent(event);
            }
        });

        // Status change functionality
        const statusModal = document.getElementById('statusModal');
        const newStatus = document.getElementById('newStatus');
        let currentStatusMemoId = null;

        // Show status modal
        window.changeStatus = function(memoId, currentStatus) {
            currentStatusMemoId = memoId;
            if (currentStatus === 'approved') {
                newStatus.value = 'pending';
            } else if (currentStatus === 'pending') {
                newStatus.value = 'approved';
            } else if (currentStatus === 'cancelled') {
                newStatus.value = 'approved';
            } else {
                newStatus.value = 'approved';
            }
            statusModal.classList.remove('hidden');
        };

        // Close status modal
        window.closeStatusModal = function() {
            statusModal.classList.add('hidden');
            currentStatusMemoId = null;
        };

        // Log memo activity
        async function logMemoActivity(memoId, action, username) {
            try {
                const activityRef = doc(collection(db, "memoActivities"));
                await setDoc(activityRef, {
                    memoId: memoId,
                    action: action,
                    username: username,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error('Error logging memo activity:', error);
            }
        }

        // Confirm status change
        window.confirmStatusChange = async function() {
            if (!currentStatusMemoId) return;

            try {
                loadingModal.classList.remove('hidden');
                errorMessage.classList.add('hidden');
                
                // Get current status before updating
                const memoRef = doc(db, 'memos', currentStatusMemoId);
                const memoDoc = await getDoc(memoRef);
                const oldStatus = memoDoc.data().status;
                
                // Update memo status in Firestore
                await updateDoc(memoRef, {
                    status: newStatus.value,
                    updatedAt: serverTimestamp()
                });

                // Log the status change
                const userData = JSON.parse(localStorage.getItem('tesdaUser'));
                await logMemoActivity(
                    currentStatusMemoId,
                    `Status changed from "${oldStatus}" to "${newStatus.value}"`,
                    userData.username
                );

                showSuccessToast(`Memo status updated to ${newStatus.value}`);
                closeStatusModal();
                
            } catch (error) {
                console.error('Error updating memo status:', error);
                errorMessage.textContent = 'Error updating memo status. Please try again.';
                errorMessage.classList.remove('hidden');
            } finally {
                loadingModal.classList.add('hidden');
            }
        };

        // Handle Enter key in status select
        newStatus.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                confirmStatusChange();
            }
        });

        // Memo number editing functionality
        window.editMemoNumber = function(type) {
            if (type === 'advisoryBulletin') {
                const editDiv = document.getElementById('advisoryBulletinNumberEdit');
                const input = document.getElementById('advisoryBulletinNumberInput');
                const currentNumber = document.getElementById('nextAdvisoryBulletinNumber');
                if (editDiv && input && currentNumber) {
                    const currentValue = currentNumber.textContent.replace(/^0+/, '') || '0';
                    input.value = parseInt(currentValue);
                    editDiv.classList.remove('hidden');
                }
            } else {
                let editDiv, input, currentNumber;
                switch(type) {
                    case 'current':
                        editDiv = document.getElementById('memoNumberEdit');
                        input = document.getElementById('memoNumberInput');
                        currentNumber = document.getElementById('nextMemoNumber');
                        break;
                    case 'coCurrent':
                        editDiv = document.getElementById('coMemoNumberEdit');
                        input = document.getElementById('coMemoNumberInput');
                        currentNumber = document.getElementById('nextCoMemoNumber');
                        break;
                    case 'officeOrder':
                        editDiv = document.getElementById('officeOrderNumberEdit');
                        input = document.getElementById('officeOrderNumberInput');
                        currentNumber = document.getElementById('nextOfficeOrderNumber');
                        break;
                    case 'advisory':
                        editDiv = document.getElementById('advisoryNumberEdit');
                        input = document.getElementById('advisoryNumberInput');
                        currentNumber = document.getElementById('nextAdvisoryNumber');
                        break;
                    case 'bulletin':
                        editDiv = document.getElementById('bulletinNumberEdit');
                        input = document.getElementById('bulletinNumberInput');
                        currentNumber = document.getElementById('nextBulletinNumber');
                        break;
                    case 'acknowledgment':
                        editDiv = document.getElementById('acknowledgmentNumberEdit');
                        input = document.getElementById('acknowledgmentNumberInput');
                        currentNumber = document.getElementById('nextAcknowledgmentNumber');
                        break;
                    default:
                        return;
                }
                
                // Set the input value and show the edit div
                if (editDiv && input && currentNumber) {
                    const currentValue = currentNumber.textContent.replace(/^0+/, '') || '0';
                    input.value = parseInt(currentValue);
                    editDiv.classList.remove('hidden');
                } else {
                    console.log('Missing elements for type:', type);
                }
            }
        };

        window.cancelMemoNumberEdit = function() {
            const memoNumberEdit = document.getElementById('memoNumberEdit');
            const coMemoNumberEdit = document.getElementById('coMemoNumberEdit');
            const officeOrderNumberEdit = document.getElementById('officeOrderNumberEdit');
            const advisoryNumberEdit = document.getElementById('advisoryNumberEdit');
            const bulletinNumberEdit = document.getElementById('bulletinNumberEdit');
            const acknowledgmentNumberEdit = document.getElementById('acknowledgmentNumberEdit');
            const advisoryBulletinNumberEdit = document.getElementById('advisoryBulletinNumberEdit');
            
            if (memoNumberEdit) memoNumberEdit.classList.add('hidden');
            if (coMemoNumberEdit) coMemoNumberEdit.classList.add('hidden');
            if (officeOrderNumberEdit) officeOrderNumberEdit.classList.add('hidden');
            if (advisoryNumberEdit) advisoryNumberEdit.classList.add('hidden');
            if (bulletinNumberEdit) bulletinNumberEdit.classList.add('hidden');
            if (acknowledgmentNumberEdit) acknowledgmentNumberEdit.classList.add('hidden');
            if (advisoryBulletinNumberEdit) advisoryBulletinNumberEdit.classList.add('hidden');
        };

        window.saveMemoNumber = async function(type) {
            if (type === 'advisoryBulletin') {
                const input = document.getElementById('advisoryBulletinNumberInput');
                if (!input) {
                    errorMessage.textContent = 'Input element not found';
                    errorMessage.classList.remove('hidden');
                    return;
                }
                const newNumber = parseInt(input.value);
                if (isNaN(newNumber) || newNumber < 0) {
                    errorMessage.textContent = 'Please enter a valid number';
                    errorMessage.classList.remove('hidden');
                    return;
                }
                try {
                    loadingModal.classList.remove('hidden');
                    errorMessage.classList.add('hidden');
                    // Validate against highest number in memos of type Advisory or Bulletin
                    const memosQuery = query(collection(db, "memos"), orderBy("createdAt", "desc"));
                    const memosSnapshot = await getDocs(memosQuery);
                    let highestNumber = 0;
                    memosSnapshot.forEach((doc) => {
                        const memo = doc.data();
                        if (memo.memoType === 'Advisory' || memo.memoType === 'Bulletin') {
                            const memoNumber = parseInt(formatMemoNumberForDisplay(memo.memoNumber, memo.isAntedated).replace(/[A-Z]/g, ''));
                            if (!isNaN(memoNumber) && memoNumber > highestNumber) highestNumber = memoNumber;
                        }
                    });
                    if (newNumber < highestNumber) {
                        errorMessage.textContent = `Number must be greater than or equal to ${highestNumber}`;
                        errorMessage.classList.remove('hidden');
                        loadingModal.classList.add('hidden');
                        return;
                    }
                    const advisoryBulletinRef = doc(db, "memoNumbers", "advisoryBulletin");
                    try {
                        await updateDoc(advisoryBulletinRef, { number: newNumber });
                    } catch (error) {
                        if (error.code === "not-found" || error.message.includes("No document to update")) {
                            await setDoc(advisoryBulletinRef, { number: newNumber });
                        } else {
                            throw error;
                        }
                    }
                    showSuccessToast(`Advisory/Bulletin number updated successfully`);
                    cancelMemoNumberEdit();
                } catch (error) {
                    console.error('Error updating Advisory/Bulletin number:', error);
                    errorMessage.textContent = 'Error updating Advisory/Bulletin number. Please try again.';
                    errorMessage.classList.remove('hidden');
                } finally {
                    loadingModal.classList.add('hidden');
                }
            } else {
                let input, memoType;
                switch(type) {
                    case 'current':
                        input = document.getElementById('memoNumberInput');
                        memoType = 'current';
                        break;
                    case 'coCurrent':
                        input = document.getElementById('coMemoNumberInput');
                        memoType = 'coCurrent';
                        break;
                    case 'officeOrder':
                        input = document.getElementById('officeOrderNumberInput');
                        memoType = 'officeOrder';
                        break;
                    case 'advisory':
                        input = document.getElementById('advisoryNumberInput');
                        memoType = 'advisory';
                        break;
                    case 'bulletin':
                        input = document.getElementById('bulletinNumberInput');
                        memoType = 'bulletin';
                        break;
                    case 'acknowledgment':
                        input = document.getElementById('acknowledgmentNumberInput');
                        memoType = 'acknowledgment';
                        break;
                    default:
                        return;
                }
                
                if (!input) {
                    errorMessage.textContent = 'Input element not found';
                    errorMessage.classList.remove('hidden');
                    return;
                }
                
                const newNumber = parseInt(input.value);
                console.log('Input value and parsed number:', { inputValue: input.value, newNumber, memoType });
                
                if (isNaN(newNumber) || newNumber < 0) {
                    errorMessage.textContent = 'Please enter a valid number';
                    errorMessage.classList.remove('hidden');
                    return;
                }
                try {
                    loadingModal.classList.remove('hidden');
                    errorMessage.classList.add('hidden');
                    const memosQuery = query(collection(db, "memos"), orderBy("createdAt", "desc"));
                    const memosSnapshot = await getDocs(memosQuery);
                    let highestNumber = 0;
                    memosSnapshot.forEach((doc) => {
                        const memo = doc.data();
                        if ((memoType === 'advisory' && memo.memoType === 'Advisory') ||
                            (memoType === 'bulletin' && memo.memoType === 'Bulletin')) {
                            const memoNumber = parseInt(formatMemoNumberForDisplay(memo.memoNumber, memo.isAntedated).replace(/[A-Z]/g, ''));
                            if (!isNaN(memoNumber) && memoNumber > highestNumber) {
                                highestNumber = memoNumber;
                            }
                        }
                    });
                    console.log('Highest number for validation:', highestNumber);
                    
                    if (newNumber < highestNumber) {
                        errorMessage.textContent = `Number must be greater than or equal to ${highestNumber}`;
                        errorMessage.classList.remove('hidden');
                        loadingModal.classList.add('hidden');
                        return;
                    }
                    const memoNumberRef = doc(db, "memoNumbers", memoType);
                    console.log('Updating Firestore document:', memoType, 'with number:', newNumber);
                    try {
                        await updateDoc(memoNumberRef, { number: newNumber });
                        console.log('Successfully updated memo number');
                    } catch (error) {
                        if (error.code === "not-found" || error.message.includes("No document to update")) {
                            await setDoc(memoNumberRef, { number: newNumber });
                            console.log('Created new memo number document');
                        } else {
                            throw error;
                        }
                    }
                    showSuccessToast(`Memo number updated successfully`);
                    cancelMemoNumberEdit();
                } catch (error) {
                    console.error('Error updating memo number:', error);
                    errorMessage.textContent = 'Error updating memo number. Please try again.';
                    errorMessage.classList.remove('hidden');
                } finally {
                    loadingModal.classList.add('hidden');
                }
            }
        };

        // Add release to ROD/FASD functionality
        window.releaseToRodFasd = async function(memoId) {
            try {
                loadingModal.classList.remove('hidden');
                errorMessage.classList.add('hidden');
                
                const memoRef = doc(db, 'memos', memoId);
                await updateDoc(memoRef, {
                    releasedToRodFasd: serverTimestamp()
                });

                showSuccessToast('Memo released to ROD/FASD successfully');

                // Immediately update the UI for the released memo
                // Find the row for this memo and update the releasedToRodFasd cell
                const row = Array.from(memosTableBody.children).find(tr => {
                    // Try to match by memoId in the row's action buttons or action taken div
                    const actionDiv = tr.querySelector('.action-buttons') || tr.querySelector('.action-taken');
                    if (!actionDiv) return false;
                    const id = actionDiv.id?.split('_')[1];
                    return id === memoId;
                });
                if (row) {
                    // Find the correct cell (releasedToRodFasd column)
                    // This is the 6th or 7th cell depending on the mode
                    let cellIdx = 6; // default for action mode
                    if (!isActionMode && currentView === 'approved') cellIdx = 5;
                    const cell = row.querySelectorAll('td')[cellIdx];
                    if (cell) {
                        const now = new Date();
                        cell.textContent = now.toLocaleDateString('en-US', {
                            year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true
                        });
                    }
                }
                
            } catch (error) {
                console.error('Error releasing memo to ROD/FASD:', error);
                errorMessage.textContent = 'Error releasing memo. Please try again.';
                errorMessage.classList.remove('hidden');
            } finally {
                loadingModal.classList.add('hidden');
            }
        };

        // Add the markAsReceived function
        window.markAsReceived = async function(memoId) {
            try {
                // Prompt for name if not already present (for admin manual marking)
                let name = '';
                // Try to get the name from the memo if it exists
                const memoRef = doc(db, 'memos', memoId);
                const memoDoc = await getDoc(memoRef);
                if (memoDoc.exists() && memoDoc.data().receivedByName) {
                    name = memoDoc.data().receivedByName;
                } else {
                    name = prompt('Enter the name of the person who received this memo:');
                    if (!name) return;
                }
                await updateDoc(memoRef, {
                    receivedByRodFasd: serverTimestamp(),
                    receivedByName: name
                });
                showSuccessToast('Memo marked as received successfully');
            } catch (error) {
                console.error('Error marking memo as received:', error);
                showErrorToast('Error marking memo as received');
            }
        };

        // Add new functions for action toggle and header editing
        let isActionMode = true; // Actions mode ON by default (logsheet preview OFF)
        const actionToggle = document.getElementById('actionToggle');
        const pageHeader = document.getElementById('pageHeader');

        // Toggle between Actions and Action Taken
        actionToggle.addEventListener('change', function() {
            isActionMode = !this.checked;
            const actionButtons = document.querySelectorAll('.action-buttons');
            const actionTaken = document.querySelectorAll('.action-taken');
            const actionTakenInputContainer = document.getElementById('actionTakenInputContainer');
            const tableCells = document.querySelectorAll('td');
            const tableRows = document.querySelectorAll('tbody tr');
            const table = document.querySelector('table');
            
            if (isActionMode) {
                const lastHeader = document.querySelector('th:last-child');
                if (lastHeader) lastHeader.textContent = 'Actions';
                // Show action buttons
                actionButtons.forEach(btn => {
                    btn.classList.remove('hidden');
                    btn.style.display = 'flex';
                });
                actionTaken.forEach(input => input.classList.add('hidden'));
                actionTakenInputContainer.classList.add('hidden');
                // Reset font size and row height when not in log sheet preview
                tableCells.forEach(cell => {
                    cell.classList.remove('text-base');
                    cell.classList.add('text-sm');
                });
                table.classList.remove('log-sheet-preview');
                // Hide checkbox column
                document.querySelectorAll('.checkbox-col').forEach(col => col.classList.add('hidden'));
                // Render memos based on current view
                if (currentView === 'all') {
                    renderMemos(allMemos);
                } else if (currentView === 'approved') {
                    const approvedMemos = allMemos.filter(memo => shouldShowInApprovedTab(memo));
                    renderMemos(approvedMemos);
                } else if (currentView === 'archive') {
                    const archiveMemos = allMemos.filter(memo => isMemoArchived(memo));
                    renderMemos(archiveMemos);
                }
            } else {
                const lastHeader = document.querySelector('th:last-child');
                if (lastHeader) lastHeader.textContent = 'Action Taken';
                // Remove action buttons completely
                actionButtons.forEach(btn => {
                    btn.remove();
                });
                actionTaken.forEach(input => input.classList.remove('hidden'));
                actionTakenInputContainer.classList.remove('hidden');
                // Increase font size and set fixed row height for log sheet preview
                tableCells.forEach(cell => {
                    cell.classList.remove('text-sm');
                    cell.classList.add('text-base');
                });
                // Add log sheet preview class to table
                table.classList.add('log-sheet-preview');
                // Show checkbox column
                document.querySelectorAll('.checkbox-col').forEach(col => col.classList.remove('hidden'));
                // Render memos based on current view with additional filtering for approved tab
                renderMemos(getFilteredMemosForCurrentView());
            }
        });

        // Initialize the view based on default switch state
        document.addEventListener('DOMContentLoaded', function() {
            // Set initial state: logsheet preview OFF (Actions mode ON)
            isActionMode = true;
            actionToggle.checked = false;
            
            // Ensure pending tab is active by default
            currentView = 'pending';
            updateTabStyles();
            
            const actionButtons = document.querySelectorAll('.action-buttons');
            const actionTaken = document.querySelectorAll('.action-taken');
            const actionTakenInputContainer = document.getElementById('actionTakenInputContainer');
            const tableCells = document.querySelectorAll('td');
            const tableRows = document.querySelectorAll('tbody tr');
            
            // Add event listener for select all checkbox
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', handleSelectAll);
            }
            
            if (isActionMode) {
                const lastHeader = document.querySelector('th:last-child');
                if (lastHeader) lastHeader.textContent = 'Actions';
                actionButtons.forEach(btn => btn.classList.remove('hidden'));
                actionTaken.forEach(input => input.classList.add('hidden'));
                actionTakenInputContainer.classList.add('hidden');
                tableCells.forEach(cell => {
                    cell.classList.remove('text-base');
                    cell.classList.add('text-sm');
                });
                tableRows.forEach(row => {
                    row.style.height = 'auto';
                    row.style.minHeight = 'auto';
                });
                // Render memos based on current view
                renderMemos(getFilteredMemosForCurrentView());
            } else {
                const lastHeader = document.querySelector('th:last-child');
                if (lastHeader) lastHeader.textContent = 'Action Taken';
                actionButtons.forEach(btn => btn.classList.add('hidden'));
                actionTaken.forEach(input => input.classList.remove('hidden'));
                actionTakenInputContainer.classList.remove('hidden');
                tableCells.forEach(cell => {
                    cell.classList.remove('text-sm');
                    cell.classList.add('text-base');
                });
                tableRows.forEach(row => {
                    row.style.height = '180px';
                    row.style.minHeight = '180px';
                });
                // Render memos based on current view with additional filtering for approved tab
                renderMemos(getFilteredMemosForCurrentView());
            }
        });

        // Apply action taken to selected memos
        window.applyActionTaken = async function() {
            const actionTakenInput = document.getElementById('actionTakenInput');
            const actionTaken = actionTakenInput.value;
            const applyBtn = document.getElementById('applyActionTakenBtn');
            if (!actionTaken) {
                errorMessage.textContent = 'Please enter an action taken';
                errorMessage.classList.remove('hidden');
                return;
            }

            try {
                loadingModal.classList.remove('hidden');
                errorMessage.classList.add('hidden');

                // Get all visible memos (filtered memos)
                const visibleMemos = Array.from(memosTableBody.children).map(row => {
                    const memoId = row.querySelector('.action-buttons')?.id?.split('_')[1];
                    return memoId;
                }).filter(Boolean);

                // Update all visible memos
                const updatePromises = visibleMemos.map(memoId => {
                    const memoRef = doc(db, 'memos', memoId);
                    return updateDoc(memoRef, {
                        actionTaken: actionTaken,
                        updatedAt: serverTimestamp()
                    });
                });

                await Promise.all(updatePromises);
                showSuccessToast('Action taken updated for all visible memos');
                actionTakenInput.value = '';

                // Hide the apply button and replace the input with plain text
                if (applyBtn) applyBtn.style.display = 'none';
                if (actionTakenInput) {
                    const parent = actionTakenInput.parentNode;
                    const textSpan = document.createElement('span');
                    textSpan.textContent = actionTaken;
                    textSpan.className = 'ml-2 px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-700 w-64 inline-block';
                    parent.replaceChild(textSpan, actionTakenInput);
                }

                // Keep the action taken spans empty
                document.querySelectorAll('.action-taken span').forEach(span => {
                    span.textContent = '';
                });

            } catch (error) {
                console.error('Error updating action taken:', error);
                errorMessage.textContent = 'Error updating action taken. Please try again.';
                errorMessage.classList.remove('hidden');
            } finally {
                loadingModal.classList.add('hidden');
            }
        };

        // Handle select all checkbox functionality
        window.handleSelectAll = function() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const memoCheckboxes = document.querySelectorAll('#memosTableBody .memo-checkbox');
            memoCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
                // Trigger change event for each checkbox to update header state
                checkbox.dispatchEvent(new Event('change'));
            });
        };

        // Handle individual checkbox changes
        window.handleIndividualCheckbox = function() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const memoCheckboxes = document.querySelectorAll('#memosTableBody .memo-checkbox');
            const checkedCheckboxes = document.querySelectorAll('#memosTableBody .memo-checkbox:checked');
            if (checkedCheckboxes.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCheckboxes.length === memoCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
        };

        // Get selected memo IDs
        window.getSelectedMemoIds = function() {
            const checkedCheckboxes = document.querySelectorAll('#memosTableBody .memo-checkbox:checked');
            return Array.from(checkedCheckboxes).map(checkbox => checkbox.getAttribute('data-memo-id'));
        };

        // Route selected memos to archive
        window.routeSelectedMemos = async function() {
            const selectedMemoIds = getSelectedMemoIds();
            
            if (selectedMemoIds.length === 0) {
                errorMessage.textContent = 'Please select at least one memo to route';
                errorMessage.classList.remove('hidden');
                return;
            }

            try {
                loadingModal.classList.remove('hidden');
                errorMessage.classList.add('hidden');

                // Update all selected memos to archived status
                const updatePromises = selectedMemoIds.map(memoId => {
                    const memoRef = doc(db, 'memos', memoId);
                    return updateDoc(memoRef, {
                        status: 'archived',
                        archivedAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    });
                });

                await Promise.all(updatePromises);
                
                // Log the routing activity
                const userData = JSON.parse(localStorage.getItem('tesdaUser'));
                const logPromises = selectedMemoIds.map(memoId => {
                    return logMemoActivity(
                        memoId,
                        `Memo routed to archive`,
                        userData.username
                    );
                });
                await Promise.all(logPromises);

                showSuccessToast(`${selectedMemoIds.length} memo(s) routed to archive successfully`);
                
                // Uncheck all checkboxes
                const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                }
                
                // Clear individual checkboxes
                document.querySelectorAll('#memosTableBody .memo-checkbox:checked').forEach(checkbox => {
                    checkbox.checked = false;
                });

            } catch (error) {
                console.error('Error routing memos to archive:', error);
                errorMessage.textContent = 'Error routing memos to archive. Please try again.';
                errorMessage.classList.remove('hidden');
            } finally {
                loadingModal.classList.add('hidden');
            }
        };

        // Bulk delete selected memos and their activity logs
        window.bulkDeleteSelectedMemos = async function() {
            const selectedMemoIds = getSelectedMemoIds();
            
            if (selectedMemoIds.length === 0) {
                errorMessage.textContent = 'Please select at least one memo to delete';
                errorMessage.classList.remove('hidden');
                return;
            }

            // Show confirmation dialog
            const confirmed = confirm(`Are you sure you want to permanently delete ${selectedMemoIds.length} memo(s) and all their activity logs? This action cannot be undone.`);
            
            if (!confirmed) {
                return;
            }

            try {
                loadingModal.classList.remove('hidden');
                errorMessage.classList.add('hidden');

                // Delete all selected memos and their activity logs
                const deletePromises = selectedMemoIds.map(memoId => 
                    deleteMemoFromFirestore(memoId)
                );

                await Promise.all(deletePromises);

                showSuccessToast(`${selectedMemoIds.length} memo(s) and their activity logs deleted successfully`);
                
                // Uncheck all checkboxes
                const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                }
                
                // Clear individual checkboxes
                document.querySelectorAll('#memosTableBody .memo-checkbox:checked').forEach(checkbox => {
                    checkbox.checked = false;
                });

            } catch (error) {
                console.error('Error bulk deleting memos:', error);
                errorMessage.textContent = 'Error deleting memos. Please try again.';
                errorMessage.classList.remove('hidden');
            } finally {
                loadingModal.classList.add('hidden');
            }
        };

        // Replace the static table header with a dynamic one
        // Find the table header and tbody
        const table = document.querySelector('table.min-w-full');
        const thead = table.querySelector('thead');
        const tbody = document.getElementById('memosTableBody');

        function renderTableHeader(mode) {
            const thead = document.getElementById('memosTableHead');
            let headerHtml = `<tr>`;
            if (currentView === 'archive' && mode === 'folder') {
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-lg font-bold text-gray-700 uppercase tracking-wider">Folder</th>`;
                headerHtml += `</tr>`;
                thead.innerHTML = headerHtml;
                return;
            }
            // Use normal columns for current month (with Actions)
            if (currentView === 'archive' && mode === 'normal') {
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">Memo No.</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider subject-col compressed-subject">Subject</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">From</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider recipients-col">Recipients</th>`;
                // REMOVE STATUS COLUMN FOR ARCHIVE
                // headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">Status</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider w-48">Created At</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider rod-fasd-col w-48">Released to</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider rod-fasd-col">Received by (Date + Name)</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">Actions</th>`;
                headerHtml += `</tr>`;
                thead.innerHTML = headerHtml;
                return;
            }
            // For folder entries, show Action Taken
            if (currentView === 'archive' && mode === 'folder-entries') {
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">Memo No.</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider subject-col compressed-subject">Subject</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">From</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider recipients-col">Recipients</th>`;
                // REMOVE STATUS COLUMN FOR ARCHIVE
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider w-48">Created At</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider rod-fasd-col w-48">Released to</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider rod-fasd-col">Received by (Date + Name)</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">Action Taken</th>`;
                headerHtml += `</tr>`;
                thead.innerHTML = headerHtml;
                return;
            }
            if (currentView === 'pending') {
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">Memo No.</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider subject-col compressed-subject">Subject</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">From</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider recipients-col">Recipients</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">Status</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider w-48">Created At</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider rod-fasd-col w-48">Released to</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider rod-fasd-col">Received by (Date + Name)</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">Actions</th>`;
            } else if (!isActionMode && currentView === 'approved') {
                headerHtml += `<th scope="col" class="px-2 py-2 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">
                    <input type="checkbox" id="memoHeaderCheckbox" class="mr-2 align-middle">
                    <span id="memoNoHeader" class="inline-block align-middle text-blue-700 font-semibold opacity-50 pointer-events-none">Memo No.</span>
                </th>`;
                headerHtml += `<th scope="col" class="px-2 py-2 text-left text-sm font-medium text-gray-500 uppercase tracking-wider subject-col compressed-subject">Subject</th>`;
                headerHtml += `<th scope="col" class="px-2 py-2 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">From</th>`;
                headerHtml += `<th scope="col" class="px-2 py-2 text-left text-sm font-medium text-gray-500 uppercase tracking-wider recipients-col">Recipients</th>`;
                headerHtml += `<th scope="col" class="px-2 py-2 text-left text-sm font-medium text-gray-500 uppercase tracking-wider w-48">Created At</th>`;
                headerHtml += `<th scope="col" class="px-2 py-2 text-left text-sm font-medium text-gray-500 uppercase tracking-wider rod-fasd-col w-48">Released to</th>`;
                headerHtml += `<th scope="col" class="px-2 py-2 text-left text-sm font-medium text-gray-500 uppercase tracking-wider rod-fasd-col">Received by (Date + Name)</th>`;
                headerHtml += `<th scope="col" class="px-4 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">Action Taken</th>`;
            } else if (currentView === 'cancelled') {
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">Memo No.</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider subject-col compressed-subject">Subject</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">From</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider recipients-col">Recipients</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider w-48">Created At</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider rod-fasd-col w-48">Released to</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider rod-fasd-col">Received by (Date + Name)</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">Actions</th>`;
            } else {
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">Memo No.</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider subject-col compressed-subject">Subject</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">From</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider recipients-col">Recipients</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider w-48">Created At</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider rod-fasd-col w-48">Released to</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider rod-fasd-col">Received by (Date + Name)</th>`;
                headerHtml += `<th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">${isActionMode ? 'Actions' : 'Action Taken'}</th>`;
            }
            thead.innerHTML = headerHtml;
        }

        // Call renderTableHeader whenever the table needs to update
        // ... existing code ...

        // ... inside <script type="module">, after let currentView = 'all'; ...
        let currentArchiveType = 'All'; // Default archive type tab
        const archiveTypeTabs = document.getElementById('archiveTypeTabs');

        // Helper: filter archived memos by type and sort by document type order
        const DOC_TYPE_ORDER = [
            'CO',
            'PO',
            'Office Order',
            'Advisory',
            'Bulletin',
            'Acknowledgment'
        ];

        function filterArchivedMemosByType(type) {
            let filtered = allMemos.filter(memo => isMemoArchived(memo));
            if (type !== 'All') {
                // Ensure strict and case-sensitive comparison
                filtered = filtered.filter(memo => memo.memoType === type);
            }
            // Sort by receivedByRodFasd descending
            filtered.sort((a, b) => {
                const dateA = a.receivedByRodFasd && a.receivedByRodFasd.toDate ? a.receivedByRodFasd.toDate() : new Date(0);
                const dateB = b.receivedByRodFasd && b.receivedByRodFasd.toDate ? b.receivedByRodFasd.toDate() : new Date(0);
                return dateB - dateA;
            });
            return filtered;
        }

        // Tab switching for archive type tabs
        function setActiveArchiveTypeTab(type) {
            currentArchiveType = type;
            // Only one tab active
            document.querySelectorAll('.archive-type-tab').forEach(tab => {
                tab.classList.remove('archive-tab-active');
                if (tab.getAttribute('data-type') === type) {
                    tab.classList.add('archive-tab-active');
                }
            });
            // Direct tab switch without animation
            renderTableHeader();
            const filteredMemos = filterArchivedMemosByType(type);
            renderMemos(filteredMemos);
        }

        // Add event listeners to archive type tabs
        if (archiveTypeTabs) {
            archiveTypeTabs.querySelectorAll('.archive-type-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    setActiveArchiveTypeTab(this.getAttribute('data-type'));
                });
            });
        }

        // Show/hide archive type tabs on Archive tab click
        archiveMemosTab.addEventListener('click', () => {
            currentView = 'archive';
            updateTabStyles();
            if (archiveTypeTabs) archiveTypeTabs.classList.remove('hidden');
            setActiveArchiveTypeTab('All'); // Default to All
        });

        // Hide archive type tabs on other main tab clicks
        pendingMemosTab.addEventListener('click', () => {
            if (archiveTypeTabs) archiveTypeTabs.classList.add('hidden');
        });
        approvedMemosTab.addEventListener('click', () => {
            if (archiveTypeTabs) archiveTypeTabs.classList.add('hidden');
        });
        cancelledMemosTab.addEventListener('click', () => {
            if (archiveTypeTabs) archiveTypeTabs.classList.add('hidden');
        });

        // Responsive: stack archive type tabs on mobile
        if (archiveTypeTabs) {
            archiveTypeTabs.classList.add('flex-wrap');
            archiveTypeTabs.classList.add('sm:flex-row', 'flex-col');
        }

        // Copy archive data function
        window.copyArchiveData = function() {
            try {
                // Get only the visible table rows (what's currently displayed in the table)
                const visibleRows = Array.from(memosTableBody.querySelectorAll('tr')).filter(row => !row.classList.contains('hidden'));
                
                if (visibleRows.length === 0) {
                    showSuccessToast('No data to copy');
                    return;
                }

                // Create TSV-like data without headers (only the actual data rows)
                const tsvData = [];
                
                visibleRows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length > 0) {
                        // Get the full memo number from the original data instead of displayed text
                        const memoId = row.querySelector('.action-buttons')?.id?.split('_')[1] || 
                                      row.querySelector('.action-taken')?.id?.split('_')[1];
                        const memo = allMemos.find(m => m.id === memoId);
                        const memoNumber = memo ? formatMemoNumberForDisplay(memo.memoNumber, memo.isAntedated) : cells[0]?.textContent?.trim() || '';
                        
                        const subject = cells[1]?.textContent?.trim() || '';
                        const department = cells[2]?.textContent?.trim() || '';
                        const recipients = cells[3]?.textContent?.trim() || '';
                        const status = cells[4]?.textContent?.trim() || '';
                        const createdAt = cells[5]?.textContent?.trim() || '';
                        const releasedTo = cells[6]?.textContent?.trim() || '';
                        const receivedBy = cells[7]?.textContent?.trim() || '';
                        // Skip the last column (action buttons) - only copy data columns
                        
                        const rowData = [
                            memoNumber,
                            subject,
                            department,
                            recipients,
                            status,
                            createdAt,
                            releasedTo,
                            receivedBy
                        ];
                        tsvData.push(rowData.join('\t'));
                    }
                });

                const dataToCopy = tsvData.join('\n');
                navigator.clipboard.writeText(dataToCopy).then(() => {
                    showSuccessToast(`${visibleRows.length} memo(s) copied to clipboard`);
                }).catch(() => {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = dataToCopy;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showSuccessToast(`${visibleRows.length} memo(s) copied to clipboard`);
                });
            } catch (error) {
                console.error('Error copying archive data:', error);
                errorMessage.textContent = 'Error copying data. Please try again.';
                errorMessage.classList.remove('hidden');
            }
        };

        // Export archive data function
        window.exportArchiveData = function() {
            try {
                const currentArchiveMemos = filterArchivedMemosByType(currentArchiveType);
                if (currentArchiveMemos.length === 0) {
                    showSuccessToast('No data to export');
                    return;
                }

                // Load the template file
                const templateUrl = './New Communications Template.xlsx';
                
                fetch(templateUrl)
                    .then(response => response.arrayBuffer())
                    .then(arrayBuffer => {
                        // Read the template workbook
                        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                        
                        // Map archive type to sheet name
                        let sheetName;
                        switch(currentArchiveType) {
                            case 'All':
                                sheetName = 'All Archive';
                                break;
                            case 'CO':
                                sheetName = 'Central Office';
                                break;
                            case 'PO':
                                sheetName = 'Provincial Office';
                                break;
                            case 'Office Order':
                                sheetName = 'Office Order';
                                break;
                            case 'Advisory':
                                sheetName = 'Advisory';
                                break;
                            case 'Bulletin':
                                sheetName = 'Bulletin';
                                break;
                            case 'Acknowledgment':
                                sheetName = 'Acknowledgment';
                                break;
                            default:
                                sheetName = workbook.SheetNames[0]; // Fallback to first sheet
                        }
                        
                        // Check if the sheet exists in the template
                        if (!workbook.SheetNames.includes(sheetName)) {
                            errorMessage.textContent = `Sheet "${sheetName}" not found in template. Available sheets: ${workbook.SheetNames.join(', ')}`;
                            errorMessage.classList.remove('hidden');
                            return;
                        }
                        
                        // Get the worksheet based on the active tab
                        const worksheet = workbook.Sheets[sheetName];
                        
                        // Prepare data starting from row 3 (index 2)
                        const startRow = 2; // 0-based index, so row 3 = index 2
                        
                        currentArchiveMemos.forEach((memo, index) => {
                            const rowIndex = startRow + index;
                            
                            // Insert data into the template
                            // Adjust column positions based on your template structure
                            const rowData = [
                                memo.memoNumber,
                                memo.title,
                                memo.department,
                                memo.recipients,
                                memo.status,
                                memo.createdAt ? memo.createdAt.toDate().toLocaleDateString() : '',
                                memo.releasedToRodFasd ? memo.releasedToRodFasd.toDate().toLocaleDateString() : '',
                                memo.receivedByRodFasd ? memo.receivedByRodFasd.toDate().toLocaleDateString() : '',
                                memo.actionTaken || ''
                            ];
                            
                            // Insert each cell in the row while preserving existing formatting
                            rowData.forEach((value, colIndex) => {
                                const cellAddress = XLSX.utils.encode_cell({ r: rowIndex, c: colIndex });
                                
                                // Check if cell already exists to preserve formatting
                                if (worksheet[cellAddress]) {
                                    // Preserve existing cell properties and only update the value
                                    worksheet[cellAddress].v = value;
                                } else {
                                    // Create new cell with value only
                                    worksheet[cellAddress] = { v: value };
                                }
                            });
                        });
                        
                        // Generate XLSX file with template
                        const currentDate = new Date().toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                        }).replace(/\//g, '-');
                        
                        const archiveTypeName = currentArchiveType === 'All' ? 'All_Archive' : currentArchiveType.replace(/\s+/g, '_');
                        const fileName = `TESDA_Region_VII_${archiveTypeName}_${currentDate}.xlsx`;
                        XLSX.writeFile(workbook, fileName);
                        
                        showSuccessToast(`${currentArchiveMemos.length} memo(s) exported to ${sheetName} sheet successfully`);
                    })
                    .catch(error => {
                        console.error('Error loading template:', error);
                        errorMessage.textContent = 'Error loading template file. Please ensure "New Communications Template.xlsx" exists in the same directory.';
                        errorMessage.classList.remove('hidden');
                    });
                    
            } catch (error) {
                console.error('Error exporting archive data:', error);
                errorMessage.textContent = 'Error exporting data. Please try again.';
                errorMessage.classList.remove('hidden');
            }
        };

        async function getMemosByType(memoType) {
          const memosQuery = query(
            collection(db, "memos"),
            where("memoType", "==", memoType)
          );
          const querySnapshot = await getDocs(memosQuery);
          const memos = [];
          querySnapshot.forEach((doc) => {
            memos.push({ id: doc.id, ...doc.data() });
          });
          return memos;
        }

        // Helper function to break a string every n characters
        function breakLineEveryNChars(str, n) {
            if (!str) return '';
            let result = '';
            for (let i = 0; i < str.length; i += n) {
                result += str.substring(i, i + n) + (i + n < str.length ? '<br>' : '');
            }
            return result;
        }

        // Add after let currentArchiveType = 'All';
        let archiveCurrentPage = 1;
        const archiveRowsPerPage = 50;
        let archiveTotalPages = 1;

        // Pagination rendering function
        function renderArchivePagination(totalRows) {
            const paginationDiv = document.getElementById('archivePagination');
            if (!paginationDiv) return;
            // Only show if more than 1 page
            archiveTotalPages = Math.ceil(totalRows / archiveRowsPerPage);
            if (archiveTotalPages <= 1) {
                paginationDiv.innerHTML = '';
                return;
            }
            let html = '<nav class="inline-flex rounded-md shadow-sm" aria-label="Pagination">';
            // Previous button
            html += `<button class="px-3 py-1 mx-1 rounded-l-md border border-gray-300 bg-white text-gray-700 hover:bg-blue-50 transition disabled:opacity-50" ${archiveCurrentPage === 1 ? 'disabled' : ''} data-page="prev">Previous</button>`;
            // Page numbers (show up to 5, with ellipsis)
            let start = Math.max(1, archiveCurrentPage - 2);
            let end = Math.min(archiveTotalPages, archiveCurrentPage + 2);
            if (archiveCurrentPage <= 3) { end = Math.min(5, archiveTotalPages); }
            if (archiveCurrentPage >= archiveTotalPages - 2) { start = Math.max(1, archiveTotalPages - 4); }
            if (start > 1) html += `<span class='px-2 py-1'>...</span>`;
            for (let i = start; i <= end; i++) {
                html += `<button class="px-3 py-1 mx-1 rounded border border-gray-300 ${i === archiveCurrentPage ? 'bg-blue-600 text-white font-bold' : 'bg-white text-gray-700 hover:bg-blue-50'} transition" data-page="${i}">${i}</button>`;
            }
            if (end < archiveTotalPages) html += `<span class='px-2 py-1'>...</span>`;
            // Next button
            html += `<button class="px-3 py-1 mx-1 rounded-r-md border border-gray-300 bg-white text-gray-700 hover:bg-blue-50 transition disabled:opacity-50" ${archiveCurrentPage === archiveTotalPages ? 'disabled' : ''} data-page="next">Next</button>`;
            html += '</nav>';
            paginationDiv.innerHTML = html;
            // Add event listeners
            Array.from(paginationDiv.querySelectorAll('button[data-page]')).forEach(btn => {
                btn.onclick = function() {
                    let page = this.getAttribute('data-page');
                    if (page === 'prev') page = archiveCurrentPage - 1;
                    else if (page === 'next') page = archiveCurrentPage + 1;
                    else page = parseInt(page);
                    if (page < 1 || page > archiveTotalPages || page === archiveCurrentPage) return;
                    archiveCurrentPage = page;
                    // Re-render memos for this page
                    const filteredMemos = filterArchivedMemosByType(currentArchiveType);
                    renderMemos(filteredMemos);
                };
            });
        }

        // Patch renderMemos for Archive tab to paginate
        const originalRenderMemos = renderMemos;
        renderMemos = function(memos) {
            if (currentView === 'archive') {
                // Pagination logic
                const totalRows = memos.length;
                archiveTotalPages = Math.ceil(totalRows / archiveRowsPerPage);
                if (archiveCurrentPage > archiveTotalPages) archiveCurrentPage = 1;
                const startIdx = (archiveCurrentPage - 1) * archiveRowsPerPage;
                const endIdx = startIdx + archiveRowsPerPage;
                const pagedMemos = memos.slice(startIdx, endIdx);
                // Call original logic but only with pagedMemos
                // (copy the archive tab rendering logic here, or call a helper)
                renderTableHeader();
                memosTableBody.innerHTML = '';
                const memosCardBody = document.getElementById('memosCardBody');
                if (memosCardBody) memosCardBody.innerHTML = '';
                pagedMemos.forEach(memo => {
                    // ... (copy the archive tab row rendering logic from original renderMemos) ...
                    const row = document.createElement('tr');
                    row.className = 'bg-white';
                    row.innerHTML = `
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900">${formatMemoNumberForDisplay(memo.memoNumber, memo.isAntedated)}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 compressed-subject">${memo.title}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900">${memo.department}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 recipients-col">${memo.recipients}</td>
                        <td class="px-6 py-3 text-sm text-gray-900 w-48">
                            ${memo.createdAt && memo.createdAt.toDate ? memo.createdAt.toDate().toLocaleDateString('en-US', {
                                year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true
                            }) : 'N/A'}
                        </td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 rod-fasd-col w-48">
                            ${memo.releasedToRodFasd && memo.releasedToRodFasd.toDate ? memo.releasedToRodFasd.toDate().toLocaleDateString('en-US', {
                                year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true
                            }) : ''}
                        </td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 rod-fasd-col">
                            ${memo.receivedByRodFasd && memo.receivedByRodFasd.toDate ? breakLineEveryNChars(memo.receivedByRodFasd.toDate().toLocaleDateString('en-US', {
                                year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true
                            }) + (memo.receivedByName ? ` (${memo.receivedByName})` : ''), 40) : ''}
                        </td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">
                            <div class="flex space-x-4">
                                <div id="actionButtons_${memo.id}" class="action-buttons">
                                    <button onclick="viewMemo('${memo.id}')" class="text-blue-600 hover:text-blue-900">View</button>
                                    <button onclick="changeStatus('${memo.id}', '${memo.status}')" class="text-green-600 hover:text-green-900">Status</button>
                                    <button onclick="deleteMemo('${memo.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                                </div>
                            </div>
                        </td>
                    `;
                    memosTableBody.appendChild(row);
                    // Mobile card
                    if (memosCardBody) {
                        const card = document.createElement('div');
                        card.className = 'bg-white shadow-md rounded-lg p-4 mb-4';
                        card.innerHTML = `
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs font-bold text-gray-500 uppercase">Memo No.:</span>
                                <span class="text-sm font-semibold text-gray-900">${formatMemoNumberForDisplay(memo.memoNumber, memo.isAntedated)}</span>
                            </div>
                            <div class="mb-1">
                                <span class="block text-xs font-bold text-gray-500 uppercase">Subject:</span>
                                <span class="block text-sm text-gray-900">${memo.title}</span>
                            </div>
                            <div class="mb-1">
                                <span class="block text-xs font-bold text-gray-500 uppercase">From:</span>
                                <span class="block text-sm text-gray-900">${memo.department}</span>
                            </div>
                            <div class="mb-1">
                                <span class="block text-xs font-bold text-gray-500 uppercase">Recipients:</span>
                                <span class="block text-sm text-gray-900">${memo.recipients}</span>
                            </div>
                            <div class="mb-1">
                                <span class="block text-xs font-bold text-gray-500 uppercase">Status:</span>
                                <span class="inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(memo.status)} px-2 py-1">${memo.status}</span>
                            </div>
                            <div class="mb-1">
                                <span class="block text-xs font-bold text-gray-500 uppercase">Created At:</span>
                                <span class="block text-sm text-gray-900">${memo.createdAt && memo.createdAt.toDate ? memo.createdAt.toDate().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true }) : 'N/A'}</span>
                            </div>
                            <div class="mb-1">
                                <span class="block text-xs font-bold text-gray-500 uppercase">Released to:</span>
                                <span class="block text-sm text-gray-900">${memo.releasedToRodFasd && memo.releasedToRodFasd.toDate ? memo.releasedToRodFasd.toDate().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true }) : ''}</span>
                            </div>
                            <div class="mb-1">
                                <span class="block text-xs font-bold text-gray-500 uppercase">Received by (Date + Name):</span>
                                <span class="block text-sm text-gray-900">${memo.receivedByRodFasd && memo.receivedByRodFasd.toDate ? breakLineEveryNChars(memo.receivedByRodFasd.toDate().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true }) + (memo.receivedByName ? ` (${memo.receivedByName})` : ''), 40) : ''}</span>
                            </div>
                            <div class="flex space-x-2 mt-2">
                                <button onclick="viewMemo('${memo.id}')" class="text-blue-600 hover:text-blue-900 font-medium">View</button>
                                <button onclick="changeStatus('${memo.id}', '${memo.status}')" class="text-green-600 hover:text-green-900 font-medium">Status</button>
                                <button onclick="deleteMemo('${memo.id}')" class="text-red-600 hover:text-red-900 font-medium">Delete</button>
                            </div>
                        `;
                        memosCardBody.appendChild(card);
                    }
                });
                renderArchivePagination(totalRows);
                return;
            }
            // Fallback to original for other tabs
            originalRenderMemos.apply(this, arguments);
        };

        // Reset pagination when switching archive type or searching
        if (archiveTypeTabs) {
            archiveTypeTabs.querySelectorAll('.archive-type-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    archiveCurrentPage = 1;
                });
            });
        }
        searchInput.addEventListener('input', function() {
            if (currentView === 'archive') archiveCurrentPage = 1;
        });

        // Real-time listener for advisoryBulletin number
        const advisoryBulletinNumberEl = document.getElementById('nextAdvisoryBulletinNumber');
        const advisoryBulletinInput = document.getElementById('advisoryBulletinNumberInput');
        const advisoryBulletinEditDiv = document.getElementById('advisoryBulletinNumberEdit');

        onSnapshot(doc(db, "memoNumbers", "advisoryBulletin"), (docSnap) => {
            if (docSnap.exists()) {
                const number = docSnap.data().number || 0;
                if (advisoryBulletinNumberEl) {
                    advisoryBulletinNumberEl.textContent = String(number).padStart(4, '0');
                }
                if (advisoryBulletinInput && advisoryBulletinEditDiv.classList.contains('hidden')) {
                    advisoryBulletinInput.value = number;
                }
            }
        });
    </script>
    <script>
        // Modal logic for archive folder view
        const archiveFolderModal = document.getElementById('archiveFolderModal');
        const archiveFolderModalContent = document.getElementById('archiveFolderModalContent');
        const archiveFolderModalBody = document.getElementById('archiveFolderModalBody');
        const closeArchiveFolderModal = document.getElementById('closeArchiveFolderModal');

        function openArchiveFolderModal(label, memos) {
            // Build modal content
            let html = `<div class='text-xl font-bold mb-2 text-center'>${label}</div>`;
            if (memos.length === 0) {
                html += `<div class='text-center text-gray-500'>No memos in this folder.</div>`;
            } else {
                html += `<div class='overflow-x-auto'><table class='min-w-full divide-y divide-gray-200 mt-2'>`;
                html += `<thead><tr>
                    <th class='px-4 py-2 text-left text-xs font-semibold text-gray-600'>Memo No.</th>
                    <th class='px-4 py-2 text-left text-xs font-semibold text-gray-600'>Subject</th>
                    <th class='px-4 py-2 text-left text-xs font-semibold text-gray-600'>From</th>
                    <th class='px-4 py-2 text-left text-xs font-semibold text-gray-600'>Recipients</th>
                    <th class='px-4 py-2 text-left text-xs font-semibold text-gray-600'>Created At</th>
                    <th class='px-4 py-2 text-left text-xs font-semibold text-gray-600'>Released to</th>
                    <th class='px-4 py-2 text-left text-xs font-semibold text-gray-600'>Received by (Date + Name)</th>
                </tr></thead><tbody>`;
                memos.forEach(memo => {
                    html += `<tr>
                        <td class='px-4 py-2 text-sm text-gray-900'>${memo.memoNumber ? memo.memoNumber.split('-').pop() : ''}</td>
                        <td class='px-4 py-2 text-sm text-gray-900'>${memo.title || ''}</td>
                        <td class='px-4 py-2 text-sm text-gray-900'>${memo.department || ''}</td>
                        <td class='px-4 py-2 text-sm text-gray-900'>${memo.recipients || ''}</td>
                        <td class='px-4 py-2 text-sm text-gray-900'>${memo.createdAt || ''}</td>
                        <td class='px-4 py-2 text-sm text-gray-900'>${memo.releasedToRodFasd || ''}</td>
                        <td class='px-4 py-2 text-sm text-gray-900'>${memo.receivedByRodFasd || ''}</td>
                    </tr>`;
                });
                html += `</tbody></table></div>`;
            }
            archiveFolderModalBody.innerHTML = html;
            archiveFolderModal.classList.remove('hidden');
            setTimeout(() => {
                archiveFolderModalContent.classList.remove('opacity-0', 'scale-95');
                archiveFolderModalContent.classList.add('opacity-100', 'scale-100');
            }, 10);
        }
        function closeArchiveFolderModalFn() {
            archiveFolderModalContent.classList.remove('opacity-100', 'scale-100');
            archiveFolderModalContent.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                archiveFolderModal.classList.add('hidden');
            }, 250);
        }
        closeArchiveFolderModal.onclick = closeArchiveFolderModalFn;
        archiveFolderModal.onclick = function(e) {
            if (e.target === archiveFolderModal) closeArchiveFolderModalFn();
        };
        // Delegate click for view-folder-btn
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('view-folder-btn')) {
                const label = e.target.getAttribute('data-label');
                let memos = [];
                try {
                    memos = JSON.parse(e.target.getAttribute('data-memos'));
                } catch {}
                openArchiveFolderModal(label, memos);
            }
        });
    </script>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 py-4 mt-8">
        <div class="max-w-8xl mx-auto px-6 sm:px-8 lg:px-10">
            <p class="text-center text-sm text-gray-500">
                © <span id="currentYear"></span> Developed by TESDA Region VII. All rights reserved. - ROD / ICT Unit
            </p>
        </div>
    </footer>

    <script>
        // Set current year in footer
        document.getElementById('currentYear').textContent = new Date().getFullYear();
    </script>
</body>
</html>